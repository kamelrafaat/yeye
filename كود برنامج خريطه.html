<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ§ÙƒØ³ÙŠ Ø§Ù„Ø°ÙƒÙŠ</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root {
            --primary-color: #00CED1;
            --secondary-color: #2E2E2E;
            --accent-color: #FFA500;
            --bg-color: #1A1A1A;
        }

        * {
            box-sizing: border-box;
            font-family: 'Tajawal', sans-serif;
            margin: 0;
            padding: 0;
        }

        html, body {
		 	  margin: 0 !important;
             padding: 0 !important;
           overflow: hidden;
             width: 100%;
           height: 100%;
        }

        body {
            background: var(--bg-color);
            color: #FFF;
			    position: fixed;
         top: 0;
          left: 0;
         right: 0;
         bottom: 0;
        }

        .control-panel {
            position: fixed;
            top: 0px;
            left: 0px;
            right: 0px;
            z-index: 1000;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
		    z-index: 1000 !important;
	        flex-direction: row;
            justify-content: space-between;
            align-items: flex-start;
        }

        .input-field {
		
            flex: 1 1 45%;
            margin: 5px;
            min-width: 300px;
		      background: rgba(255, 255, 255, 0.05) !important; /* Ø´ÙØ§ÙÙŠØ© 90% */

            border-radius: 8px;
            padding: 15px;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .input-field input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--primary-color);
            border-radius: 6px;
            background: transparent;
            color: #FFF;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }

        .input-field input:focus {
            border-color: var(--accent-color);
			
        }

        .action-buttons {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            gap: 15px;
            background: rgba(46, 46, 46, 0.9);
            padding: 15px;
            border-radius: 8px;
            backdrop-filter: blur(5px);
			z-index: 1000 !important;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            background: var(--primary-color);
            color: var(--secondary-color);
            min-width: 150px;
            font-size: 16px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 206, 209, 0.4);
        }

        #map {
            height: 100vh;
            width: 100%;
		    border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
        }

        .route-info {
            position: fixed;
            top: 120px;
            left: 20px;
            background: rgba(46, 46, 46, 0.9);
            padding: 20px;
            border-radius: 8px;
            z-index: 1000;
            max-width: 300px;
            backdrop-filter: blur(5px);
			    display: none !important; /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø³Ù… ØªÙ…Ø§Ù…Ù‹Ø§ */

        }

        .price-options {
            position: fixed;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: none;
            gap: 20px;
            padding: 20px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
		  background: rgba(10, 10, 10, 0.1) !important;

        }

        .price-option {
            padding: 20px 30px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
		      background: rgba(10, 10, 10, 0.1) !important;

            min-width: 180px;
			
        }
       @media (max-width: 768px) {
         .price-options {
        flex-direction: row; /* Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙŠ ØµÙ Ø£ÙÙ‚ÙŠ Ù…Ø¹ ØªÙ…Ø±ÙŠØ± */
        flex-wrap: nowrap;
        justify-content: flex-start;
        -webkit-overflow-scrolling: touch; /* ØªÙ…ÙƒÙŠÙ† Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø³Ù„Ø³ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù„ÙˆØ­ÙŠØ© */
    
		      background: rgba(10, 10, 10, 0.1) !important;
	      width: 90% !important;
        max-width: 320px !important;
        padding: 12px !important;
        bottom: 100px !important;
        gap: 10px !important;
	}
    
    .price-option {
        min-width: 1px;
        margin: 5px 2px;
     min-width: unset !important;
        width: 100% !important;
        padding: 12px 15px !important;
        font-size: 14px !important;
        margin: 0 !important;
		      background: rgba(10, 10, 10, 0.1) !important;
	  }
	  
    }
        .price-option:hover {
            transform: scale(1.05);
        }

        .price-option.selected {
    background: rgba(46, 46, 46, 0.7) !important; /* Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø´ÙØ§ÙÙŠØ© */
            color: var(--secondary-color);
            box-shadow: 0 4px 15px rgba(0, 206, 209, 0.4);
        
		}

        .booking-details {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -20%);
		      background: rgba(255, 255, 255, 0.05) !important; /* Ø´ÙØ§ÙÙŠØ© 90% */
            padding: 10px;
            border-radius: 8px;
            z-index: 2000;
            display: none;
            text-align: center;
            backdrop-filter: blur(15px);
            width: 100%;
            max-width: 90%;
			
        }
		.booking-details h2 {
        font-size: 1.1rem !important;
        margin-bottom: 5px !important;
    }

    .booking-details p {
        font-size: 0.75rem !important;
        margin: 3px 0 !important;
		  margin-bottom: 5px !important;
    padding: 0 !important;
    }

    .payment-options {
        gap: 5px !important;
        margin: 8px 0 !important;
    }

    .payment-option {
        padding: 6px 10px !important;
        font-size: 0.7rem !important;
    }


        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 3000;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--primary-color);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .current-location-btn {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            padding: 5px;
            font-size: 18px;
        }

        .map-select-btn {
            margin-top: 10px;
            width: 100%;
            padding: 8px;
            font-size: 14px;
        }

        .driver-info {
            position: fixed;
            top: auto !important;
		    bottom: 80px;
            left: 15px !important;
            right: auto !important;
            transform: none !important;
            background: rgba(46, 46, 46, 0.9);
			    /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø¬Ù… */
    width: 200px;
    max-height: 40vh;
    overflow: hidden;
            padding: 20px;
            border-radius: 8px;
            z-index: 1000;
            max-width: 300px;
            backdrop-filter: blur(5px);
            display: none;
		    stroke: #00FF00 !important;
            stroke-opacity: 0.8 !important;
            stroke-width: 6px !important;
            stroke-dasharray: none !important;
           animation: pulse 2s infinite;
		       /* ØªØµÙ…ÙŠÙ… Ø£ÙƒØ«Ø± Ø´ÙØ§ÙÙŠØ© */
    background: rgba(30, 30, 30, 0.92) !important;
    backdrop-filter: blur(8px);
    border: 1px solid rgba(255,255,255,0.1);
        }
        @keyframes pulse {
           0% { stroke-opacity: 0.8; }
           50% { stroke-opacity: 0.4; }
          100% { stroke-opacity: 0.8; }
        }
        .driver-route-line {
            stroke-color: #FF6B6B;
            stroke-opacity: 0.7;
            stroke-weight: 4;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #00CED1;
            color: #2E2E2E;
            padding: 15px 25px;
            border-radius: 8px;
            z-index: 5000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease-out;
            display: none;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
		.persistent-notification {
		    /* ØªØºÙŠÙŠØ± Ø§Ù„Ù…ÙˆØ¶Ø¹ Ø¥Ù„Ù‰ Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø³ÙÙ„ÙŠØ© Ø§Ù„ÙŠØ³Ø±Ù‰ */
    top: auto !important;
    bottom: 80px;
    left: 15px !important;
    right: auto !important;
    transform: none !important;
    
    /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø¬Ù… */
    width: 200px;
    max-height: 35vh;
    overflow: hidden;
    
    /* ØªØµÙ…ÙŠÙ… Ø£ÙƒØ«Ø± Ø´ÙØ§ÙÙŠØ© */
    background: rgba(1, 1, 1, 0.6) !important; /* Ø´ÙØ§ÙÙŠØ© Ø¹Ø§Ù„ÙŠØ© */
    border: 1px solid rgba(255,255,255,0.1);
        position: fixed;
        padding: 20px;
        border-radius: 8px;
        z-index: 1000;
        border: 2px solid var(--primary-color);
        display: none;
         color: #fff;
        top: 20px !important;
        max-width: 200px !important;
        }
		.persistent-notification h3 {
        color: #fff !important;
        margin-bottom: 15px;
        }

       .persistent-notification p {
          margin: 8px 0;
          font-size: 16px;  
        }
		.notification.success {
         background: #4CAF50;
         padding: 20px;
         font-size: 18px;
         display: flex;
         align-items: center;
         width: 350px;
         border-left: 5px solid #45a049;
        }

        .notification-content {
          display: flex;
          flex-direction: column;
          gap: 15px;
          width: 100%;
        }

        .confirm-btn {
          background: rgba(255, 255, 255, 0.9);
          color: #4CAF50;
          padding: 10px 25px;
          border-radius: 8px;
          font-weight: bold;
          transition: all 0.3s;
          align-self: flex-end;
        }

        .confirm-btn:hover {
           background: #fff;
           transform: translateY(-2px);
           box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
	    .end-notification {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(46, 46, 46, 0.95);
        padding: 40px 60px;
        border-radius: 15px;
        text-align: center;
        z-index: 10000;
        border: 3px solid #00CED1;
        box-shadow: 0 8px 30px rgba(0,0,0,0.5);
        color: #FFF;
        }

        .end-notification h2 {
        color: #00CED1;
        margin-bottom: 20px;
        font-size: 28px;
        }

        .end-notification .price {
        font-size: 24px;
        margin: 20px 0;
        }
		/* Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ media query Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
@media (max-width: 768px) {
    .profile-btn {
        position: fixed !important;
        bottom: 20px !important;
        left: 15px !important;
        right: auto !important;
        top: auto !important;
        transform: none !important;
        margin: 0 !important;
        z-index: 1001 !important;
        padding: 12px 20px !important;
        width: auto !important;
        background: var(--primary-color) !important;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3) !important;
    }

    .profile-btn .profile-text {
        font-size: 14px !important;
    }

    .profile-btn i {
        font-size: 14px !important;
        margin-right: 5px !important;
    }

    /* Ù…Ù†Ø¹ ØªØ¯Ø§Ø®Ù„ Ù…Ø¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø®Ø±Ù‰ */
    .action-buttons {
        left: 50% !important;
        transform: translateX(-50%) !important;
        width: 90% !important;
        bottom: 80px !important; /* Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¨Ø¹Ø¯ Ø¹Ù† Ø§Ù„Ø£Ø³ÙÙ„ */
    }
}
		@media (max-width: 768px) {
           .control-panel {
        flex-direction: row !important;
        flex-wrap: nowrap !important;
        gap: 0 !important;
        padding: 0 !important;
    }

.map-select-btn {
    margin-top: 8px;
    padding: 8px;
    font-size: 10px;
}
      /* ØªØ¹Ø¯ÙŠÙ„ Ø­Ù‚Ù„ÙŠ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
    .input-field {
	
        flex: 1 !important;
        min-width: 20% !important;
        margin: 0 !important;
        border-radius: 0 !important;
        padding: 3px !important;
    }
	

    
        .action-buttons {
          bottom: 20px;
          padding: 10px;
		  
		      background: rgba(255, 255, 255, 0.05) !important; /* Ø´ÙØ§ÙÙŠØ© 90% */
        }
    
        .btn {
          padding: 10px 20px;
          min-width: 120px;
		  
        }
    }
		
    .payment-options {
       display: flex;
      gap: 15px;
      margin: 20px 0;
      flex-direction: column;
    }

    .payment-option {
      padding: 15px;
     border-radius: 8px;
     cursor: pointer;
     transition: all 0.3s;
     background: rgba(255, 255, 255, 0.1);
     border: 2px solid transparent;
    }

    .payment-option.selected {
      background: var(--primary-color);
      color: var(--secondary-color);
      border-color: var(--accent-color);
    }

    .payment-option:hover {
      transform: scale(1.02);
    }
@media (max-width: 768px) {
    .driver-info, .persistent-notification {
        /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø¹Ø§Ù… */
        width: 60%;
        max-width: 150px;
        padding: 5px;
        
        /* ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø®Ø·ÙˆØ· */
        font-size: 0.6rem;
        
        /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù‡ÙˆØ§Ù…Ø´ */
        margin: 5px;
        top: 5px !important;
        
        /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± ØºÙŠØ± Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ© */
        .extra-details {
            display: none;
        }
    }
    
    /* Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
    .driver-info h3, .persistent-notification h3 {
        font-size: 1rem;
        margin-bottom: 8px;
    }
    
    /* Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù†ØµÙˆØµ */
    .driver-info p, .persistent-notification p {
        margin: 8px 0;
    }
    
    /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
    .close-btn, .toggle-info-btn {
        padding: 8px 12px;
        font-size: 0.85rem;
    }
    
    /* Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
    .toggle-info-btn i {
        font-size: 14px;
    }
}
    #confirmBookingButton {
      display: none;
      margin-top: 20px; 
    
    }
	.actual-route {
    stroke-color: #00CED1 !important;
    stroke-opacity: 0.8 !important;
    stroke-weight: 6 !important;
    stroke-dasharray: none !important;
     }
	
	/* ======= Ø²Ø± Ø§Ù„Ø¨Ø±ÙˆÙÙŠÙ„ ======= */
.profile-btn {
  /* Ø£Ø¶Ù Ø®Ù„ÙÙŠØ© Ø´ÙØ§ÙØ© Ø£Ùˆ Ù„ÙˆÙ† Ø«Ø§Ø¨Øª */
  background: var(--primary-color);      /* Ø£Ùˆ Ø£ÙŠ Ù„ÙˆÙ† ØªÙØ¶Ù„Ù‡ */
  border: 2px solid var(--accent-color); /* Ø³Ù…Ùƒ Ø§Ù„Ø¥Ø·Ø§Ø± ÙˆÙ„ÙˆÙ†Ù‡ */
  border-radius: 30px;                   /* Ù†ØµÙ Ù‚Ø·Ø± Ø§Ù„Ø§Ù†Ø­Ù†Ø§Ø¡ */
  padding: 12px 28px;                    /* Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ ÙˆØ§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ */
  font-size: 18px;                       /* Ø­Ø¬Ù… Ø§Ù„Ø®Ø· */
  color: var(--secondary-color);         /* Ù„ÙˆÙ† Ø§Ù„Ù†Øµ */
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.3s;
}
.profile-btn:hover {
  background: var(--accent-color);
  color: #FFF;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}
.profile-btn .fa-chevron-left {
  font-size: 16px;    /* Ø­Ø¬Ù… Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© */
  transition: transform 0.3s;
}
.profile-btn:hover .fa-chevron-left {
  transform: translateX(-4px);
}

.marker-label {
    background: rgba(0, 206, 209, 0.9);
    padding: 2px 8px;
    border-radius: 15px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
}
@media (max-width: 768px) {
    .booking-details p,
    .booking-details .vehicle-type,
    .booking-details .total-price {
        line-height: 0.7 !important;
        margin: 2px 0 !important;
    }
}

    </style>
</head>
<body>
     <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <div class="control-panel">
	<div class="control-panel">
    <div class="user-controls">
       <button class="profile-btn" onclick="window.location.href='profile.html'">
    <span class="profile-text">Ø§Ù„Ø¨Ø±ÙˆÙÙŠÙ„</span>
    <i class="fas fa-chevron-left"></i> <!-- Ø³Ù‡Ù… Ù„Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† -->
</button>
    </div>
        <div class="input-field">
            <div style="position: relative;">
                <input type="text" id="origin" placeholder="ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ">
                <button class="current-location-btn" onclick="getCurrentLocation()">ğŸ“</button>
            </div>
            <button class="btn map-select-btn" onclick="setSelectionMode('start')">Ø§Ø®ØªØ± Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>
        </div>
        <div class="input-field">
            <input type="text" id="destination" placeholder="ğŸ Ø§Ù„ÙˆØ¬Ù‡Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©">
            <button class="btn map-select-btn" onclick="setSelectionMode('end')">Ø§Ø®ØªØ± Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>
        </div>
    </div>

    <div class="action-buttons">
        <button class="btn" onclick="calculateRoute()">Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±</button>
        <button class="btn" onclick="clearAll()">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
	    <button class="btn" id="confirmRideBtn" style="display:none;" onclick="confirmRide()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±Ø­Ù„Ø©</button>

    </div>

    <div class="route-info" id="routeInfo"></div>
    <div class="price-options" id="priceOptions">
        <div class="price-option" onclick="selectVehicle('normal', 5)">
            <h3>ğŸš— Ø¹Ø§Ø¯ÙŠØ©</h3>
            <p>5 Ø¬Ù†ÙŠÙ‡/ÙƒÙ…</p>
        </div>
        <div class="price-option" onclick="selectVehicle('luxury', 10)">
            <h3>ğŸš• ÙØ§Ø®Ø±Ø©</h3>
            <p>10 Ø¬Ù†ÙŠÙ‡/ÙƒÙ…</p>
        </div>
        <div class="price-option" onclick="selectVehicle('helicopter', 3)">
            <h3>ğŸš Ø·Ø§Ø¦Ø±Ø©</h3>
            <p>3 Ø¬Ù†ÙŠÙ‡/ÙƒÙ…</p>
        </div>
    </div>

    <div id="map"></div>

    <div class="booking-details" id="bookingDetails">
        <h2 style="margin-bottom: 20px;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø©</h2>
        <div id="priceDisplay" style="font-size: 18px;"></div>
		    <div class="payment-options" id="paymentOptions">
        <div class="payment-option" onclick="selectPayment('electronic', event)">
            <h3>ğŸ’³ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø¹ Ø§Ù„ÙƒØ§Ø¨ØªÙ†</h3>
            <p>ØªØ£ÙƒÙŠØ¯ ÙÙˆØ±ÙŠ Ø¹Ø¨Ø± Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</p>
        </div>
        <div class="payment-option" onclick="selectPayment('cash', event)">
            <h3>ğŸ’µ Ø§Ù„Ø¯ÙØ¹ Ù†Ù‚Ø¯ÙŠ</h3>
            <p>Ø§Ù„Ø¯ÙØ¹ Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„Ø³Ø§Ø¦Ù‚ Ù†Ù‚Ø¯Ø§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„ÙˆØµÙˆÙ„</p>
        </div>
    </div>
  <button class="btn" id="confirmBookingButton" onclick="confirmTrip()" style="margin-top: 25px; width: 100%;">
    ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ø¢Ù†
  </button>
    </div>

    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
        <p style="margin-top: 20px; color: var(--primary-color);">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« ...</p>
    </div>

    <div class="driver-info" id="driverInfo">
        <h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚</h3>
        <p id="driverName">Ø§Ù„Ø§Ø³Ù…: -</p>
        <p id="driverCar">Ø§Ù„Ø³ÙŠØ§Ø±Ø©: -</p>
        <p id="driverPhone">Ø§Ù„Ù‡Ø§ØªÙ: -</p>
	</div>

<!-- Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ ØªØ­Øª Ø¹Ù†ØµØ± driver-info -->
    <div class="persistent-notification" id="persistentNotification">
      <h3>Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø­Ù„Ø©</h3>
      <div id="tripStatusContent"></div>
       <button class="btn" onclick="clearAll()" style="margin-top:15px;">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</button>
    </div>		
    <div id="arrivalNotification" class="notification" style="display: none;">
    <div class="notification-content">
        <span>ğŸ‰ ØªÙ… ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¥Ù„Ù‰ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©!</span>
	    <div id="driverArrivalInfo"></div>
        <button class="btn confirm-btn" onclick="handleArrivalConfirmation()">Ù…ÙˆØ§ÙÙ‚</button>
    </div>
	
    <audio id="notificationSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" loop></audio>
    </div>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAeQx0Ke798anRT_6xAwB-ViewDVb8Jq0U&libraries=places,geometry&callback=initMap" async defer></script>    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCAwPCVPaxoTEV4n4APATlIKh3ppjMeZpk",
            authDomain: "data-c4c20.firebaseapp.com",
            databaseURL: "https://data-c4c20-default-rtdb.firebaseio.com",
            projectId: "data-c4c20",
            storageBucket: "data-c4c20.firebasestorage.app",
            messagingSenderId: "905131784305",
            appId: "1:905131784305:web:440e06647294b0d5e543d0"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let map, directionsService, driverDirectionsRenderer, directionsRenderer;
        let startMarker, endMarker, currentLocationMarker, driverMarker;
        let selectedVehicle = null;
        let currentPricePerKm = 0;
        let totalDistance = 0;
        let selectionMode = null;
        let geocoder;
        let currentLocationCoords = null;
        let tripListener = null;
        let driverLocationListener = null;
        let driverRoutePolyline = null;
        let destinationMarker;
        let arrivalSound = null; // Ù…ØªØºÙŠØ± Ù„ØªØªØ¨Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„ØµÙˆØª
        let driverPathCoordinates = [];
        let driverPathPolyline = null;
		let currentTripId = localStorage.getItem('currentTripId') || null;
        let selectedPayment = null;
       let mapInitialized = false;
// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', () => {
            const isLoggedIn = localStorage.getItem('isLoggedIn');
          const userId = localStorage.getItem('userId');
    
             if (!isLoggedIn || !userId) {
              window.location.href = 'login.html';
             } else {
                  console.log('User ID on map page:', userId); // Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù‚ÙŠÙ…Ø©
            }
        });


	   function initMap() {

                    // Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø©
        const professionalMapStyle = [
        {
             "elementType": "geometry",
             "stylers": [{ "color": "#1d2c4d" }]
        },
        {
          "elementType": "labels.text.fill",
          "stylers": [{ "color": "#8ec3b9" }]
        },
        {
          "elementType": "labels.text.stroke",
          "stylers": [{ "color": "#1a3646" }]
        },
        {
          "featureType": "administrative",
          "elementType": "geometry",
          "stylers": [{ "visibility": "off" }]
        },
        {
           "featureType": "poi",
           "stylers": [{ "visibility": "off" }]
        },
        {
          "featureType": "road",
          "elementType": "geometry",
          "stylers": [
             { "color": "#304a7d" },
            { "weight": 1.6 }
          ]
        },
        {
          "featureType": "road",
          "elementType": "labels.icon",
          "stylers": [{ "visibility": "off" }]
        },
        {
          "featureType": "transit",
          "stylers": [{ "visibility": "off" }]
        },
        {
          "featureType": "water",
          "elementType": "geometry",
          "stylers": [{ "color": "#17263c" }]
        }
        ];
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± ØºÙŠØ± Ø§Ù„Ù…Ø±ØºÙˆØ¨Ø©
                     document.getElementById('routeInfo').style.display = 'none';

            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 30.0444, lng: 31.2357 },
                zoom: 15,
			    styles: professionalMapStyle,
                disableDefaultUI: true,
                mapTypeControlOptions: {
                mapTypeIds: [] // Ø¥Ø®ÙØ§Ø¡ Ø®ÙŠØ§Ø±Ø§Øª Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø®Ø±Ø§Ø¦Ø·
                },
                gestureHandling: "greedy"
            });

            geocoder = new google.maps.Geocoder();
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                suppressMarkers: true,
                polylineOptions: {
                    strokeColor: "#FF00FF",
                    strokeOpacity: 0.8,
                    strokeWeight: 5,
					zIndex: 999
                },
				    preserveViewport: false // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø¶Ø¨Ø· Ø§Ù„Ø®Ø±ÙŠØ·Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
            });
                driverDirectionsRenderer = new google.maps.DirectionsRenderer({
                suppressMarkers: true,
                polylineOptions: {
                 strokeColor: "#FFA500",
                  strokeOpacity: 0.8,
                  strokeWeight: 7
                }
               });
                
            // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ù…Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©
startMarker  = new google.maps.Marker({
    icon: {
        url: 'https://cdn-icons-png.flaticon.com/512/149/149068.png',
        scaledSize: new google.maps.Size(35, 35),
        anchor: new google.maps.Point(17, 35),
        labelOrigin: new google.maps.Point(20, -10)
    },
    label: {
        color: '#fff',
        fontSize: '59px',
        fontWeight: 'bold',
        className: 'marker-label'
    },
    zIndex: 999
});

            endMarker = new google.maps.Marker({
                icon: {
                    url: 'https://cdn-icons-png.flaticon.com/512/149/149060.png',
                    scaledSize: new google.maps.Size(40, 40)
                }
            });
			    mapInitialized = true;

			// ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø¯Ø§Ù„Ø© initMap Ø¨Ø¹Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
                const originInput = document.getElementById('origin') ;
                const destinationInput = document.getElementById('destination');

// ØªÙ‡ÙŠØ¦Ø© Ø®Ø¯Ù…Ø© Ø§Ù„Ù€ Autocomplete
                const autocompleteOptions = {
                      componentRestrictions: { country: "eg" }, // Ù…ØµØ±
                      fields: ["formatted_address", "geometry"],
                       types: ["geocode"]
                    };
                const trafficLayer = new google.maps.TrafficLayer();
                   trafficLayer.setMap(map);

// ØªØ­Ø¯ÙŠØ« ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©
                  setInterval(() => {
                  trafficLayer.setMap(null);
                  trafficLayer.setMap(map);
                }, 60000);
                    const originAutocomplete = new google.maps.places.Autocomplete(originInput, autocompleteOptions);
                    const destinationAutocomplete = new google.maps.places.Autocomplete(destinationInput, autocompleteOptions);

// Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
                    originAutocomplete.addListener('place_changed', () => {
                    const place = originAutocomplete.getPlace();
                    if (place.geometry) {
					        currentLocationCoords = null; // Reset current location if manual address selected
                    startMarker.setPosition(place.geometry.location);
                     startMarker.setMap(map);
                    map.panTo(place.geometry.location);
                    }
                   });

                  destinationAutocomplete.addListener('place_changed', () => {
                  const place = destinationAutocomplete.getPlace();
                  if (place.geometry) {
                  endMarker.setPosition(place.geometry.location);
                  endMarker.setMap(map);
                  map.panTo(place.geometry.location);
                }
                });
				map.addListener('click', (e) => {
                    if (selectionMode) {
                     handleMapClick(e.latLng);
                }
                });
				window.addEventListener('load', () => {
                   restorePreviousTrip();
                });
				// Ø¨Ø¹Ø¯ initMap()
                 if (currentTripId) { 
                setupTripListener();
                  restoreTripState();
                }
				 mapInitialized = true;
                 restorePreviousTrip();
                // Ø¨Ø¹Ø¯ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    drawTripHotspots();
    
    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„Ø±Ø­Ù„Ø§Øª
    database.ref('rides').on('value', () => {
        drawTripHotspots();
    });
}
			
			// ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ù…Ù„Ù Ø§Ù„Ø®Ø±ÙŠØ·Ø©

      function handleMapClick(latLng) {
    geocoder.geocode({ location: latLng }, (results, status) => {
        if (status === 'OK' && results[0]) { // ØªØºÙŠÙŠØ± 'ok' Ø¥Ù„Ù‰ 'OK'
            const address = results[0].formatted_address;
            
            if (selectionMode === 'start') {
                document.getElementById('origin').value = address;
                startMarker.setPosition(latLng);
                startMarker.setMap(map);
                startMarker.setVisible(true); // Ø¬Ø¹Ù„ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ù…Ø±Ø¦ÙŠØ©
                map.panTo(latLng);
            } else {
                document.getElementById('destination').value = address;
                endMarker.setPosition(latLng);
                endMarker.setMap(map);
                endMarker.setVisible(true); // Ø¬Ø¹Ù„ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ù…Ø±Ø¦ÙŠØ©
                map.panTo(latLng);
            }
            
            // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ù…Ø±Ø¦ÙŠ
            const tempCircle = new google.maps.Circle({
                strokeColor: '#FF0000',
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: '#FF0000',
                fillOpacity: 0.35,
                map: map,
                center: latLng,
                radius: 20,
                zIndex: 999
            });
            
            setTimeout(() => tempCircle.setMap(null), 500);
            
            selectionMode = null;
            showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­!', false);
        } else {
            showNotification('ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù†ÙˆØ§Ù† Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹', true);
        }
    });
}
		 function confirmRide() {
              document.getElementById('persistentNotification').style.display = 'none';
              clearAll();
              showNotification('ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±Ø­Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!');
         }
        function getCurrentLocation() {
    return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
            reject('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹');
            return;
        }

        showLoading(true);
        
        navigator.geolocation.getCurrentPosition(
            async (position) => {
                try {
                    currentLocationCoords = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹
                    startMarker.setPosition(currentLocationCoords);
                    startMarker.setMap(map);
                    map.panTo(currentLocationCoords);

                    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
                    const results = await new Promise((resolve, reject) => {
                        geocoder.geocode({ location: currentLocationCoords }, (results, status) => {
                            if (status === 'OK') resolve(results);
                            else reject(status);
                        });
                    });

                    document.getElementById('origin').value = results[0]?.formatted_address || "Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ";
                    resolve(currentLocationCoords);

                } catch (error) {
                    console.error('Geocoding error:', error);
                    document.getElementById('origin').value = "Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ";
                    showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ©', false);
                    resolve(currentLocationCoords);
                } finally {
                    showLoading(false);
                }
            },
            (error) => {
                showLoading(false);
                handleGeolocationError(error);
                reject(error);
            },
            {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            }
        );
    });
}

        function setSelectionMode(mode) {
            selectionMode = mode;
            showNotification(`Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ù†Ù‚Ø·Ø© ${mode === 'start' ? 'Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©' : 'Ø§Ù„Ù†Ù‡Ø§ÙŠØ©'}`);
        }

        async function calculateRoute() {
		 document.querySelector('.profile-btn').style.display = 'none';

    let origin = document.getElementById('origin').value;
    const destination = document.getElementById('destination').value;

    if ((!origin && !currentLocationCoords) || !destination) {
        showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ù†Ù‚Ø·ØªÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©', true);
        return;
    }

    showLoading(true);

    try {
        let originLocation;
        
        // ØªØ­Ø¯ÙŠØ¯ Ù…ØµØ¯Ø± Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª
        if (currentLocationCoords) {
            originLocation = new google.maps.LatLng(
                currentLocationCoords.lat,
                currentLocationCoords.lng
            );
        } else {
            // Ø¬ÙŠÙˆÙƒÙˆØ¯ Ù„Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙŠØ¯ÙˆÙŠ
            const geocodeResult = await new Promise((resolve, reject) => {
                geocoder.geocode({ address: origin }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        resolve(results[0].geometry.location);
                    } else {
                        reject('ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©');
                    }
                });
            });
            originLocation = geocodeResult;
        }

        // Ø¬ÙŠÙˆÙƒÙˆØ¯ Ù„Ù„Ù†Ù‡Ø§ÙŠØ©
        const destinationResult = await new Promise((resolve, reject) => {
            geocoder.geocode({ address: destination }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    resolve(results[0].geometry.location);
                } else {
                    reject('ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©');
                }
            });
        });

        const request = {
            origin: originLocation,
            destination: destinationResult,
            travelMode: 'DRIVING'
        };

        const response = await directionsService.route(request);
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        directionsRenderer.setMap(map);
        directionsRenderer.setDirections(response);
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© ÙˆØ§Ù„Ø³Ø¹Ø±
        const route = response.routes[0].legs[0];
        totalDistance = route.distance.value / 1000;
        
        // Ø¹Ø±Ø¶ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø³Ø¹Ø±
        document.getElementById('priceOptions').style.display = 'flex';
        document.querySelectorAll('.input-field').forEach(field => {
            field.style.display = 'none';
        });

        // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        map.fitBounds(response.routes[0].bounds);
        startMarker.setPosition(originLocation);
        endMarker.setPosition(destinationResult);

    } catch (error) {
        console.error('Error:', error);
        showNotification('ÙØ´Ù„ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§Ø±: ' + error.message, true);
    } finally {
        showLoading(false);
    }
}

        function selectVehicle(type, price) {
            selectedVehicle = type;
            currentPricePerKm = price;
            
            document.querySelectorAll('.price-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            showBookingDetails();
        }

        function showBookingDetails() {
            const totalPrice = (totalDistance * currentPricePerKm).toFixed(2);
            document.getElementById('priceDisplay').innerHTML = `
                <p>Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©: <strong>${getVehicleName(selectedVehicle)}</strong></p>
                <h3 style="color: var(--primary-color); margin: 20px 0;">
                    Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${totalPrice} Ø¬Ù†ÙŠÙ‡
                </h3>
            `;
              document.getElementById('bookingDetails').style.display = 'block';
              document.getElementById('priceOptions').style.display = 'none';
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¯ÙØ¹
             document.querySelectorAll('.payment-option').forEach(option => {
             option.classList.remove('selected');
          });
          document.getElementById('confirmBookingButton').style.display = 'none';
          selectedPayment = null;
		       document.querySelector('.profile-btn').style.display = 'none';
		}

        async function confirmTrip() {
		
            if (!selectedVehicle) {
                showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹', true);
                return;
            }
		    if (!selectedPayment) {
               showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹', true);
              return;
            }
            const userId = localStorage.getItem('userId');
               if (!userId) {
                  alert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
                 window.location.href = 'login.html';
            }

            showLoading(true);
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù‡Ù†Ø§
		     document.querySelector('.profile-btn').style.display = 'none';
              document.querySelector('.action-buttons').style.display = 'none';
			  document.getElementById('map').style.display = 'block'; // Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±
			  document.querySelector('.input-field').style.display = 'none';
             document.getElementById('origin').parentNode.style.display = 'none';
             document.getElementById('destination').parentNode.style.display = 'none';
                   document.getElementById('persistentNotification').style.display = 'block';
            const tripData = {
                start: document.getElementById('origin').value,
			    userId: userId, // ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ù†Ø§
                end: document.getElementById('destination').value,
                vehicleType: selectedVehicle,
                price: (totalDistance * currentPricePerKm).toFixed(2),
                distance: totalDistance,
                status: "new",
    	        paymentMethod: selectedPayment, // Ø¥Ø¶Ø§ÙØ© Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹
                startLocation: startMarker.getPosition().toJSON(),
				endLocation: endMarker.getPosition().toJSON(), // Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            try {
                let newTripRef = database.ref(`rides/${userId}`).push();
                await newTripRef.set(tripData);
                currentTripId = newTripRef.key;
                localStorage.setItem('currentTripId', currentTripId); // Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù‡Ù†Ø§

                setupTripListener();
                showNotification('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚...');
                 document.querySelector('.profile-btn').style.display = 'none';
                document.getElementById('bookingDetails').style.display = 'none';

            } catch (error) {
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±Ø­Ù„Ø©', true);
                console.error('Error confirming trip:', error);
            } finally {
                showLoading(false);
            }
        }

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø­ Ø§Ù„Ø¹Ù†Ø§ØµØ±
function clearMapElements() {
    if (directionsRenderer) directionsRenderer.setMap(null);
    if (driverDirectionsRenderer) driverDirectionsRenderer.setMap(null);
    if (startMarker) startMarker.setMap(null);
    if (endMarker) endMarker.setMap(null);
    if (driverMarker) driverMarker.setMap(null);
    if (driverRoutePolyline) driverRoutePolyline.setMap(null);
}
// Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ù…Ù„Ù script Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
let wakeLock = null;

// Ø¯Ø§Ù„Ø© Ù„ØªÙØ¹ÙŠÙ„ Ù…Ù†Ø¹ Ù‚ÙÙ„ Ø§Ù„Ø´Ø§Ø´Ø©
async function enableWakeLock() {
    try {
        if ('wakeLock' in navigator) {
            wakeLock = await navigator.wakeLock.request('screen');
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„
            document.addEventListener('visibilitychange', async () => {
                if (wakeLock !== null && document.visibilityState === 'visible') {
                    await enableWakeLock();
                }
            });
            
            console.log('Screen Wake Lock activated!');
        }
    } catch (err) {
        console.error('Error enabling wake lock:', err);
    }
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ù†Ø¹ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
window.addEventListener('load', () => {
    enableWakeLock();
    
    // ØªÙØ¹ÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠ Ø¹Ù†Ø¯ Ø£ÙŠ ØªÙØ§Ø¹Ù„ Ù…Ø³ØªØ®Ø¯Ù…
    document.addEventListener('click', enableWakeLock);
    document.addEventListener('touchstart', enableWakeLock);
    document.addEventListener('keydown', enableWakeWakeLock);
});

// Optional: Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ù†Ø¹ Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©
window.addEventListener('beforeunload', () => {
    if (wakeLock) {
        wakeLock.release();
        wakeLock = null;
    }
});
        function setupTripListener() {
          const userId = localStorage.getItem('userId');
          const tripRef = database.ref(`rides/${userId}/${currentTripId}`);       
             tripListener = tripRef.on('value', async (snapshot) => {
             const tripData = snapshot.val();
			  // Ø¥Ø°Ø§ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø­Ù„Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
               if (!tripData) {
                 localStorage.removeItem('currentTripId');
                 currentTripId = null;
                 clearAll();
                 return;
                }
				
				
             if (!tripData) return;
			 if (tripData.status === "com") {
			    document.getElementById('persistentNotification').style.display = 'nono';
				     document.querySelector('.profile-btn').style.display = 'none';
			       clearDriverTracking();
				       if (startMarker) startMarker.setMap(null);
                     if (endMarker) endMarker.setMap(null);
                    if (directionsRenderer) directionsRenderer.setMap(null);
    
    //   ØªÙƒØ¨ÙŠ Ø± Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¹Ù„Ù‰ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
                      const startLatLng = new google.maps.LatLng(
                      tripData.startLocation.lat,
                      tripData.startLocation.lng
                   );
     
                       map.setCenter(startLatLng);
                       map.setZoom(18); // Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªÙƒØ¨ÙŠØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
    
  const driverId = tripData.driverId;
  const driverLocationRef = database.ref(`drives/${driverId}/location`);

  // Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ù…Ø§Ø±ÙƒÙØ± Ø§Ù„Ø³Ø§Ø¦Ù‚
  let driverMarker = null;

  // Ø§Ø³ØªÙ…Ø¹ Ù„ÙƒÙ„ ØªØºÙŠÙŠØ± ÙÙŠ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚
  driverLocationRef.on('value', (snapshot) => {
    const loc = snapshot.val();
    if (!loc) return;

    const pos = new google.maps.LatLng(loc.lat, loc.lng);

    if (!driverMarker) {
      // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø§Ø±ÙƒÙØ± Ø£ÙˆÙ„ Ù…Ø±Ø©
      driverMarker = new google.maps.Marker({
        position: pos,
        map: map,
        icon: {
          url: "https://maps.gstatic.com/mapfiles/kml/shapes/cabs.png",
          scaledSize: new google.maps.Size(40, 40),
          anchor: new google.maps.Point(20, 20),
        },
        title: 'Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ø­Ø§Ù„ÙŠ'
      });
    } else {
      // ÙÙ‚Ø· Ø­Ø¯Ù‘Ø« Ø§Ù„Ù…ÙˆÙ‚Ø¹
      driverMarker.setPosition(pos);
    }

    // Ø§Ø®ØªÙŠØ§Ø±ÙŠ: ØªØ­Ø±ÙŠÙƒ Ù…Ø±ÙƒØ² Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ÙŠÙ†Ø§Ø³Ø¨ Ø§Ù„Ù…Ø§Ø±ÙƒÙØ±
    // map.panTo(pos);
  });

                   showArrivalNotification(tripData.driverId); // <-- Ù‡Ù†Ø§ ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø®Ø·Ø£
				   document.querySelector('.action-buttons').style.display = 'none';
      			  document.getElementById('map').style.display = 'block'; // Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±
       			  document.querySelector('.input-field').style.display = 'none';
                  document.getElementById('origin').parentNode.style.display = 'none';
                   document.getElementById('destination').parentNode.style.display = 'none';
                     document.querySelector('.profile-btn').style.display = 'none';
                    return;
                }
                if (tripData.status === "end") {
				    cleanGhostMapElements();
				    // Ù…Ø³Ø­ Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØ§Ù„Ù…Ø³Ø§Ø±Ø§Øª
    if (driverMarker) {
        driverMarker.setMap(null);
        driverMarker = null;
    }
    if (driverDirectionsRenderer) {
        driverDirectionsRenderer.setMap(null);
        driverDirectionsRenderer = null;
    }
    if (driverRoutePolyline) {
        driverRoutePolyline.setMap(null);
        driverRoutePolyline = null;
    }
    
				     document.querySelector('.profile-btn').style.display = 'none';
		            document.getElementById('map').style.display = 'none';
                    document.querySelector('.control-panel').style.display = 'none';
                    document.querySelector('.action-buttons').style.display = 'none';
                    document.getElementById('routeInfo').style.display = 'none';
                    document.getElementById('persistentNotification').style.display = 'none';
                   showEndNotification(tripData.price);
            // Ø¥ÙŠÙ‚Ø§Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ†
                   tripRef.off('value', tripListener);
                if (driverLocationListener) {
                   database.ref(`drives/${tripData.driverId}/location`).off('value', driverLocationListener);
                }
                     return;
                }
				        // Ø¥Ø¶Ø§ÙØ© Ø­Ø§Ù„Ø© ready Ù‡Ù†Ø§
                if (tripData.status === "ready") {
				    cleanGhostMapElements();
				     document.querySelector('.profile-btn').style.display = 'none';
                    clearMapElements();				
			       clearDriverTracking();
				  if (startMarker) startMarker.setMap(null);
                     if (endMarker) endMarker.setMap(null);
                    if (directionsRenderer) directionsRenderer.setMap(null);
    
				  document.querySelector('.action-buttons').style.display = 'none';
      			  document.getElementById('map').style.display = 'block'; // Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±
       			  document.querySelector('.input-field').style.display = 'none';
                  document.getElementById('origin').parentNode.style.display = 'none';
                   document.getElementById('destination').parentNode.style.display = 'none';
                   document.getElementById('persistentNotification').style.display = 'nono';

					    trackDriverToDestination(
                        tripData.driverId,
                         tripData.endLocation
                        );
            				          
   // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¯Ø§Ø¦Ù…
    document.getElementById('persistentNotification').style.display = 'nono';
    document.getElementById('tripStatusContent').innerHTML = `
        <h3>Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ù†Ø·Ù„Ø§Ù‚!</h3>
        <p>ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³Ø§Ø± Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„Ø³Ø§Ø¦Ù‚</p>
        <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØ¬Ù‡ Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ¬Ù‡Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</p>
    `;
    
						    // ØªØ­Ø¯ÙŠØ« Ù…Ø±ÙƒØ² Ø§Ù„Ø®Ø±ÙŠØ·Ø©
                  const bounds = new google.maps.LatLngBounds();
                   bounds.extend(tripData.startLocation);
                   bounds.extend(tripData.endLocation);
                   map.fitBounds(bounds, {padding: 100});
                }

             if (tripData.status === "accepted" && tripData.driverId) {
                try {
                // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                   directionsRenderer.setMap(null);
                   startMarker.setMap(map);
                   endMarker.setMap(null);
                  
				  
				  startMarker.setPosition(tripData.startLocation); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª
				       document.querySelector('.profile-btn').style.display = 'none';
                // Ø¥Ø®ÙØ§Ø¡ Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                   document.querySelector('.action-buttons').style.display = 'none';
			       document.getElementById('map').style.display = 'block'; // Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±
		   	       document.querySelector('.input-field').style.display = 'none';
                   document.getElementById('origin').parentNode.style.display = 'none';
                  document.getElementById('destination').parentNode.style.display = 'none';
                 // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ 
                   const driverSnapshot = await database.ref(`drives/${tripData.driverId}`).once('value');
                   const driverData = driverSnapshot.val();
                // Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¯Ø§Ø¦Ù…Ø©
                   document.getElementById('persistentNotification').style.display = 'block';
                   document.getElementById('tripStatusContent').innerHTML = `
                      <p>Ø§Ù„Ø§Ø³Ù…: ${driverData.fullName}</p>
                      <p>Ø§Ù„Ø³ÙŠØ§Ø±Ø©: ${driverData.carModel}</p>
                      <p>Ø§Ù„Ù‡Ø§ØªÙ: ${driverData.phoneNumber}</p>
				      <p>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹: ${tripData.paymentMethod === 'electronic' ? 'Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ' : 'Ù†Ù‚Ø¯ÙŠ'}</p>
                      <div id="distanceInfo">Ø¬Ø§Ø±ÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©...</div>
                   `;

                // Ø¨Ø¯Ø¡ ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹
                trackDriverLocation(tripData.driverId, tripData.startLocation);
                   document.getElementById('persistentNotification').style.display = 'block';

                } catch (error) {
                   console.error('Error:', error);
              }
            }
          });   
        }
		async function trackDriverToDestination(driverId, endLocation) {
    // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù…Ø³Ø§Ø±Ø§Øª Ø³Ø§Ø¨Ù‚Ø©
    if (directionsRenderer) {
        directionsRenderer.setMap(null);
    }
        if (driverMarker) {
        driverMarker.setMap(null);
        driverMarker = null;
    }

    // Ø¥Ù†Ø´Ø§Ø¡ renderer Ø¬Ø¯ÙŠØ¯
    directionsRenderer = new google.maps.DirectionsRenderer({
        suppressMarkers: true,
        polylineOptions: {
            strokeColor: "#4285F4",
            strokeOpacity: 0.9,
            strokeWeight: 7
        }
    });
    
    // Ù…ØªØ§Ø¨Ø¹Ø© ØªØ­Ø¯ÙŠØ«Ø§Øª Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚
    const driverRef = database.ref(`drives/${driverId}/location`);
    driverRef.on('value', async (snapshot) => {
        const driverLoc = snapshot.val();
        if (!driverLoc) return;
        
        try {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³Ø§Ø± Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
            const request = {
                origin: new google.maps.LatLng(driverLoc.lat, driverLoc.lng),
                destination: endLocation,
                travelMode: 'DRIVING'
            };
            
            const response = await directionsService.route(request);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª
            if (driverMarker) driverMarker.setMap(null);
              if (directionsRenderer) {
    directionsRenderer.setMap(null);
  }
  if (endMarker) {
    endMarker.setMap(null);
  }

  // Ø¥Ù†Ø´Ø§Ø¡ renderer Ø¬Ø¯ÙŠØ¯
  directionsRenderer = new google.maps.DirectionsRenderer({
    suppressMarkers: true,
    polylineOptions: {
      strokeColor: "#4285F4",
      strokeOpacity: 0.9,
      strokeWeight: 7
    }
  });
            driverMarker = new google.maps.Marker({
                position: request.origin,
                map: map,
                icon: {
                    url: 'https://maps.gstatic.com/mapfiles/kml/shapes/cabs.png',
                    scaledSize: new google.maps.Size(40, 40)
                }
            });
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø­Ø¯Ø«
            directionsRenderer.setOptions({
                map: map,
                directions: response
            });
			      endMarker = new google.maps.Marker({
        position: endLocation,
        map: map,
        title: 'Ù†Ù‚Ø·Ø© Ø§Ù„ÙˆØµÙˆÙ„',
        icon: {
          url: 'https://cdn-icons-png.flaticon.com/512/149/149068.png',
          // ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù„Ø£ÙŠ ØµÙˆØ±Ø© ØªØ±ÙŠØ¯Ù‡Ø§
          scaledSize: new google.maps.Size(30, 30)
        }
      });

            
                 // Ø¶Ø¨Ø· Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ´Ù…Ù„ Ø§Ù„Ø£ØµÙ„ ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©
      const bounds = new google.maps.LatLngBounds();
      bounds.extend(originLatLng);
      bounds.extend(endLocation);
// 1. Ø§Ø³ØªØ®Ø¯Ø§Ù… maxZoom Ù…Ø¨Ø§Ø´Ø±Ø©:
map.fitBounds(bounds, {
  padding: 100,
  maxZoom: 100   // Ø­Ø¯Ø¯ Ø£Ù‚ØµÙ‰ Ù…Ø³ØªÙˆÙ‰ Ø²ÙˆÙ… ØªØ±ÙŠØ¯Ù‡
});

// 2. Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… setTimeout Ù„Ø¶Ù…Ø§Ù† Ø£Ù† fitBounds Ø§Ù†ØªÙ‡Øª:
map.fitBounds(bounds, { padding: 100 });
setTimeout(() => {
  // Ø§Ø¬Ø¹Ù„ Ø§Ù„Ø²ÙˆÙ… ÙŠØµÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯Ù‡Ø§
  map.setZoom(100);
}, 500);
      
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³Ø§Ø±:', error);
        }
    });
}
        function showDriverRealTimeLocation(driverId) {
    // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù…Ø³ØªÙ…Ø¹ Ø³Ø§Ø¨Ù‚
            if (driverLocationListener) {
                 database.ref(`drives/${driverId}/location`).off('value', driverLocationListener);
            }

            const carIcon = {
                  url: "https://cdn-icons-png.flaticon.com/512/744/744515.png",
                  scaledSize: new google.maps.Size(40, 40),
                  anchor: new google.maps.Point(20, 20)
            };

            driverLocationListener = database.ref(`drives/${driverId}/location`).on('value', (snapshot) => {
               const driverLocation = snapshot.val();
            if (!driverLocation) return;

            const driverPos = new google.maps.LatLng(
                driverLocation.latitude,
                driverLocation.longitude
            );

            if (!driverMarker) {
               driverMarker = new google.maps.Marker({
                  position: driverPos,
                  map: map,
                  icon: carIcon,
                  title: 'Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„Ø³Ø§Ø¦Ù‚',
                  animation: google.maps.Animation.BOUNCE
                });
            } else {
               driverMarker.setPosition(driverPos);
            }

             map.panTo(driverPos);
             map.setZoom(17);
            });
        }

    async function trackDriverLocation(driverId, startLocation) {
  console.log("[Checkpoint 6] ØªØªØ¨Ø¹ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ - Ù…Ø¹Ø±Ù Ø§Ù„Ø³Ø§Ø¦Ù‚:", driverId);
const carIcon = {
  url: "https://maps.gstatic.com/mapfiles/kml/shapes/cabs.png",  // Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù…Ù† Google
  scaledSize: new google.maps.Size(40, 40),                       // Ø§Ø¶Ø¨Ø· Ø§Ù„Ø­Ø¬Ù… Ø¨Ù…Ø§ ÙŠÙ†Ø§Ø³Ø¨Ùƒ
  anchor:    new google.maps.Point(24, 24)                        // ØªØ«Ø¨ÙŠØª Ù…Ù†ØªØµÙ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
};

  // ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª
  if (!startLocation || isNaN(startLocation.lat) || isNaN(startLocation.lng)) {
    console.error("[Error] Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ØºÙŠØ± ØµØ§Ù„Ø­Ø©:", startLocation);
    return;
  }
  
  const startPos = new google.maps.LatLng(startLocation.lat, startLocation.lng);
  console.log("[Checkpoint 7] Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (Ø§Ù„Ø¹Ù…ÙŠÙ„):", startPos.toString());
  
  const driverRef = database.ref(`drives/${driverId}/location`);
  console.log("[Checkpoint 8] Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ ØªØ­Ø¯ÙŠØ«Ø§Øª Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚");
  
  driverRef.on('value', async (snapshot) => {
    const driverLocation = snapshot.val();
    if (!driverLocation) {
      console.warn("[Warning] Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ ØºÙŠØ± Ù…ØªÙˆÙØ± Ø­Ø§Ù„ÙŠÙ‹Ø§");
      return;
    }
    
    console.log("[Checkpoint 9] Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„ÙˆØ§Ø±Ø¯Ø© Ù…Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚:", driverLocation);
    
    // ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹
    if (!driverLocation.lat || !driverLocation.lng) {
      console.error("[Error] Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ ØºÙŠØ± ØµØ§Ù„Ø­Ø©");
      return;
    }
    
    const driverPos = new google.maps.LatLng(
      Number(driverLocation.lat),
      Number(driverLocation.lng)
    );
            // Ø¥Ù†Ø´Ø§Ø¡/ØªØ­Ø¯ÙŠØ« Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚
        if (!driverMarker) {
            driverMarker = new google.maps.Marker({
                position: driverPos,
                map: map, // Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø¹Ù„Ù‰ Ø¥Ø±ÙØ§Ù‚ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø¨Ø§Ù„Ø®Ø±ÙŠØ·Ø©
                icon: carIcon,
                title: 'Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„Ø³Ø§Ø¦Ù‚',
                animation: google.maps.Animation.BOUNCE,
                zIndex: 9999
            });
            console.log('[ØªØªØ¨Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚] ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©');
        } else {
            driverMarker.setPosition(driverPos);
        }
    console.log("[Checkpoint 10] Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„Ø³Ø§Ø¦Ù‚:", driverPos.toString());
          // ØªØ­Ø¯ÙŠØ« Ù…Ø±ÙƒØ² Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ÙŠØ´Ù…Ù„ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆÙ†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
        const bounds = new google.maps.LatLngBounds();
        bounds.extend(driverPos);
        bounds.extend(new google.maps.LatLng(startLocation.lat, startLocation.lng));
        map.fitBounds(bounds, {padding: 100});

        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆÙ†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
        const distance = google.maps.geometry.spherical.computeDistanceBetween(
            driverPos,
            new google.maps.LatLng(startLocation.lat, startLocation.lng)
        );
		       // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„Ù…Ø³Ø§ÙØ©
        document.getElementById('distanceInfo').innerHTML = `
            Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: ${(distance / 1000).toFixed(1)} ÙƒÙ…
        `;
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§Ø±
    try {
      const request = {
        origin: driverPos,
        destination: startPos,
        travelMode: 'DRIVING'
      };
      
      console.log("[Checkpoint 11] Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§Ø±:", request);
      
      const response = await directionsService.route(request);
      console.log("[Checkpoint 12] Ø§Ø³ØªØ¬Ø§Ø¨Ø© Directions API:", response);
      
      // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
      if (driverDirectionsRenderer) {
        driverDirectionsRenderer.setMap(null);
      }
      
      driverDirectionsRenderer = new google.maps.DirectionsRenderer({
        suppressMarkers: true,
		 polylineOptions: { 
            strokeColor: "#FF00FF",
            strokeOpacity: 0.8,
            strokeWeight: 7
        }
      });
      
      driverDirectionsRenderer.setMap(map);
      driverDirectionsRenderer.setDirections(response);
      
    } catch (error) {
      console.error("[Error] ÙØ´Ù„ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§Ø±:", error);
      console.error("Ø§Ù„ØªÙØ§ØµÙŠÙ„:", {
        origin: driverPos.toJSON(),
        destination: startPos.toJSON(),
        error: error.message
      });
    }
  });

}
        function updateDriverRoute(currentPos, startPos) {
            if (driverRoutePolyline) {
                driverRoutePolyline.setMap(null);
            }

            driverRoutePolyline = new google.maps.Polyline({
                path: [currentPos, startPos],
                geodesic: true,
                strokeColor: "#FF00FF",
                strokeOpacity: 0.8,
                strokeWeight: 7,
                map: map
            });
        }
		function showArrivalNotification(driverId) {
            const notification = document.getElementById('arrivalNotification');
            const sound = document.getElementById('notificationSound');
    
    // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚
            database.ref(`drives/${driverId}`).once('value').then((snapshot) => {
                const driverData = snapshot.val();
                document.getElementById('driverArrivalInfo').innerHTML = `
                     <p>Ø§Ù„Ø§Ø³Ù…: ${driverData.fullName}</p>
                     <p>Ø§Ù„Ù‡Ø§ØªÙ: <a href="tel:${driverData.phoneNumber}">${driverData.phoneNumber}</a></p>
                     <p>Ø§Ù„Ø³ÙŠØ§Ø±Ø©: ${driverData.carNumber}</p>
                     `;
                });

    // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙˆØª
            sound.loop = true;
            sound.play().catch(() => {
            notification.innerHTML += '<p style="color:red;">ÙŠÙØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª</p>';
            });

            notification.style.display = 'block';
        }    
        function handleArrivalConfirmation() {
            const notification = document.getElementById('arrivalNotification');
            const sound = document.getElementById('notificationSound');
    
    // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµÙˆØª
            sound.pause();
            sound.currentTime = 0;
    
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ÙÙ‚Ø· Ø¯ÙˆÙ† Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            notification.style.display = 'none';
    
    // Ø¥Ø¨Ù‚Ø§Ø¡ Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¸Ø§Ù‡Ø±Ø©
            if (driverMarker) {
             driverMarker.setAnimation(null); // Ø¥ÙŠÙ‚Ø§Ù ØªØ£Ø«ÙŠØ± Ø§Ù„Ø§Ø±ØªØ¯Ø§Ø¯
            }
        }
    	function clearDriverTracking() {
    // Ø¥Ø²Ø§Ù„Ø© ØªØªØ¨Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚
            if (driverLocationListener) {
                 database.ref(`drives/${tripData.driverId}/location`).off('value', driverLocationListener);
                driverLocationListener = null;
           
			}

    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª ÙˆØ§Ù„Ù…Ø³Ø§Ø±Ø§Øª
            if (driverMarker) driverMarker.setMap(null);
            if (driverDirectionsRenderer) driverDirectionsRenderer.setMap(null);
            driverDirectionsRenderer = null;

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ù†Ø§ØµØ±
            document.getElementById('persistentNotification').style.display = 'none';
        }
		function showActualRoute(startLoc, endLoc) {
    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
            if(directionsRenderer) directionsRenderer.setMap(null);
            if(startMarker) startMarker.setMap(null);
            if(endMarker) endMarker.setMap(null);

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø®ØµØ§Ø¦Øµ Ø§Ù„Ù…Ø³Ø§Ø±
              directionsRenderer = new google.maps.DirectionsRenderer({
             suppressMarkers: false,
               polylineOptions: {
               strokeColor: "#0000FF",
              strokeOpacity: 0.8,
              strokeWeight: 6,
               zIndex: 1000
            },
              markerOptions: {
              opacity: 0.8 // Ø´ÙØ§ÙÙŠØ© Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª
    }
            });

    // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù„Ø§Ù…Ø§Øª Ù…Ø®ØµØµØ©
            startMarker = new google.maps.Marker({
               position: startLoc,
               map: map,
               icon: {
                  path: google.maps.SymbolPath.CIRCLE,
                  scale: 8,
                 fillColor: "#00CED1",
                fillOpacity: 1,
                 strokeColor: "#FFF",
                strokeWeight: 2
                },
              zIndex: 1001
            });

            endMarker = new google.maps.Marker({
                position: endLoc,
               map: map,
             icon: {
              path: google.maps.SymbolPath.CIRCLE,
               scale: 8,
               fillColor: "#FF6B6B",
               fillOpacity: 1,
               strokeColor: "#FFF",
               strokeWeight: 2
              },
              zIndex: 1001
            });

    // Ø·Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø±
             const request = {
                  origin: startLoc,
               destination: endLoc,
                travelMode: 'DRIVING',
                 provideRouteAlternatives: false,
                optimizeWaypoints: true
            };

           directionsService.route(request, (response, status) => {
                 if (status === 'OK') {
            // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³Ø§Ø±
                 directionsRenderer.setMap(map);
                 directionsRenderer.setDirections(response);

            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
               const bounds = new google.maps.LatLngBounds();
                 bounds.extend(startLoc);
                 bounds.extend(endLoc);
                 map.fitBounds(bounds);

            // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø±
                const route = response.routes[0].legs[0];
                document.getElementById('routeInfo').style.display = 'block';
                document.getElementById('routeInfo').innerHTML = `
                <h3>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø©:</h3>
                <p>Ø§Ù„Ù…Ø³Ø§ÙØ©: ${route.distance.text}</p>
                <p>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: ${route.duration.text}</p>
                <div class="progress-bar" style="margin-top:15px;">
                    <div class="progress" style="height: 8px; background: #333; border-radius:4px;">
                        <div class="progress-fill" style="width: 100%; height:100%; background: var(--primary-color); border-radius:4px;"></div>
                    </div>
                </div>
               `;

            // Ø¥Ø¶Ø§ÙØ© Ø®Ø· Ù…ØªØ­Ø±Ùƒ Ù„Ù„Ù…Ø³Ø§Ø±
               const path = response.routes[0].overview_path;
               animateRoute(path);
            } else {
                   console.error('ÙØ´Ù„ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³Ø§Ø±:', status);
            }
            });
        }
		function animateRoute(path) {
            let count = 0;
           const line = new google.maps.Polyline({
           path: [],
           geodesic: true,
           strokeColor: "#00CED1",
           strokeOpacity: 0.8,
           strokeWeight: 6
           });

         const animate = () => {
            if (count >= path.length) {
            line.setMap(null);
            return;
          }

          line.getPath().push(path[count]);
          line.setMap(map);
          count++;
          setTimeout(animate, 50);
          };

            animate(); 
        }
        function showEndNotification(price) {
    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù†ØµØ± Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯
           let endNotification = document.getElementById('endNotification');
    
            if (!endNotification) {
            endNotification = document.createElement('div');
            endNotification.id = 'endNotification';
            endNotification.className = 'end-notification';
            document.body.appendChild(endNotification);
            }

    // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰
           endNotification.innerHTML = `
               <h2>ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</h2>
               <div class="price">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø¹Ø± Ø§Ù„Ø±Ø­Ù„Ø©: ${price} Ø¬Ù†ÙŠÙ‡</div>
               <button class="btn" onclick="handlePaymentDone()" 
                    style="margin-top:20px; padding:12px 30px;">
                    ØªÙ… Ø§Ù„Ø¯ÙØ¹ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„
                </button>
            `;
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª
    if (driverMarker) driverMarker.setMap(null);
    if (endMarker) endMarker.setMap(null);
    if (startMarker) startMarker.setMap(null);
    // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª
             const sound = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
             sound.play().catch(() => {
             console.log('ÙŠÙØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª');
            });

 
        }
		function handlePaymentDone() {
    // 1. Ø¥Ø®ÙØ§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
            const endNotification = document.getElementById('endNotification');
           if (endNotification) endNotification.remove();
    
    // 2. Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ±
           document.getElementById('map').style.display = 'block';
           document.querySelector('.control-panel').style.display = 'flex';
           document.querySelector('.action-buttons').style.display = 'flex';
           document.getElementById('routeInfo').style.display = 'block';
    
    // 3. ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†
            clearAll();
    
    // 4. Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
           // initMap();
        }

// Ø¥Ø¶Ø§ÙØ© Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø³Ø§Ø±
async function restoreRoute(startLoc, endLoc) {
    const request = {
        origin: startLoc,
        destination: endLoc,
        travelMode: 'DRIVING'
    };
    
    try {
	
        const response = await directionsService.route(request);
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª
        startMarker.setPosition(startLoc);
        startMarker.setMap(map);
        endMarker.setPosition(endLoc);
        endMarker.setMap(map)
		directionsRenderer.setMap(map);
        directionsRenderer.setDirections(response);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª
        startMarker.setPosition(startLoc);
        endMarker.setPosition(endLoc);
        
        // ØªØ­Ø¯ÙŠØ« Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
        const bounds = new google.maps.LatLngBounds();
        bounds.extend(startLoc);
        bounds.extend(endLoc);
        map.fitBounds(bounds, {padding: 50});
        
    } catch (error) {
        console.error('ÙØ´Ù„ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø³Ø§Ø±:', error);
    }
}
        async function restorePreviousTrip() {
           if (!currentTripId) return;
             
            showLoading(true);
            try {
    	     const userId = localStorage.getItem('userId');
             const tripRef = database.ref(`rides/${userId}/${currentTripId}`);
             const snapshot = await tripRef.once('value');
    
           if (!snapshot.exists()) {
                localStorage.removeItem('currentTripId');
             return;
            }
    
            const tripData = snapshot.val();
			    // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø³Ø§Ø± Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø­Ø§Ù„Ø© new
        if (tripData.status === "new") {
		
            await restoreRoute(tripData.startLocation, tripData.endLocation);
            document.getElementById('priceOptions').style.display = 'flex';
            totalDistance = tripData.distance;
			            document.getElementById('priceOptions').style.display = 'none';
            document.querySelectorAll('.input-field').forEach(field => {
                field.style.display = 'none';
            });
        }
              await restoreTripState();

            } catch (error) {
                console.error('Error restoring trip:', error);
            } finally {
                showLoading(false);
            }
        }

       function handleStatusChange(status, tripData) {
           switch(status) {
          case 'new':
            showSearchingUI();
            break;
        case 'accepted':
            showAcceptedUI(tripData.driverId);
            break;
        case 'in_progress':
            showInProgressUI(tripData);
            break;
        case 'completed':
            showCompletedUI(tripData);
            break;
        case 'canceled':
            showCanceledUI();
            break;
        default:
            console.log('Unknown status:', status);
           }
        }

        function setupNewTripUI(tripData) {
             const userId = localStorage.getItem('userId');
             const tripRef = database.ref(`rides/${userId}/${currentTripId}`);
    
           tripListener = tripRef.on('value', (snapshot) => {
                const tripData = snapshot.val();
               if (!tripData) {
                clearAll();
                return;
            }
        
                 handleStatusChange(tripData.status, tripData);
            });
        }

        function showSearchingUI() {
		     document.querySelector('.action-buttons').style.display = 'none';
      			  document.getElementById('map').style.display = 'block'; // Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±
       			  document.querySelector('.input-field').style.display = 'none';
                  document.getElementById('origin').parentNode.style.display = 'none';
                   document.getElementById('destination').parentNode.style.display = 'none';
          document.getElementById('persistentNotification').style.display = 'block';
          document.getElementById('tripStatusContent').innerHTML = `
           <h3>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚...</h3>
            <div class="loading-spinner"></div>
          `;
        }

        async function showAcceptedUI(driverId) {
            const driverSnapshot = await database.ref(`drives/${driverId}`).once('value');
           const driverData = driverSnapshot.val();
    
         document.getElementById('persistentNotification').style.display = 'block';
         document.getElementById('tripStatusContent').innerHTML = `
           <h3>ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨Ùƒ</h3>
            <p>Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚: ${driverData.fullName}</p>
              <p>Ù…ÙˆØ¯ÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø©: ${driverData.carModel}</p>
           <p>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: ${driverData.phoneNumber}</p>
           <div id="driverLiveLocation"></div>
          `;
    
           startTrackingDriver(driverId);
        }

        function showInProgressUI(tripData) {
            document.getElementById('persistentNotification').style.display = 'block';
           document.getElementById('tripStatusContent').innerHTML = `
            <h3>Ø§Ù„Ø±Ø­Ù„Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªÙ‚Ø¯Ù…</h3>
            <p>Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹Ø©: <span id="distanceTraveled">0</span> ÙƒÙ…</p>
            <p>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <span id="eta">--</span></p>
           `;
    
            updateTripProgress(tripData);
        }
		function showCanceledUI() {
            document.getElementById('persistentNotification').style.display = 'block';
           document.getElementById('tripStatusContent').innerHTML = `
            <h3 style="color: #ff4444;">ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</h3>
            <button class="btn" onclick="clearAll()">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
          `;
        }

// Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('beforeunload', async (e) => {
            if (currentTripId) {
            const tripRef = database.ref(`rides/${userId}/${currentTripId}`);
            await tripRef.update({ lastActive: firebase.database.ServerValue.TIMESTAMP });
            }
        });
		function cancelRestore() {
           localStorage.removeItem('currentTripId');
            location.reload();
        }

        async function setupAcceptedTripUI(tripData) {
  // Ø¥Ø®ÙØ§Ø¡ Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ…
          document.querySelector('.control-panel').style.display = 'none';
          document.querySelector('.action-buttons').style.display = 'none';
  
  // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚
          const driverInfo = await getDriverInfo(tripData.driverId);
          document.getElementById('persistentNotification').style.display = 'block';
          document.getElementById('tripStatusContent').innerHTML = `
          <p>Ø§Ù„Ø­Ø§Ù„Ø©: ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ Ø¥Ù„ÙŠÙƒ</p>
          <p>Ø§Ù„Ø³Ø§Ø¦Ù‚: ${driverInfo.name}</p>
          <p>Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: <span id="liveDistance">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...</span></p>
           `;
  
  // Ø¨Ø¯Ø¡ ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­ÙŠ
           startRealTimeTracking(tripData.driverId);
        }
		async function calculateRouteWithRetry(retries = 3) {
           try {
              let origin = document.getElementById('origin').value;
              const destination = document.getElementById('destination').value;

               const request = {
                 origin: currentLocationCoords || origin,
                 destination: destination,
                 travelMode: 'DRIVING'
                };
 
                const response = await directionsService.route(request);
            if (response.routes.length === 0) throw new Error('No routes found');
        
        // ... Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¨Ù†Ø¬Ø§Ø­ ...
        
            } catch (error) {
                if (retries > 0) {
                console.log(`Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©... ${retries} Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù…ØªØ¨Ù‚ÙŠØ©`);
                await new Promise(resolve => setTimeout(resolve, 1000));
                return calculateRouteWithRetry(retries - 1);
                 }
                 showNotification('ÙØ´Ù„ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§Ø±: ' + error.message, true);
            }
        }
        function selectPayment(method, event) {
		    if (!event) return; // ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø­Ø¯Ø«

            selectedPayment = method;
    
            document.querySelectorAll('.payment-option').forEach(option => {
            option.classList.remove('selected');
           });
    
          event.currentTarget.classList.add('selected');
          document.getElementById('confirmBookingButton').style.display = 'block';
        event.currentTarget.classList.add('selected');

    // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ù…Ø±Ø¦ÙŠ
          event.currentTarget.style.transform = 'scale(1.02)';
           
            event.currentTarget.style.transform = 'scale(1)';
           
        }
		async function moveTripToEnd(userId, tripId) {
              try {
            const rideRef = database.ref(`rides/${userId}/${tripId}`);
            const endRef = database.ref(`end/${userId}/${tripId}`);

        // Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ®
            const snapshot = await rideRef.once('value'); 
            const tripData = snapshot.val();
             tripData.endTimestamp = firebase.database.ServerValue.TIMESTAMP;

             await endRef.set(tripData);
             await rideRef.remove();
            } catch (error) {
            console.error('Error moving trip:', error);
           showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø±Ø­Ù„Ø©', true);
            }
        }

        function handlePaymentDone() {
          const userId = localStorage.getItem('userId');
          const tripId = localStorage.getItem('currentTripId');

          if (!userId || !tripId) {
             showNotification('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø­Ù„Ø© Ù†Ø´Ø·Ø©', true);
              return;
           }

    // Ù†Ù‚Ù„ Ø§Ù„Ø±Ø­Ù„Ø© Ø¥Ù„Ù‰ Ù‚Ø³Ù… Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©
           moveTripToEnd(userId, tripId);

    // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†
           const endNotification = document.getElementById('endNotification');
           if (endNotification) endNotification.remove();

           document.getElementById('map').style.display = 'block';
           document.querySelector('.control-panel').style.display = 'flex';
           document.querySelector('.action-buttons').style.display = 'flex';
           document.getElementById('routeInfo').style.display = 'block';

            clearAll();
           showNotification('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø±Ø­Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­');
        }
		async function restoreTripState() {
            const userId = localStorage.getItem('userId');
             const tripRef = database.ref(`rides/${userId}/${currentTripId}`);
            const snapshot = await tripRef.once('value');
            if (snapshot.exists()) {
            const tripData = snapshot.val();
            handleStatusChange(tripData.status, tripData);
            }
        }
		let liveLocationWatcher = null;
        function startLiveLocationTracking(endLocation) {
            if (liveLocationWatcher) {
            navigator.geolocation.clearWatch(liveLocationWatcher);
            }

             liveLocationWatcher = navigator.geolocation.watchPosition(
            position => {
               const currentPos = {
                  lat: position.coords.latitude,
                  lng: position.coords.longitude
                };
            
                 updateLiveRoute(currentPos, endLocation);
            },
            error => {
               console.error('Error getting live location:', error);
            },
            {
              enableHighAccuracy: true,
              maximumAge: 30000,
              timeout: 2700
            }

            );
        }

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø­ÙŠ
        function updateLiveRoute(startPos, endPos) {
           directionsRenderer.setMap(null);
    
          const request = {
           origin: startPos,
          destination: endPos,
          travelMode: 'DRIVING',
          provideRouteAlternatives: false
          };

           directionsService.route(request, (response, status) => {
            if (status === 'OK') {
              directionsRenderer.setOptions({
                polylineOptions: {
                    strokeColor: "#00FF00",
                    strokeOpacity: 0.8,
                    strokeWeight: 6
                 }
                });
              directionsRenderer.setMap(map);
              directionsRenderer.setDirections(response);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª
              startMarker.setPosition(startPos);
              startMarker.setMap(map);
              endMarker.setPosition(endPos);
              endMarker.setMap(map);
            
              map.fitBounds(response.routes[0].bounds);
              }
            });
        }
		// Ø¯Ø§Ù„Ø© Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø´Ø¨Ø­ÙŠØ© Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø©
function cleanGhostMapElements() {
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙˆØ± ØºÙŠØ± Ø§Ù„Ù…Ø±ØºÙˆØ¨ ÙÙŠÙ‡Ø§
    const ghostImages = document.querySelectorAll('img[src="https://maps.gstatic.com/mapfiles/transparent.png"]');
    
    // Ø­Ø°Ù ÙƒÙ„ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©
    ghostImages.forEach(img => {
        img.parentNode.removeChild(img);
    });

    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
    const mapTiles = document.querySelectorAll('div[style*="width: 40px; height: 40px;"]');
    mapTiles.forEach(tile => tile.remove());
}
		function openGoogleMapsNavigation(start, end) {
           const baseUrl = "https://www.google.com/maps/dir/?api=1";
            const params = new URLSearchParams({
            origin: `${start.lat},${start.lng}`,
            destination: `${end.lat},${end.lng}`,
            travelmode: "driving"
           });
            window.open(`${baseUrl}&${params.toString()}`, '_blank');
        }
        function clearAll() {
    
    // Ø¥Ø²Ø§Ù„Ø© Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
    if (driverMarker) {
        driverMarker.setMap(null);
        driverMarker = null;
    }
	    cleanGhostMapElements();
        driverMarker = null;
    driverDirectionsRenderer = null;
    // Ù…Ø³Ø­ Ø£ÙŠ Ù…Ø³Ø§Ø±Ø§Øª Ù…ØªØ¨Ù‚ÙŠØ©
    if (driverRoutePolyline) {
        driverRoutePolyline.setMap(null);
        driverRoutePolyline = null;
    }
    // Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø©
	    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
             document.querySelector('.control-panel').style.display = 'flex';
             document.querySelector('.action-buttons').style.display = 'flex';
             document.getElementById('routeInfo').style.display = 'block';
             if (driverDirectionsRenderer) driverDirectionsRenderer.setMap(null);
             if (directionsRenderer) directionsRenderer.setMap(null);
             if (startMarker) startMarker.setMap(null);
             if (endMarker) endMarker.setMap(null);
             if (currentLocationMarker) currentLocationMarker.setMap(null);
             if (driverRoutePolyline) driverRoutePolyline.setMap(null);
             if (driverMarker) driverMarker.setMap(null);
             if (destinationMarker) destinationMarker.setMap(null);
               if(directionsRenderer) directionsRenderer.setMap(null);
			 driverMarker = null;
             destinationMarker = null;
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
             document.getElementById('persistentNotification').style.display = 'none';
             document.getElementById('routeInfo').innerHTML = '';
             document.getElementById('priceOptions').style.display = 'none';
             document.getElementById('bookingDetails').style.display = 'none';
             localStorage.removeItem('currentTripId');
    // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
               document.querySelectorAll('.input-field').forEach(field => {
                  field.style.display = 'block'; // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ø±Ø¶
                })
				    document.getElementById('origin').parentNode.style.display = 'block';
                    document.getElementById('destination').parentNode.style.display = 'block';
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‚ÙŠÙ…
	    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©
    startMarker.setPosition(null);
    endMarker.setPosition(null);
             currentTripId = null;
             selectedVehicle = null;
             currentLocationCoords = null;
        if (driverDirectionsRenderer) {
        driverDirectionsRenderer.setMap(null);
        driverDirectionsRenderer = null;
    }
    // Ø¥Ø²Ø§Ù„Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù‚ÙˆÙ„
             document.getElementById('origin').value = '';
             document.getElementById('destination').value = '';
    
     // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª
            if (tripListener) database.ref(`rides/${currentTripId}`).off('value', tripListener);
            if (driverLocationListener) database.ref(`drives/${driverId}/location`).off('value', driverLocationListener);
            const notification = document.getElementById('arrivalNotification');
            if (notification) {
               notification.style.display = 'none';
               notification.classList.remove('success');
            }
		       localStorage.removeItem('currentTripId');

        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø¸Ø§Ù‡Ø±Ø©
            const endNotification = document.getElementById('endNotification');
            if (endNotification) {
                endNotification.remove();
            }
		    if(map) {
             map.setZoom(15);
            map.setCenter({ lat: 30.0444, lng: 31.2357 });
            }
    // Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ Ø£ØµÙˆØ§Øª
            const sound = document.getElementById('notificationSound');
            if (sound) {
                sound.pause();
                sound.currentTime = 0;
            }
    	    if (liveLocationWatcher) {
           navigator.geolocation.clearWatch(liveLocationWatcher);
          liveLocationWatcher = null;
           }
		}

        function getVehicleName(type) {
            const vehicles = {
                normal: 'Ø³ÙŠØ§Ø±Ø© Ø¹Ø§Ø¯ÙŠØ©',
                luxury: 'Ø³ÙŠØ§Ø±Ø© ÙØ§Ø®Ø±Ø©',
                helicopter: 'Ø·Ø§Ø¦Ø±Ø©'
            };
            return vehicles[type] || '';
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
        }

        function showNotification(message, isError = false) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.background = isError ? '#ff4444' : '#00CED1';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.remove(), 5000);
        }
		function adjustMarkersPosition(startPos, endPos) {
    const bounds = new google.maps.LatLngBounds();
    bounds.extend(startPos);
    bounds.extend(endPos);
    
    const ne = bounds.getNorthEast();
    const sw = bounds.getSouthWest();
    
    const padding = 0.0002; // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù…Ù‚Ø¯Ø§Ø± 20 Ù…ØªØ± ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§
    
    startMarker.setPosition(new google.maps.LatLng(
        startPos.lat() + padding,
        startPos.lng() - padding
    ));
    
    endMarker.setPosition(new google.maps.LatLng(
        endPos.lat() - padding,
        endPos.lng() + padding
    ));
}
// Ù…ØªØºÙŠØ± Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª Ø¹Ù„Ø´Ø§Ù† Ù†Ù‚Ø¯Ø± Ù†Ù…Ø³Ø­Ù‡Ù… Ø¨Ø¹Ø¯ÙŠÙ†
let tripAreas = [];
const hexGridSize = 0.006; // ØªØ¨Ø§Ø¹Ø¯ Ø§Ù„Ù…Ø±Ø§ÙƒØ² (Ø­Ø³Ø¨ Ù†ØµÙ Ø§Ù„Ù‚Ø·Ø± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨)
const hexRadius = 0.0029; // Ù†ØµÙ Ø§Ù„Ù‚Ø·Ø± Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„ØªØ¨Ø§Ø¹Ø¯

let tripHexagons = [];
const densityColors = {
    low: '#FFD580',    // 1-3 Ø±Ø­Ù„Ø§Øª
    medium: '#FFA500',  // 4-6 Ø±Ø­Ù„Ø§Øª
    high: '#FF4500'     // 7+ Ø±Ø­Ù„Ø§Øª
};

async function drawTripHotspots() {
    tripHexagons.forEach(hex => hex.setMap(null));
    tripHexagons = [];
    
    const ridesRef = database.ref('rides');
    const snapshot = await ridesRef.once('value');
    const areas = new Map();

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø¨ÙƒØ© Ø§Ù„Ø³Ø¯Ø§Ø³ÙŠØ©
    const getGridKey = (lat, lng) => {
        const gridLat = Math.round(lat / hexGridSize) * hexGridSize;
        const gridLng = Math.round(lng / hexGridSize) * hexGridSize;
        return `${gridLat},${gridLng}`;
    };

    snapshot.forEach(userSnapshot => {
        userSnapshot.forEach(tripSnapshot => {
            const trip = tripSnapshot.val();
            if (trip.startLocation) {
                const key = getGridKey(
                    trip.startLocation.lat,
                    trip.startLocation.lng
                );
                areas.set(key, (areas.get(key) || 0) + 1);
            }
        });
    });

    // Ø±Ø³Ù… Ø§Ù„Ø£Ø´ÙƒØ§Ù„ Ù…Ø¹ Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø§Ù„ØªØ¯Ø§Ø®Ù„
    areas.forEach((count, key) => {
        const [lat, lng] = key.split(',');
        const hexagon = createHexagon(
            parseFloat(lat),
            parseFloat(lng),
            hexRadius, // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†ØµÙ Ø§Ù„Ù‚Ø·Ø± Ø§Ù„Ù…Ø¹Ø¯Ù„
            getDensityColor(count),
            count
        );
        tripHexagons.push(hexagon);
    });
}

function getDensityColor(count) {
    if (count <= 3) return densityColors.low;
    if (count <= 6) return densityColors.medium;
    return densityColors.high;
}
function createHexagon(lat, lng, radius, color, tripCount) {
    const center = { lat, lng };
    const coordinates = [];
    
    for (let i = 0; i < 6; i++) {
        const angle = (i * 60) * (Math.PI / 180);
        const dx = radius * Math.cos(angle);
        const dy = radius * Math.sin(angle);
        coordinates.push({ lat: lat + dy, lng: lng + dx });
    }
    coordinates.push(coordinates[0]);

    const hexagon = new google.maps.Polygon({
        paths: coordinates,
        strokeColor: color,
        strokeOpacity: 0.8,
        strokeWeight: 1,
        fillColor: color,
        fillOpacity: 0.3 + (tripCount * 0.05), // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø´ÙØ§ÙÙŠØ© Ù…Ø¹ Ø§Ù„ÙƒØ«Ø§ÙØ©
        map: map,
        zIndex: 1,
        clickable: false

    });

    // Ø¥Ø¶Ø§ÙØ© ØªÙØ§Ø¹Ù„ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„hover
    hexagon.addListener('mouseover', () => {
        hexagon.setOptions({ 
            strokeWeight: 3,
            fillOpacity: 0.5 
        });
        new google.maps.InfoWindow({
            content: `Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø­Ù„Ø§Øª: ${tripCount}`
        }).open(map, hexagon);
    });

    hexagon.addListener('mouseout', () => {
        hexagon.setOptions({ 
            strokeWeight: 1,
            fillOpacity: 0.3 + (tripCount * 0.05)
        });
    });

    return hexagon;
}
// Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ÙÙˆØ±ÙŠØ©
database.ref('rides').on('value', () => {
    drawTripHotspots();
});
    </script>
</body>
</html>