<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<title>نظام التاكسي الذكي</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root {
            --primary-color: #00CED1;
            --secondary-color: #2E2E2E;
            --accent-color: #FFA500;
            --bg-color: #1A1A1A;
        }

        * {
            box-sizing: border-box;
            font-family: 'Tajawal', sans-serif;
            margin: 0;
            padding: 0;
        }

        html, body {
		 	  margin: 0 !important;
             padding: 0 !important;
           overflow: hidden;
             width: 100%;
           height: 100%;
        }

        body {
            background: var(--bg-color);
            color: #FFF;
			    position: fixed;
         top: 0;
          left: 0;
         right: 0;
         bottom: 0;
        }

        .control-panel {
            position: fixed;
            top: 0px;
            left: 0px;
            right: 0px;
            z-index: 1000;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
		    z-index: 1000 !important;
	        flex-direction: row;
            justify-content: space-between;
            align-items: flex-start;
        }

        .input-field {
		
            flex: 1 1 45%;
            margin: 5px;
            min-width: 300px;
		      background: rgba(255, 255, 255, 0.05) !important; /* شفافية 90% */

            border-radius: 8px;
            padding: 15px;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .input-field input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--primary-color);
            border-radius: 6px;
            background: transparent;
            color: #FFF;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }

        .input-field input:focus {
            border-color: var(--accent-color);
			
        }

        .action-buttons {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            gap: 15px;
            background: rgba(46, 46, 46, 0.9);
            padding: 15px;
            border-radius: 8px;
            backdrop-filter: blur(5px);
			z-index: 1000 !important;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            background: var(--primary-color);
            color: var(--secondary-color);
            min-width: 150px;
            font-size: 16px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 206, 209, 0.4);
        }

        #map {
            height: 100vh;
            width: 100%;
		    border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
        }

        .route-info {
            position: fixed;
            top: 120px;
            left: 20px;
            background: rgba(46, 46, 46, 0.9);
            padding: 20px;
            border-radius: 8px;
            z-index: 1000;
            max-width: 300px;
            backdrop-filter: blur(5px);
			    display: none !important; /* إخفاء القسم تمامًا */

        }

        .price-options {
            position: fixed;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: none;
            gap: 20px;
            padding: 20px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
		  background: rgba(10, 10, 10, 0.1) !important;

        }

        .price-option {
            padding: 20px 30px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
		      background: rgba(10, 10, 10, 0.1) !important;

            min-width: 180px;
			
        }
       @media (max-width: 768px) {
         .price-options {
        flex-direction: row; /* عرض الأزرار في صف أفقي مع تمرير */
        flex-wrap: nowrap;
        justify-content: flex-start;
        -webkit-overflow-scrolling: touch; /* تمكين التمرير السلس على الأجهزة اللوحية */
    
		      background: rgba(10, 10, 10, 0.1) !important;
	      width: 90% !important;
        max-width: 320px !important;
        padding: 12px !important;
        bottom: 100px !important;
        gap: 10px !important;
	}
    
    .price-option {
        min-width: 1px;
        margin: 5px 2px;
     min-width: unset !important;
        width: 100% !important;
        padding: 12px 15px !important;
        font-size: 14px !important;
        margin: 0 !important;
		      background: rgba(10, 10, 10, 0.1) !important;
	  }
	  
    }
        .price-option:hover {
            transform: scale(1.05);
        }

        .price-option.selected {
    background: rgba(46, 46, 46, 0.7) !important; /* زيادة الشفافية */
            color: var(--secondary-color);
            box-shadow: 0 4px 15px rgba(0, 206, 209, 0.4);
        
		}

        .booking-details {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -20%);
		      background: rgba(255, 255, 255, 0.05) !important; /* شفافية 90% */
            padding: 10px;
            border-radius: 8px;
            z-index: 2000;
            display: none;
            text-align: center;
            backdrop-filter: blur(15px);
            width: 100%;
            max-width: 90%;
			
        }
		.booking-details h2 {
        font-size: 1.1rem !important;
        margin-bottom: 5px !important;
    }

    .booking-details p {
        font-size: 0.75rem !important;
        margin: 3px 0 !important;
		  margin-bottom: 5px !important;
    padding: 0 !important;
    }

    .payment-options {
        gap: 5px !important;
        margin: 8px 0 !important;
    }

    .payment-option {
        padding: 6px 10px !important;
        font-size: 0.7rem !important;
    }


        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 3000;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--primary-color);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .current-location-btn {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            padding: 5px;
            font-size: 18px;
        }

        .map-select-btn {
            margin-top: 10px;
            width: 100%;
            padding: 8px;
            font-size: 14px;
        }

        .driver-info {
            position: fixed;
            top: auto !important;
		    bottom: 80px;
            left: 15px !important;
            right: auto !important;
            transform: none !important;
            background: rgba(46, 46, 46, 0.9);
			    /* تقليل الحجم */
    width: 200px;
    max-height: 40vh;
    overflow: hidden;
            padding: 20px;
            border-radius: 8px;
            z-index: 1000;
            max-width: 300px;
            backdrop-filter: blur(5px);
            display: none;
		    stroke: #00FF00 !important;
            stroke-opacity: 0.8 !important;
            stroke-width: 6px !important;
            stroke-dasharray: none !important;
           animation: pulse 2s infinite;
		       /* تصميم أكثر شفافية */
    background: rgba(30, 30, 30, 0.92) !important;
    backdrop-filter: blur(8px);
    border: 1px solid rgba(255,255,255,0.1);
        }
        @keyframes pulse {
           0% { stroke-opacity: 0.8; }
           50% { stroke-opacity: 0.4; }
          100% { stroke-opacity: 0.8; }
        }
        .driver-route-line {
            stroke-color: #FF6B6B;
            stroke-opacity: 0.7;
            stroke-weight: 4;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #00CED1;
            color: #2E2E2E;
            padding: 15px 25px;
            border-radius: 8px;
            z-index: 5000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease-out;
            display: none;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
		.persistent-notification {
		    /* تغيير الموضع إلى الزاوية السفلية اليسرى */
    top: auto !important;
    bottom: 80px;
    left: 15px !important;
    right: auto !important;
    transform: none !important;
    
    /* تقليل الحجم */
    width: 200px;
    max-height: 35vh;
    overflow: hidden;
    
    /* تصميم أكثر شفافية */
    background: rgba(1, 1, 1, 0.6) !important; /* شفافية عالية */
    border: 1px solid rgba(255,255,255,0.1);
        position: fixed;
        padding: 20px;
        border-radius: 8px;
        z-index: 1000;
        border: 2px solid var(--primary-color);
        display: none;
         color: #fff;
        top: 20px !important;
        max-width: 200px !important;
        }
		.persistent-notification h3 {
        color: #fff !important;
        margin-bottom: 15px;
        }

       .persistent-notification p {
          margin: 8px 0;
          font-size: 16px;  
        }
		.notification.success {
         background: #4CAF50;
         padding: 20px;
         font-size: 18px;
         display: flex;
         align-items: center;
         width: 350px;
         border-left: 5px solid #45a049;
        }

        .notification-content {
          display: flex;
          flex-direction: column;
          gap: 15px;
          width: 100%;
        }

        .confirm-btn {
          background: rgba(255, 255, 255, 0.9);
          color: #4CAF50;
          padding: 10px 25px;
          border-radius: 8px;
          font-weight: bold;
          transition: all 0.3s;
          align-self: flex-end;
        }

        .confirm-btn:hover {
           background: #fff;
           transform: translateY(-2px);
           box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
	    .end-notification {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(46, 46, 46, 0.95);
        padding: 40px 60px;
        border-radius: 15px;
        text-align: center;
        z-index: 10000;
        border: 3px solid #00CED1;
        box-shadow: 0 8px 30px rgba(0,0,0,0.5);
        color: #FFF;
        }

        .end-notification h2 {
        color: #00CED1;
        margin-bottom: 20px;
        font-size: 28px;
        }

        .end-notification .price {
        font-size: 24px;
        margin: 20px 0;
        }
		/* داخل الـ media query للشاشات الصغيرة */
@media (max-width: 768px) {
    .profile-btn {
        position: fixed !important;
        bottom: 20px !important;
        left: 15px !important;
        right: auto !important;
        top: auto !important;
        transform: none !important;
        margin: 0 !important;
        z-index: 1001 !important;
        padding: 12px 20px !important;
        width: auto !important;
        background: var(--primary-color) !important;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3) !important;
    }

    .profile-btn .profile-text {
        font-size: 14px !important;
    }

    .profile-btn i {
        font-size: 14px !important;
        margin-right: 5px !important;
    }

    /* منع تداخل مع الأزرار الأخرى */
    .action-buttons {
        left: 50% !important;
        transform: translateX(-50%) !important;
        width: 90% !important;
        bottom: 80px !important; /* زيادة البعد عن الأسفل */
    }
}
		@media (max-width: 768px) {
           .control-panel {
        flex-direction: row !important;
        flex-wrap: nowrap !important;
        gap: 0 !important;
        padding: 0 !important;
    }

.map-select-btn {
    margin-top: 8px;
    padding: 8px;
    font-size: 10px;
}
      /* تعديل حقلي الإدخال */
    .input-field {
	
        flex: 1 !important;
        min-width: 20% !important;
        margin: 0 !important;
        border-radius: 0 !important;
        padding: 3px !important;
    }
	

    
        .action-buttons {
          bottom: 20px;
          padding: 10px;
		  
		      background: rgba(255, 255, 255, 0.05) !important; /* شفافية 90% */
        }
    
        .btn {
          padding: 10px 20px;
          min-width: 120px;
		  
        }
    }
		
    .payment-options {
       display: flex;
      gap: 15px;
      margin: 20px 0;
      flex-direction: column;
    }

    .payment-option {
      padding: 15px;
     border-radius: 8px;
     cursor: pointer;
     transition: all 0.3s;
     background: rgba(255, 255, 255, 0.1);
     border: 2px solid transparent;
    }

    .payment-option.selected {
      background: var(--primary-color);
      color: var(--secondary-color);
      border-color: var(--accent-color);
    }

    .payment-option:hover {
      transform: scale(1.02);
    }
@media (max-width: 768px) {
    .driver-info, .persistent-notification {
        /* تقليل الحجم العام */
        width: 60%;
        max-width: 150px;
        padding: 5px;
        
        /* تعديل الخطوط */
        font-size: 0.6rem;
        
        /* تقليل الهوامش */
        margin: 5px;
        top: 5px !important;
        
        /* إخفاء العناصر غير الضرورية */
        .extra-details {
            display: none;
        }
    }
    
    /* عناوين الرسائل */
    .driver-info h3, .persistent-notification h3 {
        font-size: 1rem;
        margin-bottom: 8px;
    }
    
    /* محتوى النصوص */
    .driver-info p, .persistent-notification p {
        margin: 8px 0;
    }
    
    /* الأزرار */
    .close-btn, .toggle-info-btn {
        padding: 8px 12px;
        font-size: 0.85rem;
    }
    
    /* أيقونات الأزرار */
    .toggle-info-btn i {
        font-size: 14px;
    }
}
    #confirmBookingButton {
      display: none;
      margin-top: 20px; 
    
    }
	.actual-route {
    stroke-color: #00CED1 !important;
    stroke-opacity: 0.8 !important;
    stroke-weight: 6 !important;
    stroke-dasharray: none !important;
     }
	
	/* ======= زر البروفيل ======= */
.profile-btn {
  /* أضف خلفية شفافة أو لون ثابت */
  background: var(--primary-color);      /* أو أي لون تفضله */
  border: 2px solid var(--accent-color); /* سمك الإطار ولونه */
  border-radius: 30px;                   /* نصف قطر الانحناء */
  padding: 12px 28px;                    /* الارتفاع والعرض الداخلي */
  font-size: 18px;                       /* حجم الخط */
  color: var(--secondary-color);         /* لون النص */
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.3s;
}
.profile-btn:hover {
  background: var(--accent-color);
  color: #FFF;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}
.profile-btn .fa-chevron-left {
  font-size: 16px;    /* حجم الأيقونة */
  transition: transform 0.3s;
}
.profile-btn:hover .fa-chevron-left {
  transform: translateX(-4px);
}

.marker-label {
    background: rgba(0, 206, 209, 0.9);
    padding: 2px 8px;
    border-radius: 15px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
}
@media (max-width: 768px) {
    .booking-details p,
    .booking-details .vehicle-type,
    .booking-details .total-price {
        line-height: 0.7 !important;
        margin: 2px 0 !important;
    }
}

    </style>
</head>
<body>
     <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <div class="control-panel">
	<div class="control-panel">
    <div class="user-controls">
       <button class="profile-btn" onclick="window.location.href='profile.html'">
    <span class="profile-text">البروفيل</span>
    <i class="fas fa-chevron-left"></i> <!-- سهم للأنيميشن -->
</button>
    </div>
        <div class="input-field">
            <div style="position: relative;">
                <input type="text" id="origin" placeholder="📍 الموقع الحالي">
                <button class="current-location-btn" onclick="getCurrentLocation()">📍</button>
            </div>
            <button class="btn map-select-btn" onclick="setSelectionMode('start')">اختر نقطة البداية من الخريطة</button>
        </div>
        <div class="input-field">
            <input type="text" id="destination" placeholder="🏁 الوجهة النهائية">
            <button class="btn map-select-btn" onclick="setSelectionMode('end')">اختر نقطة النهاية من الخريطة</button>
        </div>
    </div>

    <div class="action-buttons">
        <button class="btn" onclick="calculateRoute()">عرض السعر</button>
        <button class="btn" onclick="clearAll()">مسح الكل</button>
	    <button class="btn" id="confirmRideBtn" style="display:none;" onclick="confirmRide()">تأكيد الرحلة</button>

    </div>

    <div class="route-info" id="routeInfo"></div>
    <div class="price-options" id="priceOptions">
        <div class="price-option" onclick="selectVehicle('normal', 5)">
            <h3>🚗 عادية</h3>
            <p>5 جنيه/كم</p>
        </div>
        <div class="price-option" onclick="selectVehicle('luxury', 10)">
            <h3>🚕 فاخرة</h3>
            <p>10 جنيه/كم</p>
        </div>
        <div class="price-option" onclick="selectVehicle('helicopter', 3)">
            <h3>🚁 طائرة</h3>
            <p>3 جنيه/كم</p>
        </div>
    </div>

    <div id="map"></div>

    <div class="booking-details" id="bookingDetails">
        <h2 style="margin-bottom: 20px;">تفاصيل الرحلة</h2>
        <div id="priceDisplay" style="font-size: 18px;"></div>
		    <div class="payment-options" id="paymentOptions">
        <div class="payment-option" onclick="selectPayment('electronic', event)">
            <h3>💳 الدفع الإلكتروني مع الكابتن</h3>
            <p>تأكيد فوري عبر المحفظة الإلكترونية</p>
        </div>
        <div class="payment-option" onclick="selectPayment('cash', event)">
            <h3>💵 الدفع نقدي</h3>
            <p>الدفع مباشرة للسائق نقداً عند الوصول</p>
        </div>
    </div>
  <button class="btn" id="confirmBookingButton" onclick="confirmTrip()" style="margin-top: 25px; width: 100%;">
    تأكيد الحجز الآن
  </button>
    </div>

    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
        <p style="margin-top: 20px; color: var(--primary-color);">جاري البحث ...</p>
    </div>

    <div class="driver-info" id="driverInfo">
        <h3>معلومات السائق</h3>
        <p id="driverName">الاسم: -</p>
        <p id="driverCar">السيارة: -</p>
        <p id="driverPhone">الهاتف: -</p>
	</div>

<!-- أضف هذا الجزء تحت عنصر driver-info -->
    <div class="persistent-notification" id="persistentNotification">
      <h3>حالة الرحلة</h3>
      <div id="tripStatusContent"></div>
       <button class="btn" onclick="clearAll()" style="margin-top:15px;">إلغاء الرحلة</button>
    </div>		
    <div id="arrivalNotification" class="notification" style="display: none;">
    <div class="notification-content">
        <span>🎉 تم وصول السائق إلى نقطة البداية!</span>
	    <div id="driverArrivalInfo"></div>
        <button class="btn confirm-btn" onclick="handleArrivalConfirmation()">موافق</button>
    </div>
	
    <audio id="notificationSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" loop></audio>
    </div>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAeQx0Ke798anRT_6xAwB-ViewDVb8Jq0U&libraries=places,geometry&callback=initMap" async defer></script>    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCAwPCVPaxoTEV4n4APATlIKh3ppjMeZpk",
            authDomain: "data-c4c20.firebaseapp.com",
            databaseURL: "https://data-c4c20-default-rtdb.firebaseio.com",
            projectId: "data-c4c20",
            storageBucket: "data-c4c20.firebasestorage.app",
            messagingSenderId: "905131784305",
            appId: "1:905131784305:web:440e06647294b0d5e543d0"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let map, directionsService, driverDirectionsRenderer, directionsRenderer;
        let startMarker, endMarker, currentLocationMarker, driverMarker;
        let selectedVehicle = null;
        let currentPricePerKm = 0;
        let totalDistance = 0;
        let selectionMode = null;
        let geocoder;
        let currentLocationCoords = null;
        let tripListener = null;
        let driverLocationListener = null;
        let driverRoutePolyline = null;
        let destinationMarker;
        let arrivalSound = null; // متغير لتتبع حالة الصوت
        let driverPathCoordinates = [];
        let driverPathPolyline = null;
		let currentTripId = localStorage.getItem('currentTripId') || null;
        let selectedPayment = null;
       let mapInitialized = false;
// التحقق من تسجيل الدخول عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', () => {
            const isLoggedIn = localStorage.getItem('isLoggedIn');
          const userId = localStorage.getItem('userId');
    
             if (!isLoggedIn || !userId) {
              window.location.href = 'login.html';
             } else {
                  console.log('User ID on map page:', userId); // للتأكد من وجود القيمة
            }
        });


	   function initMap() {

                    // الخلفية العامة
        const professionalMapStyle = [
        {
             "elementType": "geometry",
             "stylers": [{ "color": "#1d2c4d" }]
        },
        {
          "elementType": "labels.text.fill",
          "stylers": [{ "color": "#8ec3b9" }]
        },
        {
          "elementType": "labels.text.stroke",
          "stylers": [{ "color": "#1a3646" }]
        },
        {
          "featureType": "administrative",
          "elementType": "geometry",
          "stylers": [{ "visibility": "off" }]
        },
        {
           "featureType": "poi",
           "stylers": [{ "visibility": "off" }]
        },
        {
          "featureType": "road",
          "elementType": "geometry",
          "stylers": [
             { "color": "#304a7d" },
            { "weight": 1.6 }
          ]
        },
        {
          "featureType": "road",
          "elementType": "labels.icon",
          "stylers": [{ "visibility": "off" }]
        },
        {
          "featureType": "transit",
          "stylers": [{ "visibility": "off" }]
        },
        {
          "featureType": "water",
          "elementType": "geometry",
          "stylers": [{ "color": "#17263c" }]
        }
        ];
    // إخفاء العناصر غير المرغوبة
                     document.getElementById('routeInfo').style.display = 'none';

            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 30.0444, lng: 31.2357 },
                zoom: 15,
			    styles: professionalMapStyle,
                disableDefaultUI: true,
                mapTypeControlOptions: {
                mapTypeIds: [] // إخفاء خيارات أنواع الخرائط
                },
                gestureHandling: "greedy"
            });

            geocoder = new google.maps.Geocoder();
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                suppressMarkers: true,
                polylineOptions: {
                    strokeColor: "#FF00FF",
                    strokeOpacity: 0.8,
                    strokeWeight: 5,
					zIndex: 999
                },
				    preserveViewport: false // السماح بضبط الخريطة تلقائيًا
            });
                driverDirectionsRenderer = new google.maps.DirectionsRenderer({
                suppressMarkers: true,
                polylineOptions: {
                 strokeColor: "#FFA500",
                  strokeOpacity: 0.8,
                  strokeWeight: 7
                }
               });
                
            // إنشاء علامة النهاية مع إعدادات متقدمة
startMarker  = new google.maps.Marker({
    icon: {
        url: 'https://cdn-icons-png.flaticon.com/512/149/149068.png',
        scaledSize: new google.maps.Size(35, 35),
        anchor: new google.maps.Point(17, 35),
        labelOrigin: new google.maps.Point(20, -10)
    },
    label: {
        color: '#fff',
        fontSize: '59px',
        fontWeight: 'bold',
        className: 'marker-label'
    },
    zIndex: 999
});

            endMarker = new google.maps.Marker({
                icon: {
                    url: 'https://cdn-icons-png.flaticon.com/512/149/149060.png',
                    scaledSize: new google.maps.Size(40, 40)
                }
            });
			    mapInitialized = true;

			// في نهاية دالة initMap بعد إنشاء الخريطة
                const originInput = document.getElementById('origin') ;
                const destinationInput = document.getElementById('destination');

// تهيئة خدمة الـ Autocomplete
                const autocompleteOptions = {
                      componentRestrictions: { country: "eg" }, // مصر
                      fields: ["formatted_address", "geometry"],
                       types: ["geocode"]
                    };
                const trafficLayer = new google.maps.TrafficLayer();
                   trafficLayer.setMap(map);

// تحديث كل دقيقة
                  setInterval(() => {
                  trafficLayer.setMap(null);
                  trafficLayer.setMap(map);
                }, 60000);
                    const originAutocomplete = new google.maps.places.Autocomplete(originInput, autocompleteOptions);
                    const destinationAutocomplete = new google.maps.places.Autocomplete(destinationInput, autocompleteOptions);

// ربط الأحداث
                    originAutocomplete.addListener('place_changed', () => {
                    const place = originAutocomplete.getPlace();
                    if (place.geometry) {
					        currentLocationCoords = null; // Reset current location if manual address selected
                    startMarker.setPosition(place.geometry.location);
                     startMarker.setMap(map);
                    map.panTo(place.geometry.location);
                    }
                   });

                  destinationAutocomplete.addListener('place_changed', () => {
                  const place = destinationAutocomplete.getPlace();
                  if (place.geometry) {
                  endMarker.setPosition(place.geometry.location);
                  endMarker.setMap(map);
                  map.panTo(place.geometry.location);
                }
                });
				map.addListener('click', (e) => {
                    if (selectionMode) {
                     handleMapClick(e.latLng);
                }
                });
				window.addEventListener('load', () => {
                   restorePreviousTrip();
                });
				// بعد initMap()
                 if (currentTripId) { 
                setupTripListener();
                  restoreTripState();
                }
				 mapInitialized = true;
                 restorePreviousTrip();
                // بعد تهيئة الخريطة
    drawTripHotspots();
    
    // مراقبة التغييرات في الرحلات
    database.ref('rides').on('value', () => {
        drawTripHotspots();
    });
}
			
			// في بداية ملف الخريطة

      function handleMapClick(latLng) {
    geocoder.geocode({ location: latLng }, (results, status) => {
        if (status === 'OK' && results[0]) { // تغيير 'ok' إلى 'OK'
            const address = results[0].formatted_address;
            
            if (selectionMode === 'start') {
                document.getElementById('origin').value = address;
                startMarker.setPosition(latLng);
                startMarker.setMap(map);
                startMarker.setVisible(true); // جعل العلامة مرئية
                map.panTo(latLng);
            } else {
                document.getElementById('destination').value = address;
                endMarker.setPosition(latLng);
                endMarker.setMap(map);
                endMarker.setVisible(true); // جعل العلامة مرئية
                map.panTo(latLng);
            }
            
            // إضافة تأثير مرئي
            const tempCircle = new google.maps.Circle({
                strokeColor: '#FF0000',
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: '#FF0000',
                fillOpacity: 0.35,
                map: map,
                center: latLng,
                radius: 20,
                zIndex: 999
            });
            
            setTimeout(() => tempCircle.setMap(null), 500);
            
            selectionMode = null;
            showNotification('تم تحديد الموقع بنجاح!', false);
        } else {
            showNotification('تعذر العثور على عنوان لهذا الموقع', true);
        }
    });
}
		 function confirmRide() {
              document.getElementById('persistentNotification').style.display = 'none';
              clearAll();
              showNotification('تم تأكيد الرحلة بنجاح!');
         }
        function getCurrentLocation() {
    return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
            reject('المتصفح لا يدعم خدمة الموقع');
            return;
        }

        showLoading(true);
        
        navigator.geolocation.getCurrentPosition(
            async (position) => {
                try {
                    currentLocationCoords = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    // تحديث واجهة المستخدم أولاً
                    startMarker.setPosition(currentLocationCoords);
                    startMarker.setMap(map);
                    map.panTo(currentLocationCoords);

                    // الحصول على العنوان
                    const results = await new Promise((resolve, reject) => {
                        geocoder.geocode({ location: currentLocationCoords }, (results, status) => {
                            if (status === 'OK') resolve(results);
                            else reject(status);
                        });
                    });

                    document.getElementById('origin').value = results[0]?.formatted_address || "الموقع الحالي";
                    resolve(currentLocationCoords);

                } catch (error) {
                    console.error('Geocoding error:', error);
                    document.getElementById('origin').value = "الموقع الحالي";
                    showNotification('تم تحديد الموقع بالإحداثيات الجغرافية', false);
                    resolve(currentLocationCoords);
                } finally {
                    showLoading(false);
                }
            },
            (error) => {
                showLoading(false);
                handleGeolocationError(error);
                reject(error);
            },
            {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            }
        );
    });
}

        function setSelectionMode(mode) {
            selectionMode = mode;
            showNotification(`الرجاء النقر على الخريطة لاختيار نقطة ${mode === 'start' ? 'البداية' : 'النهاية'}`);
        }

        async function calculateRoute() {
		 document.querySelector('.profile-btn').style.display = 'none';

    let origin = document.getElementById('origin').value;
    const destination = document.getElementById('destination').value;

    if ((!origin && !currentLocationCoords) || !destination) {
        showNotification('الرجاء تحديد نقطتي البداية والنهاية', true);
        return;
    }

    showLoading(true);

    try {
        let originLocation;
        
        // تحديد مصدر الإحداثيات
        if (currentLocationCoords) {
            originLocation = new google.maps.LatLng(
                currentLocationCoords.lat,
                currentLocationCoords.lng
            );
        } else {
            // جيوكود للعنوان اليدوي
            const geocodeResult = await new Promise((resolve, reject) => {
                geocoder.geocode({ address: origin }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        resolve(results[0].geometry.location);
                    } else {
                        reject('فشل في تحديد موقع البداية');
                    }
                });
            });
            originLocation = geocodeResult;
        }

        // جيوكود للنهاية
        const destinationResult = await new Promise((resolve, reject) => {
            geocoder.geocode({ address: destination }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    resolve(results[0].geometry.location);
                } else {
                    reject('فشل في تحديد موقع النهاية');
                }
            });
        });

        const request = {
            origin: originLocation,
            destination: destinationResult,
            travelMode: 'DRIVING'
        };

        const response = await directionsService.route(request);
        
        // عرض النتائج
        directionsRenderer.setMap(map);
        directionsRenderer.setDirections(response);
        
        // حساب المسافة والسعر
        const route = response.routes[0].legs[0];
        totalDistance = route.distance.value / 1000;
        
        // عرض خيارات السعر
        document.getElementById('priceOptions').style.display = 'flex';
        document.querySelectorAll('.input-field').forEach(field => {
            field.style.display = 'none';
        });

        // تحديث واجهة المستخدم
        map.fitBounds(response.routes[0].bounds);
        startMarker.setPosition(originLocation);
        endMarker.setPosition(destinationResult);

    } catch (error) {
        console.error('Error:', error);
        showNotification('فشل في حساب المسار: ' + error.message, true);
    } finally {
        showLoading(false);
    }
}

        function selectVehicle(type, price) {
            selectedVehicle = type;
            currentPricePerKm = price;
            
            document.querySelectorAll('.price-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            showBookingDetails();
        }

        function showBookingDetails() {
            const totalPrice = (totalDistance * currentPricePerKm).toFixed(2);
            document.getElementById('priceDisplay').innerHTML = `
                <p>نوع الخدمة: <strong>${getVehicleName(selectedVehicle)}</strong></p>
                <h3 style="color: var(--primary-color); margin: 20px 0;">
                    السعر الإجمالي: ${totalPrice} جنيه
                </h3>
            `;
              document.getElementById('bookingDetails').style.display = 'block';
              document.getElementById('priceOptions').style.display = 'none';
            // إعادة تعيين خيارات الدفع
             document.querySelectorAll('.payment-option').forEach(option => {
             option.classList.remove('selected');
          });
          document.getElementById('confirmBookingButton').style.display = 'none';
          selectedPayment = null;
		       document.querySelector('.profile-btn').style.display = 'none';
		}

        async function confirmTrip() {
		
            if (!selectedVehicle) {
                showNotification('الرجاء اختيار نوع الخدمة أولاً', true);
                return;
            }
		    if (!selectedPayment) {
               showNotification('الرجاء اختيار طريقة الدفع', true);
              return;
            }
            const userId = localStorage.getItem('userId');
               if (!userId) {
                  alert('يجب تسجيل الدخول أولاً');
                 window.location.href = 'login.html';
            }

            showLoading(true);
        // إخفاء العناصر هنا
		     document.querySelector('.profile-btn').style.display = 'none';
              document.querySelector('.action-buttons').style.display = 'none';
			  document.getElementById('map').style.display = 'block'; // إضافة هذا السطر
			  document.querySelector('.input-field').style.display = 'none';
             document.getElementById('origin').parentNode.style.display = 'none';
             document.getElementById('destination').parentNode.style.display = 'none';
                   document.getElementById('persistentNotification').style.display = 'block';
            const tripData = {
                start: document.getElementById('origin').value,
			    userId: userId, // تم إضافة معرف المستخدم هنا
                end: document.getElementById('destination').value,
                vehicleType: selectedVehicle,
                price: (totalDistance * currentPricePerKm).toFixed(2),
                distance: totalDistance,
                status: "new",
    	        paymentMethod: selectedPayment, // إضافة طريقة الدفع
                startLocation: startMarker.getPosition().toJSON(),
				endLocation: endMarker.getPosition().toJSON(), // إضافة هذا السطر
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            try {
                let newTripRef = database.ref(`rides/${userId}`).push();
                await newTripRef.set(tripData);
                currentTripId = newTripRef.key;
                localStorage.setItem('currentTripId', currentTripId); // التحديث هنا

                setupTripListener();
                showNotification('جاري البحث عن سائق...');
                 document.querySelector('.profile-btn').style.display = 'none';
                document.getElementById('bookingDetails').style.display = 'none';

            } catch (error) {
                showNotification('حدث خطأ في تأكيد الرحلة', true);
                console.error('Error confirming trip:', error);
            } finally {
                showLoading(false);
            }
        }

// دالة مسح العناصر
function clearMapElements() {
    if (directionsRenderer) directionsRenderer.setMap(null);
    if (driverDirectionsRenderer) driverDirectionsRenderer.setMap(null);
    if (startMarker) startMarker.setMap(null);
    if (endMarker) endMarker.setMap(null);
    if (driverMarker) driverMarker.setMap(null);
    if (driverRoutePolyline) driverRoutePolyline.setMap(null);
}
// أضف هذا الكود في بداية ملف script الخاص بك
let wakeLock = null;

// دالة لتفعيل منع قفل الشاشة
async function enableWakeLock() {
    try {
        if ('wakeLock' in navigator) {
            wakeLock = await navigator.wakeLock.request('screen');
            
            // إعادة تفعيل عند استعادة الاتصال
            document.addEventListener('visibilitychange', async () => {
                if (wakeLock !== null && document.visibilityState === 'visible') {
                    await enableWakeLock();
                }
            });
            
            console.log('Screen Wake Lock activated!');
        }
    } catch (err) {
        console.error('Error enabling wake lock:', err);
    }
}

// تشغيل المنع عند تحميل الصفحة
window.addEventListener('load', () => {
    enableWakeLock();
    
    // تفعيل إضافي عند أي تفاعل مستخدم
    document.addEventListener('click', enableWakeLock);
    document.addEventListener('touchstart', enableWakeLock);
    document.addEventListener('keydown', enableWakeWakeLock);
});

// Optional: إيقاف المنع عند إغلاق الصفحة
window.addEventListener('beforeunload', () => {
    if (wakeLock) {
        wakeLock.release();
        wakeLock = null;
    }
});
        function setupTripListener() {
          const userId = localStorage.getItem('userId');
          const tripRef = database.ref(`rides/${userId}/${currentTripId}`);       
             tripListener = tripRef.on('value', async (snapshot) => {
             const tripData = snapshot.val();
			  // إذا تم حذف الرحلة من قاعدة البيانات
               if (!tripData) {
                 localStorage.removeItem('currentTripId');
                 currentTripId = null;
                 clearAll();
                 return;
                }
				
				
             if (!tripData) return;
			 if (tripData.status === "com") {
			    document.getElementById('persistentNotification').style.display = 'nono';
				     document.querySelector('.profile-btn').style.display = 'none';
			       clearDriverTracking();
				       if (startMarker) startMarker.setMap(null);
                     if (endMarker) endMarker.setMap(null);
                    if (directionsRenderer) directionsRenderer.setMap(null);
    
    //   تكبي ر الخريطة على نقطة البداية
                      const startLatLng = new google.maps.LatLng(
                      tripData.startLocation.lat,
                      tripData.startLocation.lng
                   );
     
                       map.setCenter(startLatLng);
                       map.setZoom(18); // مستوى التكبير المطلوب
    
  const driverId = tripData.driverId;
  const driverLocationRef = database.ref(`drives/${driverId}/location`);

  // متغير لتخزين ماركَر السائق
  let driverMarker = null;

  // استمع لكل تغيير في موقع السائق
  driverLocationRef.on('value', (snapshot) => {
    const loc = snapshot.val();
    if (!loc) return;

    const pos = new google.maps.LatLng(loc.lat, loc.lng);

    if (!driverMarker) {
      // إنشاء ماركَر أول مرة
      driverMarker = new google.maps.Marker({
        position: pos,
        map: map,
        icon: {
          url: "https://maps.gstatic.com/mapfiles/kml/shapes/cabs.png",
          scaledSize: new google.maps.Size(40, 40),
          anchor: new google.maps.Point(20, 20),
        },
        title: 'موقع السائق الحالي'
      });
    } else {
      // فقط حدّث الموقع
      driverMarker.setPosition(pos);
    }

    // اختياري: تحريك مركز الخريطة ليناسب الماركَر
    // map.panTo(pos);
  });

                   showArrivalNotification(tripData.driverId); // <-- هنا تم إصلاح الخطأ
				   document.querySelector('.action-buttons').style.display = 'none';
      			  document.getElementById('map').style.display = 'block'; // إضافة هذا السطر
       			  document.querySelector('.input-field').style.display = 'none';
                  document.getElementById('origin').parentNode.style.display = 'none';
                   document.getElementById('destination').parentNode.style.display = 'none';
                     document.querySelector('.profile-btn').style.display = 'none';
                    return;
                }
                if (tripData.status === "end") {
				    cleanGhostMapElements();
				    // مسح علامة السائق والمسارات
    if (driverMarker) {
        driverMarker.setMap(null);
        driverMarker = null;
    }
    if (driverDirectionsRenderer) {
        driverDirectionsRenderer.setMap(null);
        driverDirectionsRenderer = null;
    }
    if (driverRoutePolyline) {
        driverRoutePolyline.setMap(null);
        driverRoutePolyline = null;
    }
    
				     document.querySelector('.profile-btn').style.display = 'none';
		            document.getElementById('map').style.display = 'none';
                    document.querySelector('.control-panel').style.display = 'none';
                    document.querySelector('.action-buttons').style.display = 'none';
                    document.getElementById('routeInfo').style.display = 'none';
                    document.getElementById('persistentNotification').style.display = 'none';
                   showEndNotification(tripData.price);
            // إيقاف جميع المستمعين
                   tripRef.off('value', tripListener);
                if (driverLocationListener) {
                   database.ref(`drives/${tripData.driverId}/location`).off('value', driverLocationListener);
                }
                     return;
                }
				        // إضافة حالة ready هنا
                if (tripData.status === "ready") {
				    cleanGhostMapElements();
				     document.querySelector('.profile-btn').style.display = 'none';
                    clearMapElements();				
			       clearDriverTracking();
				  if (startMarker) startMarker.setMap(null);
                     if (endMarker) endMarker.setMap(null);
                    if (directionsRenderer) directionsRenderer.setMap(null);
    
				  document.querySelector('.action-buttons').style.display = 'none';
      			  document.getElementById('map').style.display = 'block'; // إضافة هذا السطر
       			  document.querySelector('.input-field').style.display = 'none';
                  document.getElementById('origin').parentNode.style.display = 'none';
                   document.getElementById('destination').parentNode.style.display = 'none';
                   document.getElementById('persistentNotification').style.display = 'nono';

					    trackDriverToDestination(
                        tripData.driverId,
                         tripData.endLocation
                        );
            				          
   // تحديث الإشعار الدائم
    document.getElementById('persistentNotification').style.display = 'nono';
    document.getElementById('tripStatusContent').innerHTML = `
        <h3>جاهز للانطلاق!</h3>
        <p>تم تحديث المسار حسب الموقع الحالي للسائق</p>
        <p>جاري التوجه إلى الوجهة النهائية</p>
    `;
    
						    // تحديث مركز الخريطة
                  const bounds = new google.maps.LatLngBounds();
                   bounds.extend(tripData.startLocation);
                   bounds.extend(tripData.endLocation);
                   map.fitBounds(bounds, {padding: 100});
                }

             if (tripData.status === "accepted" && tripData.driverId) {
                try {
                // إخفاء العناصر القديمة
                   directionsRenderer.setMap(null);
                   startMarker.setMap(map);
                   endMarker.setMap(null);
                  
				  
				  startMarker.setPosition(tripData.startLocation); // تحديث الإحداثيات
				       document.querySelector('.profile-btn').style.display = 'none';
                // إخفاء عناصر الواجهة
                   document.querySelector('.action-buttons').style.display = 'none';
			       document.getElementById('map').style.display = 'block'; // إضافة هذا السطر
		   	       document.querySelector('.input-field').style.display = 'none';
                   document.getElementById('origin').parentNode.style.display = 'none';
                  document.getElementById('destination').parentNode.style.display = 'none';
                 // جلب بيانات السائق 
                   const driverSnapshot = await database.ref(`drives/${tripData.driverId}`).once('value');
                   const driverData = driverSnapshot.val();
                // عرض البيانات في منطقة الإشعارات الدائمة
                   document.getElementById('persistentNotification').style.display = 'block';
                   document.getElementById('tripStatusContent').innerHTML = `
                      <p>الاسم: ${driverData.fullName}</p>
                      <p>السيارة: ${driverData.carModel}</p>
                      <p>الهاتف: ${driverData.phoneNumber}</p>
				      <p>طريقة الدفع: ${tripData.paymentMethod === 'electronic' ? 'إلكتروني' : 'نقدي'}</p>
                      <div id="distanceInfo">جاري حساب المسافة...</div>
                   `;

                // بدء تتبع الموقع
                trackDriverLocation(tripData.driverId, tripData.startLocation);
                   document.getElementById('persistentNotification').style.display = 'block';

                } catch (error) {
                   console.error('Error:', error);
              }
            }
          });   
        }
		async function trackDriverToDestination(driverId, endLocation) {
    // إزالة أي مسارات سابقة
    if (directionsRenderer) {
        directionsRenderer.setMap(null);
    }
        if (driverMarker) {
        driverMarker.setMap(null);
        driverMarker = null;
    }

    // إنشاء renderer جديد
    directionsRenderer = new google.maps.DirectionsRenderer({
        suppressMarkers: true,
        polylineOptions: {
            strokeColor: "#4285F4",
            strokeOpacity: 0.9,
            strokeWeight: 7
        }
    });
    
    // متابعة تحديثات موقع السائق
    const driverRef = database.ref(`drives/${driverId}/location`);
    driverRef.on('value', async (snapshot) => {
        const driverLoc = snapshot.val();
        if (!driverLoc) return;
        
        try {
            // تحديث المسار من الموقع الحالي إلى النهاية
            const request = {
                origin: new google.maps.LatLng(driverLoc.lat, driverLoc.lng),
                destination: endLocation,
                travelMode: 'DRIVING'
            };
            
            const response = await directionsService.route(request);
            
            // تحديث العلامات
            if (driverMarker) driverMarker.setMap(null);
              if (directionsRenderer) {
    directionsRenderer.setMap(null);
  }
  if (endMarker) {
    endMarker.setMap(null);
  }

  // إنشاء renderer جديد
  directionsRenderer = new google.maps.DirectionsRenderer({
    suppressMarkers: true,
    polylineOptions: {
      strokeColor: "#4285F4",
      strokeOpacity: 0.9,
      strokeWeight: 7
    }
  });
            driverMarker = new google.maps.Marker({
                position: request.origin,
                map: map,
                icon: {
                    url: 'https://maps.gstatic.com/mapfiles/kml/shapes/cabs.png',
                    scaledSize: new google.maps.Size(40, 40)
                }
            });
            
            // عرض المسار المحدث
            directionsRenderer.setOptions({
                map: map,
                directions: response
            });
			      endMarker = new google.maps.Marker({
        position: endLocation,
        map: map,
        title: 'نقطة الوصول',
        icon: {
          url: 'https://cdn-icons-png.flaticon.com/512/149/149068.png',
          // يمكنك تغيير الأيقونة لأي صورة تريدها
          scaledSize: new google.maps.Size(30, 30)
        }
      });

            
                 // ضبط حدود الخريطة لتشمل الأصل والنهاية
      const bounds = new google.maps.LatLngBounds();
      bounds.extend(originLatLng);
      bounds.extend(endLocation);
// 1. استخدام maxZoom مباشرة:
map.fitBounds(bounds, {
  padding: 100,
  maxZoom: 100   // حدد أقصى مستوى زوم تريده
});

// 2. أو استخدام setTimeout لضمان أن fitBounds انتهت:
map.fitBounds(bounds, { padding: 100 });
setTimeout(() => {
  // اجعل الزوم يصل إلى القيمة التي تريدها
  map.setZoom(100);
}, 500);
      
        } catch (error) {
            console.error('خطأ في تحديث المسار:', error);
        }
    });
}
        function showDriverRealTimeLocation(driverId) {
    // إزالة أي مستمع سابق
            if (driverLocationListener) {
                 database.ref(`drives/${driverId}/location`).off('value', driverLocationListener);
            }

            const carIcon = {
                  url: "https://cdn-icons-png.flaticon.com/512/744/744515.png",
                  scaledSize: new google.maps.Size(40, 40),
                  anchor: new google.maps.Point(20, 20)
            };

            driverLocationListener = database.ref(`drives/${driverId}/location`).on('value', (snapshot) => {
               const driverLocation = snapshot.val();
            if (!driverLocation) return;

            const driverPos = new google.maps.LatLng(
                driverLocation.latitude,
                driverLocation.longitude
            );

            if (!driverMarker) {
               driverMarker = new google.maps.Marker({
                  position: driverPos,
                  map: map,
                  icon: carIcon,
                  title: 'الموقع الحالي للسائق',
                  animation: google.maps.Animation.BOUNCE
                });
            } else {
               driverMarker.setPosition(driverPos);
            }

             map.panTo(driverPos);
             map.setZoom(17);
            });
        }

    async function trackDriverLocation(driverId, startLocation) {
  console.log("[Checkpoint 6] تتبع موقع السائق - معرف السائق:", driverId);
const carIcon = {
  url: "https://maps.gstatic.com/mapfiles/kml/shapes/cabs.png",  // أيقونة السيارة من Google
  scaledSize: new google.maps.Size(40, 40),                       // اضبط الحجم بما يناسبك
  anchor:    new google.maps.Point(24, 24)                        // تثبيت منتصف الأيقونة
};

  // تحقق من صحة الإحداثيات
  if (!startLocation || isNaN(startLocation.lat) || isNaN(startLocation.lng)) {
    console.error("[Error] إحداثيات البداية غير صالحة:", startLocation);
    return;
  }
  
  const startPos = new google.maps.LatLng(startLocation.lat, startLocation.lng);
  console.log("[Checkpoint 7] موقع البداية (العميل):", startPos.toString());
  
  const driverRef = database.ref(`drives/${driverId}/location`);
  console.log("[Checkpoint 8] الاشتراك في تحديثات موقع السائق");
  
  driverRef.on('value', async (snapshot) => {
    const driverLocation = snapshot.val();
    if (!driverLocation) {
      console.warn("[Warning] موقع السائق غير متوفر حاليًا");
      return;
    }
    
    console.log("[Checkpoint 9] بيانات الموقع الواردة من السائق:", driverLocation);
    
    // تحقق من صحة بيانات الموقع
    if (!driverLocation.lat || !driverLocation.lng) {
      console.error("[Error] إحداثيات السائق غير صالحة");
      return;
    }
    
    const driverPos = new google.maps.LatLng(
      Number(driverLocation.lat),
      Number(driverLocation.lng)
    );
            // إنشاء/تحديث علامة السائق
        if (!driverMarker) {
            driverMarker = new google.maps.Marker({
                position: driverPos,
                map: map, // التأكيد على إرفاق العلامة بالخريطة
                icon: carIcon,
                title: 'الموقع الحالي للسائق',
                animation: google.maps.Animation.BOUNCE,
                zIndex: 9999
            });
            console.log('[تتبع السائق] تم إنشاء علامة السائق الجديدة');
        } else {
            driverMarker.setPosition(driverPos);
        }
    console.log("[Checkpoint 10] الموقع الحالي للسائق:", driverPos.toString());
          // تحديث مركز الخريطة ليشمل موقع السائق ونقطة البداية
        const bounds = new google.maps.LatLngBounds();
        bounds.extend(driverPos);
        bounds.extend(new google.maps.LatLng(startLocation.lat, startLocation.lng));
        map.fitBounds(bounds, {padding: 100});

        // حساب المسافة بين السائق ونقطة البداية
        const distance = google.maps.geometry.spherical.computeDistanceBetween(
            driverPos,
            new google.maps.LatLng(startLocation.lat, startLocation.lng)
        );
		       // تحديث واجهة المستخدم بالمسافة
        document.getElementById('distanceInfo').innerHTML = `
            المسافة المتبقية: ${(distance / 1000).toFixed(1)} كم
        `;
    // حساب المسار
    try {
      const request = {
        origin: driverPos,
        destination: startPos,
        travelMode: 'DRIVING'
      };
      
      console.log("[Checkpoint 11] إرسال طلب حساب المسار:", request);
      
      const response = await directionsService.route(request);
      console.log("[Checkpoint 12] استجابة Directions API:", response);
      
      // عرض المسار على الخريطة
      if (driverDirectionsRenderer) {
        driverDirectionsRenderer.setMap(null);
      }
      
      driverDirectionsRenderer = new google.maps.DirectionsRenderer({
        suppressMarkers: true,
		 polylineOptions: { 
            strokeColor: "#FF00FF",
            strokeOpacity: 0.8,
            strokeWeight: 7
        }
      });
      
      driverDirectionsRenderer.setMap(map);
      driverDirectionsRenderer.setDirections(response);
      
    } catch (error) {
      console.error("[Error] فشل في حساب المسار:", error);
      console.error("التفاصيل:", {
        origin: driverPos.toJSON(),
        destination: startPos.toJSON(),
        error: error.message
      });
    }
  });

}
        function updateDriverRoute(currentPos, startPos) {
            if (driverRoutePolyline) {
                driverRoutePolyline.setMap(null);
            }

            driverRoutePolyline = new google.maps.Polyline({
                path: [currentPos, startPos],
                geodesic: true,
                strokeColor: "#FF00FF",
                strokeOpacity: 0.8,
                strokeWeight: 7,
                map: map
            });
        }
		function showArrivalNotification(driverId) {
            const notification = document.getElementById('arrivalNotification');
            const sound = document.getElementById('notificationSound');
    
    // تحديث بيانات السائق
            database.ref(`drives/${driverId}`).once('value').then((snapshot) => {
                const driverData = snapshot.val();
                document.getElementById('driverArrivalInfo').innerHTML = `
                     <p>الاسم: ${driverData.fullName}</p>
                     <p>الهاتف: <a href="tel:${driverData.phoneNumber}">${driverData.phoneNumber}</a></p>
                     <p>السيارة: ${driverData.carNumber}</p>
                     `;
                });

    // إدارة الصوت
            sound.loop = true;
            sound.play().catch(() => {
            notification.innerHTML += '<p style="color:red;">يُرجى السماح بتشغيل الصوت</p>';
            });

            notification.style.display = 'block';
        }    
        function handleArrivalConfirmation() {
            const notification = document.getElementById('arrivalNotification');
            const sound = document.getElementById('notificationSound');
    
    // إيقاف الصوت
            sound.pause();
            sound.currentTime = 0;
    
    // إخفاء الإشعار فقط دون مسح البيانات
            notification.style.display = 'none';
    
    // إبقاء علامة السائق ظاهرة
            if (driverMarker) {
             driverMarker.setAnimation(null); // إيقاف تأثير الارتداد
            }
        }
    	function clearDriverTracking() {
    // إزالة تتبع السائق
            if (driverLocationListener) {
                 database.ref(`drives/${tripData.driverId}/location`).off('value', driverLocationListener);
                driverLocationListener = null;
           
			}

    // إزالة العلامات والمسارات
            if (driverMarker) driverMarker.setMap(null);
            if (driverDirectionsRenderer) driverDirectionsRenderer.setMap(null);
            driverDirectionsRenderer = null;

    // إعادة تعيين العناصر
            document.getElementById('persistentNotification').style.display = 'none';
        }
		function showActualRoute(startLoc, endLoc) {
    // تنظيف العناصر السابقة
            if(directionsRenderer) directionsRenderer.setMap(null);
            if(startMarker) startMarker.setMap(null);
            if(endMarker) endMarker.setMap(null);

    // إعداد خصائص المسار
              directionsRenderer = new google.maps.DirectionsRenderer({
             suppressMarkers: false,
               polylineOptions: {
               strokeColor: "#0000FF",
              strokeOpacity: 0.8,
              strokeWeight: 6,
               zIndex: 1000
            },
              markerOptions: {
              opacity: 0.8 // شفافية العلامات
    }
            });

    // إنشاء علامات مخصصة
            startMarker = new google.maps.Marker({
               position: startLoc,
               map: map,
               icon: {
                  path: google.maps.SymbolPath.CIRCLE,
                  scale: 8,
                 fillColor: "#00CED1",
                fillOpacity: 1,
                 strokeColor: "#FFF",
                strokeWeight: 2
                },
              zIndex: 1001
            });

            endMarker = new google.maps.Marker({
                position: endLoc,
               map: map,
             icon: {
              path: google.maps.SymbolPath.CIRCLE,
               scale: 8,
               fillColor: "#FF6B6B",
               fillOpacity: 1,
               strokeColor: "#FFF",
               strokeWeight: 2
              },
              zIndex: 1001
            });

    // طلب تفاصيل المسار
             const request = {
                  origin: startLoc,
               destination: endLoc,
                travelMode: 'DRIVING',
                 provideRouteAlternatives: false,
                optimizeWaypoints: true
            };

           directionsService.route(request, (response, status) => {
                 if (status === 'OK') {
            // عرض المسار
                 directionsRenderer.setMap(map);
                 directionsRenderer.setDirections(response);

            // إعداد حدود الخريطة
               const bounds = new google.maps.LatLngBounds();
                 bounds.extend(startLoc);
                 bounds.extend(endLoc);
                 map.fitBounds(bounds);

            // عرض معلومات المسار
                const route = response.routes[0].legs[0];
                document.getElementById('routeInfo').style.display = 'block';
                document.getElementById('routeInfo').innerHTML = `
                <h3>تفاصيل الرحلة:</h3>
                <p>المسافة: ${route.distance.text}</p>
                <p>الوقت المتوقع: ${route.duration.text}</p>
                <div class="progress-bar" style="margin-top:15px;">
                    <div class="progress" style="height: 8px; background: #333; border-radius:4px;">
                        <div class="progress-fill" style="width: 100%; height:100%; background: var(--primary-color); border-radius:4px;"></div>
                    </div>
                </div>
               `;

            // إضافة خط متحرك للمسار
               const path = response.routes[0].overview_path;
               animateRoute(path);
            } else {
                   console.error('فشل في عرض المسار:', status);
            }
            });
        }
		function animateRoute(path) {
            let count = 0;
           const line = new google.maps.Polyline({
           path: [],
           geodesic: true,
           strokeColor: "#00CED1",
           strokeOpacity: 0.8,
           strokeWeight: 6
           });

         const animate = () => {
            if (count >= path.length) {
            line.setMap(null);
            return;
          }

          line.getPath().push(path[count]);
          line.setMap(map);
          count++;
          setTimeout(animate, 50);
          };

            animate(); 
        }
        function showEndNotification(price) {
    // إنشاء العنصر إذا لم يكن موجود
           let endNotification = document.getElementById('endNotification');
    
            if (!endNotification) {
            endNotification = document.createElement('div');
            endNotification.id = 'endNotification';
            endNotification.className = 'end-notification';
            document.body.appendChild(endNotification);
            }

    // تعبئة المحتوى
           endNotification.innerHTML = `
               <h2>تم الوصول إلى نقطة النهاية</h2>
               <div class="price">إجمالي سعر الرحلة: ${price} جنيه</div>
               <button class="btn" onclick="handlePaymentDone()" 
                    style="margin-top:20px; padding:12px 30px;">
                    تم الدفع وإعادة التشغيل
                </button>
            `;
    // التأكد من إزالة العلامات
    if (driverMarker) driverMarker.setMap(null);
    if (endMarker) endMarker.setMap(null);
    if (startMarker) startMarker.setMap(null);
    // تشغيل الصوت
             const sound = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
             sound.play().catch(() => {
             console.log('يُرجى السماح بتشغيل الصوت');
            });

 
        }
		function handlePaymentDone() {
    // 1. إخفاء رسالة النهاية
            const endNotification = document.getElementById('endNotification');
           if (endNotification) endNotification.remove();
    
    // 2. إعادة عرض كل العناصر
           document.getElementById('map').style.display = 'block';
           document.querySelector('.control-panel').style.display = 'flex';
           document.querySelector('.action-buttons').style.display = 'flex';
           document.getElementById('routeInfo').style.display = 'block';
    
    // 3. تنظيف الخريطة وإعادة التعيين
            clearAll();
    
    // 4. إعادة تحميل الخريطة إذا لزم الأمر (اختياري)
           // initMap();
        }

// إضافة دالة جديدة لاستعادة المسار
async function restoreRoute(startLoc, endLoc) {
    const request = {
        origin: startLoc,
        destination: endLoc,
        travelMode: 'DRIVING'
    };
    
    try {
	
        const response = await directionsService.route(request);
                // إعادة تعيين العلامات
        startMarker.setPosition(startLoc);
        startMarker.setMap(map);
        endMarker.setPosition(endLoc);
        endMarker.setMap(map)
		directionsRenderer.setMap(map);
        directionsRenderer.setDirections(response);
        
        // تحديث العلامات
        startMarker.setPosition(startLoc);
        endMarker.setPosition(endLoc);
        
        // تحديث حدود الخريطة
        const bounds = new google.maps.LatLngBounds();
        bounds.extend(startLoc);
        bounds.extend(endLoc);
        map.fitBounds(bounds, {padding: 50});
        
    } catch (error) {
        console.error('فشل في استعادة المسار:', error);
    }
}
        async function restorePreviousTrip() {
           if (!currentTripId) return;
             
            showLoading(true);
            try {
    	     const userId = localStorage.getItem('userId');
             const tripRef = database.ref(`rides/${userId}/${currentTripId}`);
             const snapshot = await tripRef.once('value');
    
           if (!snapshot.exists()) {
                localStorage.removeItem('currentTripId');
             return;
            }
    
            const tripData = snapshot.val();
			    // استعادة المسار إذا كانت الحالة new
        if (tripData.status === "new") {
		
            await restoreRoute(tripData.startLocation, tripData.endLocation);
            document.getElementById('priceOptions').style.display = 'flex';
            totalDistance = tripData.distance;
			            document.getElementById('priceOptions').style.display = 'none';
            document.querySelectorAll('.input-field').forEach(field => {
                field.style.display = 'none';
            });
        }
              await restoreTripState();

            } catch (error) {
                console.error('Error restoring trip:', error);
            } finally {
                showLoading(false);
            }
        }

       function handleStatusChange(status, tripData) {
           switch(status) {
          case 'new':
            showSearchingUI();
            break;
        case 'accepted':
            showAcceptedUI(tripData.driverId);
            break;
        case 'in_progress':
            showInProgressUI(tripData);
            break;
        case 'completed':
            showCompletedUI(tripData);
            break;
        case 'canceled':
            showCanceledUI();
            break;
        default:
            console.log('Unknown status:', status);
           }
        }

        function setupNewTripUI(tripData) {
             const userId = localStorage.getItem('userId');
             const tripRef = database.ref(`rides/${userId}/${currentTripId}`);
    
           tripListener = tripRef.on('value', (snapshot) => {
                const tripData = snapshot.val();
               if (!tripData) {
                clearAll();
                return;
            }
        
                 handleStatusChange(tripData.status, tripData);
            });
        }

        function showSearchingUI() {
		     document.querySelector('.action-buttons').style.display = 'none';
      			  document.getElementById('map').style.display = 'block'; // إضافة هذا السطر
       			  document.querySelector('.input-field').style.display = 'none';
                  document.getElementById('origin').parentNode.style.display = 'none';
                   document.getElementById('destination').parentNode.style.display = 'none';
          document.getElementById('persistentNotification').style.display = 'block';
          document.getElementById('tripStatusContent').innerHTML = `
           <h3>جاري البحث عن سائق...</h3>
            <div class="loading-spinner"></div>
          `;
        }

        async function showAcceptedUI(driverId) {
            const driverSnapshot = await database.ref(`drives/${driverId}`).once('value');
           const driverData = driverSnapshot.val();
    
         document.getElementById('persistentNotification').style.display = 'block';
         document.getElementById('tripStatusContent').innerHTML = `
           <h3>تم قبول طلبك</h3>
            <p>اسم السائق: ${driverData.fullName}</p>
              <p>موديل السيارة: ${driverData.carModel}</p>
           <p>رقم الهاتف: ${driverData.phoneNumber}</p>
           <div id="driverLiveLocation"></div>
          `;
    
           startTrackingDriver(driverId);
        }

        function showInProgressUI(tripData) {
            document.getElementById('persistentNotification').style.display = 'block';
           document.getElementById('tripStatusContent').innerHTML = `
            <h3>الرحلة قيد التقدم</h3>
            <p>المسافة المقطوعة: <span id="distanceTraveled">0</span> كم</p>
            <p>الوقت المتبقي: <span id="eta">--</span></p>
           `;
    
            updateTripProgress(tripData);
        }
		function showCanceledUI() {
            document.getElementById('persistentNotification').style.display = 'block';
           document.getElementById('tripStatusContent').innerHTML = `
            <h3 style="color: #ff4444;">تم إلغاء الرحلة</h3>
            <button class="btn" onclick="clearAll()">العودة للشاشة الرئيسية</button>
          `;
        }

// إضافة مستمع لإغلاق الصفحة
        window.addEventListener('beforeunload', async (e) => {
            if (currentTripId) {
            const tripRef = database.ref(`rides/${userId}/${currentTripId}`);
            await tripRef.update({ lastActive: firebase.database.ServerValue.TIMESTAMP });
            }
        });
		function cancelRestore() {
           localStorage.removeItem('currentTripId');
            location.reload();
        }

        async function setupAcceptedTripUI(tripData) {
  // إخفاء عناصر التحكم
          document.querySelector('.control-panel').style.display = 'none';
          document.querySelector('.action-buttons').style.display = 'none';
  
  // عرض معلومات السائق
          const driverInfo = await getDriverInfo(tripData.driverId);
          document.getElementById('persistentNotification').style.display = 'block';
          document.getElementById('tripStatusContent').innerHTML = `
          <p>الحالة: في الطريق إليك</p>
          <p>السائق: ${driverInfo.name}</p>
          <p>المسافة المتبقية: <span id="liveDistance">جاري التحديث...</span></p>
           `;
  
  // بدء تتبع الموقع الحي
           startRealTimeTracking(tripData.driverId);
        }
		async function calculateRouteWithRetry(retries = 3) {
           try {
              let origin = document.getElementById('origin').value;
              const destination = document.getElementById('destination').value;

               const request = {
                 origin: currentLocationCoords || origin,
                 destination: destination,
                 travelMode: 'DRIVING'
                };
 
                const response = await directionsService.route(request);
            if (response.routes.length === 0) throw new Error('No routes found');
        
        // ... معالجة النتيجة بنجاح ...
        
            } catch (error) {
                if (retries > 0) {
                console.log(`إعادة المحاولة... ${retries} محاولات متبقية`);
                await new Promise(resolve => setTimeout(resolve, 1000));
                return calculateRouteWithRetry(retries - 1);
                 }
                 showNotification('فشل في حساب المسار: ' + error.message, true);
            }
        }
        function selectPayment(method, event) {
		    if (!event) return; // تأكد من وجود الحدث

            selectedPayment = method;
    
            document.querySelectorAll('.payment-option').forEach(option => {
            option.classList.remove('selected');
           });
    
          event.currentTarget.classList.add('selected');
          document.getElementById('confirmBookingButton').style.display = 'block';
        event.currentTarget.classList.add('selected');

    // إضافة تأثير مرئي
          event.currentTarget.style.transform = 'scale(1.02)';
           
            event.currentTarget.style.transform = 'scale(1)';
           
        }
		async function moveTripToEnd(userId, tripId) {
              try {
            const rideRef = database.ref(`rides/${userId}/${tripId}`);
            const endRef = database.ref(`end/${userId}/${tripId}`);

        // نقل البيانات مع الاحتفاظ بالتاريخ
            const snapshot = await rideRef.once('value'); 
            const tripData = snapshot.val();
             tripData.endTimestamp = firebase.database.ServerValue.TIMESTAMP;

             await endRef.set(tripData);
             await rideRef.remove();
            } catch (error) {
            console.error('Error moving trip:', error);
           showNotification('حدث خطأ في حفظ الرحلة', true);
            }
        }

        function handlePaymentDone() {
          const userId = localStorage.getItem('userId');
          const tripId = localStorage.getItem('currentTripId');

          if (!userId || !tripId) {
             showNotification('لا توجد رحلة نشطة', true);
              return;
           }

    // نقل الرحلة إلى قسم الرحلات المنتهية
           moveTripToEnd(userId, tripId);

    // إعادة التعيين
           const endNotification = document.getElementById('endNotification');
           if (endNotification) endNotification.remove();

           document.getElementById('map').style.display = 'block';
           document.querySelector('.control-panel').style.display = 'flex';
           document.querySelector('.action-buttons').style.display = 'flex';
           document.getElementById('routeInfo').style.display = 'block';

            clearAll();
           showNotification('تم حفظ الرحلة بنجاح');
        }
		async function restoreTripState() {
            const userId = localStorage.getItem('userId');
             const tripRef = database.ref(`rides/${userId}/${currentTripId}`);
            const snapshot = await tripRef.once('value');
            if (snapshot.exists()) {
            const tripData = snapshot.val();
            handleStatusChange(tripData.status, tripData);
            }
        }
		let liveLocationWatcher = null;
        function startLiveLocationTracking(endLocation) {
            if (liveLocationWatcher) {
            navigator.geolocation.clearWatch(liveLocationWatcher);
            }

             liveLocationWatcher = navigator.geolocation.watchPosition(
            position => {
               const currentPos = {
                  lat: position.coords.latitude,
                  lng: position.coords.longitude
                };
            
                 updateLiveRoute(currentPos, endLocation);
            },
            error => {
               console.error('Error getting live location:', error);
            },
            {
              enableHighAccuracy: true,
              maximumAge: 30000,
              timeout: 2700
            }

            );
        }

// دالة لتحديث المسار الحي
        function updateLiveRoute(startPos, endPos) {
           directionsRenderer.setMap(null);
    
          const request = {
           origin: startPos,
          destination: endPos,
          travelMode: 'DRIVING',
          provideRouteAlternatives: false
          };

           directionsService.route(request, (response, status) => {
            if (status === 'OK') {
              directionsRenderer.setOptions({
                polylineOptions: {
                    strokeColor: "#00FF00",
                    strokeOpacity: 0.8,
                    strokeWeight: 6
                 }
                });
              directionsRenderer.setMap(map);
              directionsRenderer.setDirections(response);
            
            // تحديث العلامات
              startMarker.setPosition(startPos);
              startMarker.setMap(map);
              endMarker.setPosition(endPos);
              endMarker.setMap(map);
            
              map.fitBounds(response.routes[0].bounds);
              }
            });
        }
		// دالة لتنظيف العناصر الشبحية من الخريطة
function cleanGhostMapElements() {
    // البحث عن جميع الصور غير المرغوب فيها
    const ghostImages = document.querySelectorAll('img[src="https://maps.gstatic.com/mapfiles/transparent.png"]');
    
    // حذف كل الصور المطابقة
    ghostImages.forEach(img => {
        img.parentNode.removeChild(img);
    });

    // تنظيف العناصر الإضافية
    const mapTiles = document.querySelectorAll('div[style*="width: 40px; height: 40px;"]');
    mapTiles.forEach(tile => tile.remove());
}
		function openGoogleMapsNavigation(start, end) {
           const baseUrl = "https://www.google.com/maps/dir/?api=1";
            const params = new URLSearchParams({
            origin: `${start.lat},${start.lng}`,
            destination: `${end.lat},${end.lng}`,
            travelmode: "driving"
           });
            window.open(`${baseUrl}&${params.toString()}`, '_blank');
        }
        function clearAll() {
    
    // إزالة علامة السائق إذا كانت موجودة
    if (driverMarker) {
        driverMarker.setMap(null);
        driverMarker = null;
    }
	    cleanGhostMapElements();
        driverMarker = null;
    driverDirectionsRenderer = null;
    // مسح أي مسارات متبقية
    if (driverRoutePolyline) {
        driverRoutePolyline.setMap(null);
        driverRoutePolyline = null;
    }
    // إزالة جميع العناصر من الخريطة
	    // إعادة تعيين عناصر الواجهة
             document.querySelector('.control-panel').style.display = 'flex';
             document.querySelector('.action-buttons').style.display = 'flex';
             document.getElementById('routeInfo').style.display = 'block';
             if (driverDirectionsRenderer) driverDirectionsRenderer.setMap(null);
             if (directionsRenderer) directionsRenderer.setMap(null);
             if (startMarker) startMarker.setMap(null);
             if (endMarker) endMarker.setMap(null);
             if (currentLocationMarker) currentLocationMarker.setMap(null);
             if (driverRoutePolyline) driverRoutePolyline.setMap(null);
             if (driverMarker) driverMarker.setMap(null);
             if (destinationMarker) destinationMarker.setMap(null);
               if(directionsRenderer) directionsRenderer.setMap(null);
			 driverMarker = null;
             destinationMarker = null;
    // إخفاء العناصر الواجهة
             document.getElementById('persistentNotification').style.display = 'none';
             document.getElementById('routeInfo').innerHTML = '';
             document.getElementById('priceOptions').style.display = 'none';
             document.getElementById('bookingDetails').style.display = 'none';
             localStorage.removeItem('currentTripId');
    // إعادة عرض عناصر الإدخال
               document.querySelectorAll('.input-field').forEach(field => {
                  field.style.display = 'block'; // إعادة العرض
                })
				    document.getElementById('origin').parentNode.style.display = 'block';
                    document.getElementById('destination').parentNode.style.display = 'block';
    // إعادة تعيين القيم
	    // إعادة تعيين مواقع العلامات الأصلية
    startMarker.setPosition(null);
    endMarker.setPosition(null);
             currentTripId = null;
             selectedVehicle = null;
             currentLocationCoords = null;
        if (driverDirectionsRenderer) {
        driverDirectionsRenderer.setMap(null);
        driverDirectionsRenderer = null;
    }
    // إزالة بيانات الحقول
             document.getElementById('origin').value = '';
             document.getElementById('destination').value = '';
    
     // إلغاء الاشتراكات
            if (tripListener) database.ref(`rides/${currentTripId}`).off('value', tripListener);
            if (driverLocationListener) database.ref(`drives/${driverId}/location`).off('value', driverLocationListener);
            const notification = document.getElementById('arrivalNotification');
            if (notification) {
               notification.style.display = 'none';
               notification.classList.remove('success');
            }
		       localStorage.removeItem('currentTripId');

        // إزالة الرسالة النهائية إذا كانت ظاهرة
            const endNotification = document.getElementById('endNotification');
            if (endNotification) {
                endNotification.remove();
            }
		    if(map) {
             map.setZoom(15);
            map.setCenter({ lat: 30.0444, lng: 31.2357 });
            }
    // إيقاف أي أصوات
            const sound = document.getElementById('notificationSound');
            if (sound) {
                sound.pause();
                sound.currentTime = 0;
            }
    	    if (liveLocationWatcher) {
           navigator.geolocation.clearWatch(liveLocationWatcher);
          liveLocationWatcher = null;
           }
		}

        function getVehicleName(type) {
            const vehicles = {
                normal: 'سيارة عادية',
                luxury: 'سيارة فاخرة',
                helicopter: 'طائرة'
            };
            return vehicles[type] || '';
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
        }

        function showNotification(message, isError = false) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.background = isError ? '#ff4444' : '#00CED1';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.remove(), 5000);
        }
		function adjustMarkersPosition(startPos, endPos) {
    const bounds = new google.maps.LatLngBounds();
    bounds.extend(startPos);
    bounds.extend(endPos);
    
    const ne = bounds.getNorthEast();
    const sw = bounds.getSouthWest();
    
    const padding = 0.0002; // تعديل الموقع بمقدار 20 متر تقريبًا
    
    startMarker.setPosition(new google.maps.LatLng(
        startPos.lat() + padding,
        startPos.lng() - padding
    ));
    
    endMarker.setPosition(new google.maps.LatLng(
        endPos.lat() - padding,
        endPos.lng() + padding
    ));
}
// متغير لحفظ المربعات علشان نقدر نمسحهم بعدين
let tripAreas = [];
const hexGridSize = 0.006; // تباعد المراكز (حسب نصف القطر المطلوب)
const hexRadius = 0.0029; // نصف القطر المناسب للتباعد

let tripHexagons = [];
const densityColors = {
    low: '#FFD580',    // 1-3 رحلات
    medium: '#FFA500',  // 4-6 رحلات
    high: '#FF4500'     // 7+ رحلات
};

async function drawTripHotspots() {
    tripHexagons.forEach(hex => hex.setMap(null));
    tripHexagons = [];
    
    const ridesRef = database.ref('rides');
    const snapshot = await ridesRef.once('value');
    const areas = new Map();

    // حساب الإحداثيات على الشبكة السداسية
    const getGridKey = (lat, lng) => {
        const gridLat = Math.round(lat / hexGridSize) * hexGridSize;
        const gridLng = Math.round(lng / hexGridSize) * hexGridSize;
        return `${gridLat},${gridLng}`;
    };

    snapshot.forEach(userSnapshot => {
        userSnapshot.forEach(tripSnapshot => {
            const trip = tripSnapshot.val();
            if (trip.startLocation) {
                const key = getGridKey(
                    trip.startLocation.lat,
                    trip.startLocation.lng
                );
                areas.set(key, (areas.get(key) || 0) + 1);
            }
        });
    });

    // رسم الأشكال مع ضمان عدم التداخل
    areas.forEach((count, key) => {
        const [lat, lng] = key.split(',');
        const hexagon = createHexagon(
            parseFloat(lat),
            parseFloat(lng),
            hexRadius, // استخدام نصف القطر المعدل
            getDensityColor(count),
            count
        );
        tripHexagons.push(hexagon);
    });
}

function getDensityColor(count) {
    if (count <= 3) return densityColors.low;
    if (count <= 6) return densityColors.medium;
    return densityColors.high;
}
function createHexagon(lat, lng, radius, color, tripCount) {
    const center = { lat, lng };
    const coordinates = [];
    
    for (let i = 0; i < 6; i++) {
        const angle = (i * 60) * (Math.PI / 180);
        const dx = radius * Math.cos(angle);
        const dy = radius * Math.sin(angle);
        coordinates.push({ lat: lat + dy, lng: lng + dx });
    }
    coordinates.push(coordinates[0]);

    const hexagon = new google.maps.Polygon({
        paths: coordinates,
        strokeColor: color,
        strokeOpacity: 0.8,
        strokeWeight: 1,
        fillColor: color,
        fillOpacity: 0.3 + (tripCount * 0.05), // زيادة الشفافية مع الكثافة
        map: map,
        zIndex: 1,
        clickable: false

    });

    // إضافة تفاعلية عند الhover
    hexagon.addListener('mouseover', () => {
        hexagon.setOptions({ 
            strokeWeight: 3,
            fillOpacity: 0.5 
        });
        new google.maps.InfoWindow({
            content: `عدد الرحلات: ${tripCount}`
        }).open(map, hexagon);
    });

    hexagon.addListener('mouseout', () => {
        hexagon.setOptions({ 
            strokeWeight: 1,
            fillOpacity: 0.3 + (tripCount * 0.05)
        });
    });

    return hexagon;
}
// إضافة مستمع للتحديثات الفورية
database.ref('rides').on('value', () => {
    drawTripHotspots();
});
    </script>
</body>
</html>
