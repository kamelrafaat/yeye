<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>نظام التاكسي الذكي</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root {
            --primary-color: #00CED1;
            --secondary-color: #2E2E2E;
            --accent-color: #FFA500;
            --bg-color: #1A1A1A;
			 --neon-glow: 0 0 15px var(--primary);  /* تأثير إضاءة */
             --gradient: linear-gradient(135deg, var(--primary) 0%, #4FACFE 100%);
        }

        * {
            box-sizing: border-box;
            font-family: 'Tajawal', sans-serif;
            margin: 0;
            padding: 0;
        }

        html, body {
		 	  margin: 0 !important;
             padding: 0 !important;
           overflow: hidden;
             width: 100%;
           height: 100%;
		     background: #000; /* لون الخلفية الجديدة */
        }

        body {
            background: var(--bg-);
            color: var(--text);
		    position: relative;
             min-height: 100vh;
			   overflow-x: hidden;
        }

        .control-panel {
            position: fixed;
            top: 0px;
            left: 0px;
            right: 0px;
            z-index: 1000;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
		    z-index: 1000 !important;
	        flex-direction: row;
            justify-content: space-between;
            align-items: flex-start;
        }

        .input-field {
		  flex: 1;
  min-width: 280px;
  background: var(--glass-bg);
  border-radius: 15px;
  padding: 1rem;
  position: relative;
  transform-style: preserve-3d;
        }

        .input-field input {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--primary-color);
            border-radius: 6px;
            background: #121212;
            color: #FFF;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }

        .input-field input:focus {
            border-color: var(--accent-color);
			
        }

        .action-buttons {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            gap: 15px;
            padding: 15px;
            border-radius: 8px;
			z-index: 1000 !important;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            background: var(--primary-color);
            color: var(--secondary-color);
            min-width: 150px;
            font-size: 16px;
			  /* التدرج اللوني */
  background: linear-gradient(135deg, #FFD700, #D4AF37);
  color: #000;
  
  /* الظل */
  transform: perspective(500px) rotateX(15deg);
  box-shadow: 0 20px 40px rgba(0,0,0,0.3);
  /* التأثيرات التفاعلية */
  position: relative;
  overflow: hidden;
        }

/* تأثير الإضاءة عند التحويم */
.btn::after {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(
    90deg,
    transparent,
    rgba(255, 255, 255, 0.25),
    transparent
  );
  transition: 0.75s;
}
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 206, 209, 0.4);
        }
.btn:hover::after {
  left: 100%;
}
/* أزرار مع أيقونات */
.btn-icon {
  display: inline-flex;
  align-items: center;
  gap: 12px;
  padding: 12px 28px;
}

.btn-icon i {
  font-size: 1.1em;
  transition: transform 0.3s ease;
}

.btn-icon:hover i {
  transform: translateX(5px);
}

/* أزرار التحميل */
.btn-loading {
  position: relative;
  pointer-events: none;
}

.btn-loading::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 24px;
  height: 24px;
  border: 3px solid rgba(255, 255, 255, 0.3);
  border-top-color: #fff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  transform: translate(-50%, -50%);
}

@keyframes spin {
  to { transform: translate(-50%, -50%) rotate(360deg); }
}
        #map {
  height: 65vh;
  width: 90%;
  margin: 6rem auto 2rem;
  border-radius: 20px;
  overflow: hidden;
  border: 1.5px solid var(--primary);
  box-shadow:
    0 0 20px var(--primary),
    0 8px 24px rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(6px);
  transition: all 0.3s ease-in-out;
}
.gm-style .gm-style-iw-c {
    background: #0a1a30 !important;
    color: #aec9d1 !important;
    border-radius: 12px !important;
    box-shadow: 0 5px 15px rgba(0,0,0,0.4) !important;
}

.gm-style .gm-style-iw-t::after {
    background: #0a1a30 !important;
}
        .route-info {
            position: fixed;
            top: 120px;
            left: 20px;
            background: rgba(46, 46, 46, 0.9);
            padding: 20px;
            border-radius: 8px;
            z-index: 1000;
            max-width: 300px;
            backdrop-filter: blur(5px);
			    display: none !important; /* إخفاء القسم تمامًا */

        }

        /* تصميم حاوية الخيارات الرئيسية */
/* تنسيق حاوية الخيارات الرئيسية */
.price-options {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    width: 100vw; /* تغطية العرض الكامل */
    height: 35vh; /* ارتفاع مناسب للشاشة */
    background: rgba(15, 15, 15, 0.98);
    backdrop-filter: blur(15px);
    border-top: 1px solid rgba(255,255,255,0.1);
    box-shadow: 0 -8px 30px rgba(0,0,0,0.3);
    overflow-x: auto;
    overflow-y: hidden;
    gap: 15px;
    padding: 15px;
    scroll-snap-type: x mandatory;
    z-index: 1000;
    transform: none !important;
}

/* تعديل البطاقات لعرضها بشكل أفقي */
.price-option {
    scroll-snap-align: center;
    flex: 0 0 85%;
    min-width: 85%;
    height: 80%;
    padding: 20px;
    border-radius: 15px;
    background: rgba(30, 30, 30, 0.95);
    border: 1px solid rgba(255,255,255,0.1);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
    overflow: hidden;
}

/* تحسين التنسيق الداخلي */
.price-option h3 {
    font-size: 1.2rem;
    margin-bottom: 10px;
    white-space: nowrap;
}

.price-option .total-price {
    font-size: 1.8rem;
    margin: 15px 0;
}

/* إصلاح مشكلة التمرير الأفقي */
.price-options::-webkit-scrollbar {
    height: 4px;
}

.price-options::-webkit-scrollbar-thumb {
    background: rgba(0,206,209,0.8);
    border-radius: 2px;
}
/* تنسيق الخيارات للشاشات الصغيرة */
@media (max-width: 768px) {
    .price-options {
        display: grid;
        grid-template-columns: repeat(3, 1fr); /* 3 أعمدة متساوية */
        gap: 8px;
        height: 22vh; 
        padding: 8px;
        overflow: visible;
        box-shadow: none;
        border-top: none;
		    bottom: 25vh; /* رفع الحاوية 25% من أسفل الشاشة */

    }

    .price-option {
        flex: 1;
        min-width: auto;
        height: auto;
        padding: 8px;
        border-radius: 10px;
        scroll-snap-align: none;
    }

    .price-option h3 {
	    color: #ffffff !important; /* اللون الأبيض */
    text-shadow: 0 1px 3px rgba(0,0,0,0.3);

        font-size: 0.9rem;
        flex-direction: column;
        gap: 4px;
    }

    .vehicle-icon {
        font-size: 1.2rem;
    }

    .total-price {
        font-size: 1rem;
        margin: 8px 0;
    }

    .vehicle-details-short {
        display: none;
    }
}

/* تعديلات إضافية للشاشات الصغيرة جدًا */
@media (max-width: 480px) {
    .price-options {
        grid-template-columns: 1fr; /* عمود واحد */
        gap: 6px;
    }
    
    .price-option {
        width: 100%;
        padding: 10px;
    }
    
    .price-option h3 {
        font-size: 0.85rem;
    }
    
    .total-price {
        font-size: 0.9rem;
    }
}
.gm-style-iw-c {
    box-shadow: 0 0 20px rgba(0, 206, 209, 0.5) !important;
    border-radius: 15px !important;
    background: linear-gradient(145deg, #0a1a30, #0d2342) !important;
}

.gm-style .gm-style-iw-t::after {
    background: linear-gradient(145deg, #0a1a30, #0d2342) !important;
    box-shadow: -5px -5px 15px rgba(10, 26, 48, 0.5),
                5px 5px 15px rgba(0, 0, 0, 0.3) !important;
}
        .price-option:hover {
            transform: scale(1.05);
        }

        .price-option.selected {
    background: rgba(46, 46, 46, 0.7) !important; /* زيادة الشفافية */
            color: var(--secondary-color);
            box-shadow: 0 4px 15px rgba(0, 206, 209, 0.4);
        
		}

        .booking-details {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -20%);
		      background: rgba(255, 255, 255, 0.05) !important; /* شفافية 90% */
            padding: 10px;
            border-radius: 8px;
            z-index: 2000;
            display: none;
            text-align: center;
            backdrop-filter: blur(15px);
            width: 100%;
            max-width: 90%;
			
        }
		.booking-details h2 {
        font-size: 1.1rem !important;
        margin-bottom: 5px !important;
    }

    .booking-details p {
        font-size: 0.75rem !important;
        margin: 3px 0 !important;
		  margin-bottom: 5px !important;
    padding: 0 !important;
    }

    .payment-options {
        gap: 5px !important;
        margin: 8px 0 !important;
    }

    .payment-option {
        padding: 6px 10px !important;
        font-size: 0.7rem !important;
    }


        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 3000;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--primary-color);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .current-location-btn {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            padding: 5px;
            font-size: 18px;
        }

        .map-select-btn {
		
            margin-top: 10px;
            width: 100%;
            padding: 8px;
            font-size: 14px;
        }

        .driver-info {
            position: fixed;
            top: auto !important;
		    bottom: 80px;
            left: 15px !important;
            right: auto !important;
            transform: none !important;
            background: rgba(46, 46, 46, 0.9);
			    /* تقليل الحجم */
    width: 200px;
    max-height: 40vh;
    overflow: hidden;
            padding: 20px;
            border-radius: 8px;
            z-index: 1000;
            max-width: 300px;
            backdrop-filter: blur(5px);
            display: none;
		    stroke: #00FF00 !important;
            stroke-opacity: 0.8 !important;
            stroke-width: 6px !important;
            stroke-dasharray: none !important;
           animation: pulse 2s infinite;
		       /* تصميم أكثر شفافية */
    background: rgba(30, 30, 30, 0.92) !important;
    backdrop-filter: blur(8px);
    border: 1px solid rgba(255,255,255,0.1);
        }
        @keyframes pulse {
           0% { stroke-opacity: 0.8; }
           50% { stroke-opacity: 0.4; }
          100% { stroke-opacity: 0.8; }
        }
        .driver-route-line {
            stroke-color: #FF6B6B;
            stroke-opacity: 0.7;
            stroke-weight: 4;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #00CED1;
            color: #2E2E2E;
            padding: 15px 25px;
            border-radius: 8px;
            z-index: 5000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease-out;
            display: none;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
		.persistent-notification {
		    /* تغيير الموضع إلى الزاوية السفلية اليسرى */
    top: auto !important;
    bottom: 80px;
    left: 15px !important;
    right: auto !important;
    transform: none !important;
    
    /* تقليل الحجم */
    width: 200px;
    max-height: 35vh;
    overflow: hidden;
    
    /* تصميم أكثر شفافية */
    background: rgba(1, 1, 1, 0.6) !important; /* شفافية عالية */
    border: 1px solid rgba(255,255,255,0.1);
        position: fixed;
        padding: 20px;
        border-radius: 8px;
        z-index: 1000;
        border: 2px solid var(--primary-color);
        display: none;
         color: #fff;
        top: 20px !important;
        max-width: 200px !important;
        }
		.persistent-notification h3 {
        color: #fff !important;
        margin-bottom: 15px;
        }

       .persistent-notification p {
          margin: 8px 0;
          font-size: 16px;  
        }
		.notification.success {
         background: #4CAF50;
         padding: 20px;
         font-size: 18px;
         display: flex;
         align-items: center;
         width: 350px;
         border-left: 5px solid #45a049;
        }

        .notification-content {
          display: flex;
          flex-direction: column;
          gap: 15px;
          width: 100%;
        }

        .confirm-btn {
          background: rgba(255, 255, 255, 0.9);
          color: #4CAF50;
          padding: 10px 25px;
          border-radius: 8px;
          font-weight: bold;
          transition: all 0.3s;
          align-self: flex-end;
        }

        .confirm-btn:hover {
           background: #fff;
           transform: translateY(-2px);
           box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
	    .end-notification {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(46, 46, 46, 0.95);
        padding: 40px 60px;
        border-radius: 15px;
        text-align: center;
        z-index: 10000;
        border: 3px solid #00CED1;
        box-shadow: 0 8px 30px rgba(0,0,0,0.5);
        color: #FFF;
        }

        .end-notification h2 {
        color: #00CED1;
        margin-bottom: 20px;
        font-size: 28px;
        }

        .end-notification .price {
        font-size: 24px;
        margin: 20px 0;
        }
    @media (max-width: 768px) {
    .profile-btn {
        position: fixed !important;
        bottom: 1px !important;
        left: 15px !important;
        right: auto !important;
        top: auto !important;
        transform: none !important;
        margin: 0 !important;
        z-index: 1001 !important;
        padding: 10px 5px !important;
        width: auto !important;
  background: linear-gradient(
    135deg,
    rgba(76, 175, 80, 0.9) 0%,    /* أخضر شفاف */
    rgba(255, 82, 82, 0.9) 100%   /* أحمر شفاف */
  ) !important;
  border: none !important;
  border-radius: 25px !important;
  color: white !important;
  box-shadow: 
    0 8px 32px rgba(76, 175, 80, 0.3),
    0 4px 12px rgba(255, 255, 255, 0.1) inset !important;
  transition: all 0.4s cubic-bezier(0.215, 0.61, 0.355, 1) !important;
  overflow: hidden !important;
  backdrop-filter: blur(8px) !important;
  border: 1px solid rgba(255, 255, 255, 0.2) !important;
    /* حدود متحركة */
   
	}
/* أيقونة البروفيل المعدلة */
.profile-btn .fa-chevron-left {
  color: rgba(255, 255, 255, 0.9) !important;
  transition: all 0.3s ease !important;
  font-size: 14px !important;
}
    .profile-text {
  position: relative;
  z-index: 1;
  text-shadow: 
    0 2px 4px rgba(0, 0, 0, 0.3),
    0 0 8px rgba(76, 175, 80, 0.5) !important;
  transition: all 0.3s ease !important;
}
.profile-btn:hover .profile-text {
  text-shadow: 
    0 3px 6px rgba(0, 0, 0, 0.4),
    0 0 12px rgba(255, 82, 82, 0.6) !important;
}
	/* تأثير حدود متحركة */
.profile-btn::before {
  content: '';
  position: absolute;
  top: -2px;
  left: -2px;
  right: -2px;
  bottom: -2px;
  background: linear-gradient(
    45deg,
    #4CAF50 0%,
    #FF5252 50%,
    #4CAF50 100%
  );
  z-index: -1;
  border-radius: 25px;
  animation: border-flow 3s linear infinite;
  background-size: 200% auto;
}

    .profile-btn i {
        font-size: 14px !important;
        margin-right: 5px !important;
    }
	@keyframes border-flow {
  0% { background-position: 0% center; }
  100% { background-position: -200% center; }
}

    /* منع تداخل مع الأزرار الأخرى */
    .action-buttons {
        left: 50% !important;
        transform: translateX(-50%) !important;
        width: 90% !important;
        bottom: 80px !important; /* زيادة البعد عن الأسفل */
    }
}
.pulsating-marker {
    animation: pulse 1.5s infinite;
    text-shadow: 0 0 10px currentColor;
}

@keyframes pulse {
    0% { transform: scale(0.9); opacity: 0.8; }
    50% { transform: scale(1.2); opacity: 1; }
    100% { transform: scale(0.9); opacity: 0.8; }
}
		@media (max-width: 768px) {
           .control-panel {
		       z-index: 100 !important;

        flex-direction: row !important;
        flex-wrap: nowrap !important;
        gap: 0 !important;
        padding: 0 !important;
    }

.map-select-btn {

    margin-top: 8px;
    padding: 8px;
    font-size: 10px;
}
      /* تعديل حقلي الإدخال */
    .input-field {
	
        flex: 1 !important;
        min-width: 20% !important;
        margin: 0 !important;
        border-radius: 0 !important;
        padding: 3px !important;
    }
	
/* تنسيق عام لحقول الإدخال */
.input-field input {
  border: 2px solid rgba(76, 175, 80, 0.3) !important; /* أخضر شفاف */
  transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important;
  box-shadow: 0 2px 8px rgba(76, 175, 80, 0.1) !important;
}

/* عند التركيز على حقل البداية */
#origin:focus {
  border-color: #4CAF50 !important; /* أخضر كامل */
  box-shadow: 
    0 0 15px rgba(76, 175, 80, 0.3),
    inset 0 1px 3px rgba(76, 175, 80, 0.2) !important;
}

/* عند التركيز على حقل النهاية */
#destination:focus {
  border-color: #FF5252 !important; /* أحمر كامل */
  box-shadow: 
    0 0 15px rgba(255, 82, 82, 0.3),
    inset 0 1px 3px rgba(255, 82, 82, 0.2) !important;
}

/* تأثير تحويم عام */
.input-field input:hover {
  border-color: rgba(76, 175, 80, 0.5) !important;
  transform: translateY(-1px);
}

/* تأثير تحويم خاص بحقل النهاية */
#destination:hover {
  border-color: rgba(255, 82, 82, 0.5) !important;
}

/* أنيميشن نبضات الحدود */
@keyframes input-pulse {
  0% { border-color: rgba(76, 175, 80, 0.3); }
  50% { border-color: rgba(76, 175, 80, 0.6); }
  100% { border-color: rgba(76, 175, 80, 0.3); }
}

.input-field input:not(:focus):hover {
  animation: input-pulse 1.5s infinite;
}

/* تصميم البليس هولدر */
.input-field input::placeholder {
  color:  #e0e0e0 !important; /* ابيض  */
  transition: all 0.3s ease;
}

#destination::placeholder {
  color: #e0e0e0 !important; /* ابيض  */
}

/* تأثيرات النص عند الكتابة */
.input-field input:valid {
  border-color: rgba(76, 175, 80, 0.8) !important;
  background: rgba(76, 175, 80, 0.03) !important;
}

#destination:valid {
  border-color: rgba(255, 82, 82, 0.8) !important;
  background: rgba(255, 82, 82, 0.03) !important;
}

/* حدود مضيئة متقدمة */
.input-field input {
  position: relative;
  overflow: hidden;
}

.input-field input::after {
  content: '';
  position: absolute;
  top: -2px;
  left: -2px;
  right: -2px;
  bottom: -2px;
  border: 2px solid;
  border-radius: 6px;
  opacity: 0;
  animation: border-glow 2s infinite;
}

#origin::after { border-color: #4CAF50; }
#destination::after { border-color: #FF5252; }

@keyframes border-glow {
  0% { opacity: 0; }
  50% { opacity: 0.3; }
  100% { opacity: 0; }
}

.input-field input:focus::after {
  animation: border-glow 1s infinite;
}
    
        .action-buttons {
		    z-index: 1003 !important; /* أعلى من كل العناصر */
  background: #000 !important; /* خلفية شفافة خضراء */
          min-width: 100%;
		  bottom: 60px !important;
    padding: 1rem;
    font-size: 14px;
    transform: perspective(300px) rotateX(10deg);
      0 10px 25px rgba(0, 206, 209, 0.4),
      inset 0 0 10px rgba(255,255,255,0.2);
        }
    
        .btn {
          padding: 10px 20px;
          min-width: 120px;
		          flex: 1 1 45%;
		  
        }
    }
		
    .payment-options {
       display: flex;
      gap: 15px;
      margin: 20px 0;
      flex-direction: column;
    }

    .payment-option {
      padding: 15px;
     border-radius: 8px;
     cursor: pointer;
     transition: all 0.3s;
     background: rgba(255, 255, 255, 0.1);
     border: 2px solid transparent;
    }

    .payment-option.selected {
      background: var(--primary-color);
      color: var(--secondary-color);
      border-color: var(--accent-color);
    }

    .payment-option:hover {
      transform: scale(1.02);
    }
@media (max-width: 768px) {
    .driver-info, .persistent-notification {
        /* تقليل الحجم العام */
        width: 60%;
        max-width: 150px;
        padding: 5px;
        
        /* تعديل الخطوط */
        font-size: 0.6rem;
        
        /* تقليل الهوامش */
        margin: 5px;
        top: 5px !important;
        
        /* إخفاء العناصر غير الضرورية */
        .extra-details {
            display: none;
        }
    }
    
    /* عناوين الرسائل */
    .driver-info h3, .persistent-notification h3 {
        font-size: 1rem;
        margin-bottom: 8px;
    }
    
    /* محتوى النصوص */
    .driver-info p, .persistent-notification p {
        margin: 8px 0;
    }
    
    /* الأزرار */
    .close-btn, .toggle-info-btn {
        padding: 8px 12px;
        font-size: 0.85rem;
    }
    
    /* أيقونات الأزرار */
    .toggle-info-btn i {
        font-size: 14px;
    }
}
    #confirmBookingButton {
      display: none;
      margin-top: 20px; 
    
    }
	.actual-route {
    stroke-color: #00CED1 !important;
    stroke-opacity: 0.8 !important;
    stroke-weight: 6 !important;
    stroke-dasharray: none !important;
     }
	
	/* ======= زر البروفيل ======= */
.profile-btn {
  /* أضف خلفية شفافة أو لون ثابت */
      background: linear-gradient(45deg, #FF69B4, #FF1493);     /* أو أي لون تفضله */
  border: 2px solid var(--accent-color); /* سمك الإطار ولونه */
  border-radius: 30px;                   /* نصف قطر الانحناء */
  padding: 8px 10px;                    /* الارتفاع والعرض الداخلي */
  font-size: 18px;                       /* حجم الخط */
  color: var(--secondary-color);         /* لون النص */
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.3s;
     box-shadow: 0 4px 15px rgba(255,105,180,0.4);

    /* حدود متحركة */
    border: none;
    position: relative;
    overflow: hidden;

}

.profile-btn:hover {
  background: var(--accent-color);
  color: #FFF;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}
.profile-btn .fa-chevron-left {
  font-size: 16px;    /* حجم الأيقونة */
  transition: transform 0.3s;
}
.profile-btn:hover .fa-chevron-left {
  transform: translateX(-4px);
}

.marker-label {
    background: rgba(0, 206, 209, 0.9);
    padding: 2px 8px;
    border-radius: 15px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
}
@media (max-width: 768px) {
    .booking-details p,
    .booking-details .vehicle-type,
    .booking-details .total-price {
        line-height: 0.7 !important;
        margin: 2px 0 !important;
    
	}
}
.full-screen-map {
    height: 100vh !important;
    width: 100% !important;
    margin: 0 !important;
    border-radius: 0 !important;
    position: fixed;
    top: 0;
    left: 0;
    z-index: 50;
    border: none !important;
    box-shadow: none !important;
}
/* أضف هذه التنسيقات */
.theme-toggle {
  position: absolute;
  top: 110px;
  left: 1px;     /* المسافة من الشمال */
  z-index: 1000;
  display: flex;
  align-items: center;
  gap: 10px;
}

.switch {
  position: relative;
  display: inline-block;
  width: 60px;
  height: 34px;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #2c3e50;
  transition: .4s;
  border-radius: 34px;
}
/* زر تحديد البداية - تدرج أخضر مع تأثير ثلاثي الأبعاد */
.input-actions button.btn-icon[onclick*="start"] {
  background: linear-gradient(145deg, #4CAF50, #45a049) !important;
  border: 2px solid #388E3C !important;
  color: #000 !important;
  font-weight: 1000 !important; /* سمك الخط */
  border-radius: 12px;
  padding: 12px 25px;
  box-shadow: 
    0 4px 15px rgba(76, 175, 80, 0.3),
    0 2px 5px rgba(0,0,0,0.1) inset !important;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  font-weight: 600;
  letter-spacing: 0.5px;
}

.input-actions button.btn-icon[onclick*="end"] {
  background: linear-gradient(145deg, #FF5252, #e53935) !important;
  border: 2px solid #D32F2F !important;
 color: #000 !important;
  font-weight: 1000 !important; /* سمك الخط */
  border-radius: 12px;
  padding: 12px 25px;
  box-shadow: 
    0 4px 15px rgba(255, 82, 82, 0.3),
    0 2px 5px rgba(0,0,0,0.1) inset !important;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  font-weight: 600;
  letter-spacing: 0.5px;
}

/* تأثير الإضاءة عند التحويم */
.input-actions button.btn-icon:hover {
  transform: translateY(-2px);
  box-shadow: 
    0 6px 20px rgba(0,0,0,0.15),
    0 3px 6px rgba(0,0,0,0.1) inset !important;
}

/* تأثير الضغط عند النقر */
.input-actions button.btn-icon:active {
  transform: translateY(1px);
  box-shadow: 
    0 2px 5px rgba(5,3,2,1) inset !important;
}

/* إضاءة حدود ديناميكية */
.input-actions button.btn-icon::after {
  content: '';
  position: absolute;
  top: -2px;
  left: -2px;
  right: -2px;
  bottom: -2px;
  border-radius: 12px;
  z-index: -1;
  background: linear-gradient(45deg, 
    rgba(255,255,255,0.3), 
    rgba(255,255,255,0.1),
    transparent);
  opacity: 0;
  transition: opacity 0.3s;
}

.input-actions button.btn-icon:hover::after {
  opacity: 1;
}

/* أيقونات متحركة */
.input-actions button.btn-icon i {
  transition: transform 0.3s ease;
  margin-left: 8px;
}

.input-actions button.btn-icon:hover i {
  transform: scale(1.2) rotate(-5deg);
}

/* تأثير إضاءة عند التركيز */
.input-actions button.btn-icon:focus {
  outline: none;
  animation: pulse-glow 1.5s infinite;
}

@keyframes advanced-vibration {
  0% { transform: translate(0, 6px) rotate(0); }
  25% { transform: translate(3px, 6px) rotate(1deg); }
  50% { transform: translate(-2px, 6px) rotate(-0.5deg); }
  75% { transform: translate(1px, 6px) rotate(0.5deg); }
  100% { transform: translate(0, 6px) rotate(0); }
}

.slider:before {
  position: absolute;
  content: "";
  height: 26px;
  width: 26px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  transition: .4s;
  border-radius: 50%;
}

input:checked + .slider {
  background-color: #f1c40f;
}

input:checked + .slider:before {
  transform: translateX(26px);
}

.theme-label {
  font-size: 24px;
  filter: drop-shadow(0 0 5px rgba(0,0,0,0.3));
}
.pulsating-marker {
    animation: pulse 1.5s infinite;
    text-shadow: 0 0 10px currentColor;
}

@keyframes pulse {
    0% { transform: scale(0.9); opacity: 0.8; }
    50% { transform: scale(1.2); opacity: 1; }
    100% { transform: scale(0.9); opacity: 0.8; }
}
.gm-style-iw-c {
    box-shadow: 0 0 20px rgba(0, 206, 209, 0.5) !important;
    border-radius: 15px !important;
    background: linear-gradient(145deg, #0a1a30, #0d2342) !important;
}

.gm-style .gm-style-iw-t::after {
    background: linear-gradient(145deg, #0a1a30, #0d2342) !important;
    box-shadow: -5px -5px 15px rgba(10, 26, 48, 0.5),
                5px 5px 15px rgba(0, 0, 0, 0.3) !important;
}
    .current-location-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 14px 18px;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 20px;
    cursor: pointer;
	  top: 22%;
        left: 5px;
      
  }

 

  .current-location-btn .icon {

    font-size: 25px;
  }
  #priceButton {
  background: linear-gradient(135deg, 
    #2c3e50 0%,    /* Dark Blue */
    #3498db 50%,   /* Royal Blue */
    #8e44ad 100%) !important; /* Purple */
  color: #000 !important;
  border: 2px solid rgba(255,255,255,0.2) !important;
  border-radius: 15px;
  box-shadow: 
    0 8px 32px rgba(44, 62, 80, 0.3),
    0 4px 12px rgba(255,255,255,0.1) inset;
  text-shadow: 0 2px 4px rgba(3,0,0,0.3);
  position: relative;
  overflow: hidden;
  transition: all 0.4s cubic-bezier(0.215, 0.61, 0.355, 1);
}

/* تأثير معدني لزر السعر */
#priceButton::after {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: linear-gradient(45deg, 
    transparent 25%,
    rgba(255,255,255,0.1) 50%,
    transparent 75%);
  transform: rotate(45deg);
  animation: price-shine 4s infinite linear;
}

@keyframes price-shine {
  0% { transform: translateX(-100%) rotate(45deg); }
  100% { transform: translateX(100%) rotate(45deg); }
}
/* زر المسح - تصميم داينميكي */
button[onclick="clearAll()"] {
  background: linear-gradient(135deg,
    #2d3436 0%,    /* Dark Gray */
    #636e72 100%) !important; /* Gray */
  color: #dfe6e9 !important;
  border: 2px solid #d63031 !important; /* Red Accent */
  border-radius: 15px;
  box-shadow: 
    0 8px 32px rgba(45, 52, 54, 0.3),
    0 4px 12px rgba(255,255,255,0.05) inset;
  transition: all 0.3s ease-in-out;
}

/* تأثيرات التحويم */
#priceButton:hover {
  transform: translateY(-3px) scale(1.05);
  box-shadow: 
    0 12px 40px rgba(44, 62, 80, 0.5),
    0 6px 20px rgba(255,255,255,0.15) inset;
}

button[onclick="clearAll()"]:hover {
  background: linear-gradient(135deg,
    #d63031 0%,    /* Red */
    #2d3436 100%) !important;
  border-color: #ff7675 !important; /* Light Red */
  color: white !important;
}

/* تأثيرات الضغط */
#priceButton:active {
  transform: translateY(6px) scale(0.96);
  filter: brightness(1.2);
}

button[onclick="clearAll()"]:active {
  transform: translateY(4px);
  background: linear-gradient(135deg,
    #c23616 0%,    /* Dark Red */
    #2d3436 100%) !important;
}

/* أنيميشن نبض لزر السعر */
@keyframes price-pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.02); }
  100% { transform: scale(1); }
}

#priceButton {
  animation: price-pulse 2.5s ease-in-out infinite;
}

/* إضاءة حدود تفاعلية */
button[onclick="clearAll()"] {
  position: relative;
}

button[onclick="clearAll()"]::before {
  content: '';
  position: absolute;
  top: -2px;
  left: -2px;
  right: -2px;
  bottom: -2px;
  border-radius: 15px;
  border: 2px solid rgba(214, 48, 49, 0.4);
  opacity: 0;
  transition: opacity 0.3s;
}

button[onclick="clearAll()"]:hover::before {
  opacity: 1;
}
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 25px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    gap: 15px;
    backdrop-filter: blur(10px);
    z-index: 5000;
    transition: all 0.3s ease;
    opacity: 1;
}

.notification.success {
    background: rgba(0, 206, 209, 0.9);
    border: 1px solid #00CED1;
    color: #fff;
}

.notification.error {
    background: rgba(255, 68, 68, 0.9);
    border: 1px solid #ff4444;
    color: #fff;
}

.notification-icon {
    font-size: 24px;
}

.notification-text {
    font-size: 16px;
    line-height: 1.4;
}
.input-field.invalid {
    animation: shake 0.5s;
    border: 2px solid #ff4444 !important;
    box-shadow: 0 0 10px rgba(255, 68, 68, 0.3) !important;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(5px); }
    75% { transform: translateX(-5px); }
}
.price-option .total-price {
    color: var(--accent-color);
    font-weight: bold;
    margin-top: 8px;
}

.vehicle-total {
    font-size: 1.2em;
    color: #00CED1;
}

#priceDisplay {
    background: rgba(255,255,255,0.1);
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
}

#priceDisplay p {
    margin: 10px 0;
    font-size: 16px;
}

    </style>
</head>
<body>
     <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<div class="control-panel">
    <div class="user-controls">
       <button class="profile-btn" onclick="window.location.href='profile.html'">
    <span class="profile-text">البروفيل</span>
    <i class="fas fa-chevron-left"></i> <!-- سهم للأنيميشن -->
</button>
    </div>
        <div class="control-panel">
    <div class="input-field">
	
        <div class="input-with-actions">
                <button class="current-location-btn" onclick="getCurrentLocation()">🎯</button>
            <input type="text" id="origin" placeholder="🟢 نقطه البدايه">

            <div class="input-actions">
                <button class="btn-icon map-select-btn" onclick="setSelectionMode('start')">
                    <i class="fas fa-map-marker-alt"></i>
                    اختيار من الخريطة
                </button>
                <button class="btn-icon current-location-btn" onclick="getCurrentLocation()">
                    <i class="fas fa-location-arrow"></i>
                </button>
            </div>
        </div>
    </div>
    
    <div class="input-field">
        <div class="input-with-actions">
            <input type="text" id="destination" placeholder="🔴 نقطه النهايه ">
            <div class="input-actions">
                <button class="btn-icon map-select-btn" onclick="setSelectionMode('end')">
                    <i class="fas fa-map-marker-alt"></i>
                    اختيار من الخريطة
                </button>
            </div>
        </div>
    </div>
</div>

    <div class="action-buttons">
        <button class="btn" id="priceButton" onclick="calculateRoute()">السعر</button>
        <button class="btn" onclick="clearAll()"> مسح</button>
	    <button class="btn" id="confirmRideBtn" style="display:none;" onclick="confirmRide()">تأكيد الرحلة</button>

    </div>
	<!-- أضف هذا في HTML -->
<div id="themeToggle" class="theme-toggle">
  <label class="switch">
    <input type="checkbox" id="themeSwitch">
    <span class="slider round"></span>
  </label>
  <span class="theme-label">🌙</span>
</div>

    <div class="route-info" id="routeInfo"></div>
     <div class="price-options" id="priceOptions">
    <div class="price-option" onclick="selectVehicle('normal', 5)">
        <h3>🚗 عادية</h3>
        <p class="total-price">0 جنيه</p>
    </div>
    <div class="price-option" onclick="selectVehicle('luxury', 10)">
        <h3>🚕 فاخرة</h3>
        <p class="total-price">0 جنيه</p>
    </div>
    <div class="price-option" onclick="selectVehicle('helicopter', 3)">
        <h3>🛵 سكوتر</h3>
        <p class="total-price">0 جنيه</p>
    </div>
</div>

    <div id="map"></div>

    <div class="booking-details" id="bookingDetails">
		    <div class="payment-options" id="paymentOptions">
        <div class="payment-option" onclick="selectPayment('electronic', event)">
            <h3>💳 الدفع الإلكتروني مع الكابتن</h3>
            <p>تأكيد فوري عبر المحفظة الإلكترونية</p>
        </div>
        <div class="payment-option" onclick="selectPayment('cash', event)">
            <h3>💵 الدفع نقدي</h3>
            <p>الدفع مباشرة للسائق نقداً عند الوصول</p>
        </div>
    </div>
  <button class="btn" id="confirmBookingButton" onclick="confirmTrip()" style="margin-top: 25px; width: 100%;">
    تأكيد الحجز الآن
  </button>
    </div>

    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
        <p style="margin-top: 20px; color: var(--primary-color);">جاري البحث ...</p>
    </div>

    <div class="driver-info" id="driverInfo">
        <h3>معلومات السائق</h3>
        <p id="driverName">الاسم: -</p>
        <p id="driverCar">السيارة: -</p>
        <p id="driverPhone">الهاتف: -</p>
	</div>

<!-- أضف هذا الجزء تحت عنصر driver-info -->
    <div class="persistent-notification" id="persistentNotification">
      <h3>حالة الرحلة</h3>
      <div id="tripStatusContent"></div>
       <button class="btn" onclick="clearAll()" style="margin-top:15px;">إلغاء الرحلة</button>
    </div>		
    <div id="arrivalNotification" class="notification" style="display: none;">
    <div class="notification-content">
        <span>🎉 تم وصول السائق إلى نقطة البداية!</span>
	    <div id="driverArrivalInfo"></div>
        <button class="btn confirm-btn" onclick="handleArrivalConfirmation()">موافق</button>
    </div>
	
    <audio id="notificationSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" loop></audio>
    </div>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAeQx0Ke798anRT_6xAwB-ViewDVb8Jq0U&libraries=places,geometry&callback=initMap" async defer></script>    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCAwPCVPaxoTEV4n4APATlIKh3ppjMeZpk",
            authDomain: "data-c4c20.firebaseapp.com",
            databaseURL: "https://data-c4c20-default-rtdb.firebaseio.com",
            projectId: "data-c4c20",
            storageBucket: "data-c4c20.firebasestorage.app",
            messagingSenderId: "905131784305",
            appId: "1:905131784305:web:440e06647294b0d5e543d0"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let map, directionsService, driverDirectionsRenderer, directionsRenderer;
        let startMarker, endMarker, currentLocationMarker;
        let selectedVehicle = null;
        let currentPricePerKm = 0;
        let totalDistance = 0;
        let selectionMode = null;
        let geocoder;
        let currentLocationCoords = null;
        let tripListener = null;
        let driverLocationListener = null;
        let driverRoutePolyline = null;
        let destinationMarker;
        let arrivalSound = null; // متغير لتتبع حالة الصوت
        let driverPathCoordinates = [];
        let driverPathPolyline = null;
		let currentTripId = localStorage.getItem('currentTripId') || null;
        let selectedPayment = null;
       let mapInitialized = false;
	   let isGhostCleaned = false;
           let driverMarker = null;
		   let isTripActive = false;
		   

        let tempMarker = null;
	   let originalMapState = {
       height: '',
       width: '',
       margin: '',
       borderRadius: '',
       position: '',
       top: '',
       left: ''
        };
		
		    document.getElementById('priceOptions').style.display = 'none';


// التحقق من تسجيل الدخول عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', () => {
            const isLoggedIn = localStorage.getItem('isLoggedIn');
          const userId = localStorage.getItem('userId');
    
             if (!isLoggedIn || !userId) {
              window.location.href = 'login.html';
             } else {
                  console.log('User ID on map page:', userId); // للتأكد من وجود القيمة
            }
        });


	  
      const mapStyles = {
                night: [
                    {
                        "elementType": "geometry",
                        "stylers": [
                            { "color": "#000000" },
                            { "lightness": -20 }
                        ]
                    },
                    {
                        "elementType": "labels.text.fill",
                        "stylers": [
                            { "color": "#cccccc" },
                            { "fontweight": "bold" }
                        ]
                    },
                    {
                        "elementType": "labels.text.stroke",
                        "stylers": [
                            { "color": "#1a1a1a" },
                            { "weight": 1.5 }
                        ]
                    },
                    {
                        "featureType": "road",
                        "elementType": "geometry",
                        "stylers": [
                            { "color": "#1a1a1a" },
                            { "weight": 2.5 },
                            { "gamma": 1.8 }
                        ]
                    },
                    {
                        "featureType": "water",
                        "elementType": "geometry",
                        "stylers": [
                            { "color": "#003366" },
                            { "lightness": -20 },
                            { "hue": "#0066ff" },
                            { "gamma": 1.8 }
                        ]
                    },
                    {
                        "featureType": "poi",
                        "stylers": [{ "visibility": "off" }]
                    },
                    {
                        "featureType": "transit",
                        "stylers": [{ "visibility": "off" }]
                    },
                    {
                        "featureType": "administrative",
                        "elementType": "labels",
                        "stylers": [{ "visibility": "simplified" }]
                    }
                ],
                day: [
                    {
                        "elementType": "geometry",
                        "stylers": [
                            { "color": "#f5f5f5" },
                            { "lightness": 50 }
                        ]
                    },
                    {
                        "elementType": "labels.text.fill",
                        "stylers": [
                            { "color": "#2d3436" },
                            { "weight": 0.5 }
                        ]
                    },
                    {
                        "elementType": "labels.text.stroke",
                        "stylers": [
                            { "color": "#ffffff" },
                            { "weight": 1 }
                        ]
                    },
                    {
                        "featureType": "road",
                        "elementType": "geometry",
                        "stylers": [
                            { "color": "#dfe6e9" },
                            { "weight": 1.2 }
                        ]
                    },
                    {
                        "featureType": "water",
                        "elementType": "geometry",
                        "stylers": [
                            { "color": "#a0d2eb" },
                            { "lightness": 20 }
                        ]
                    }
                ]
            };
 // الدالة الرئيسية لتهيئة الخريطة - تحتاج للتعديل
function initMap() {
    // محاولة الحصول على الموقع الحالي أولاً
	    // تهيئة الخريطة مباشرة بإحداثيات افتراضية
    const defaultCenter = { lat: 30.0444, lng: 31.2357 }; // إحداثيات القاهرة
    initializeMap(defaultCenter);
    
        getCurrentLocationSilently();

    }
async function getCurrentLocationSilently() {
    if (!navigator.geolocation) return;
    
    try {
        const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 30000
            });
        });
        
        // تحديث الخريطة بعد الحصول على الإحداثيات
        const userLocation = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
        };
        map.setCenter(userLocation);
        startMarker.setPosition(userLocation);
        startMarker.setMap(map);
        
        // تحديث العنوان في الخلفية دون انتظار
        updateAddressAsync(userLocation);
        
    } catch (error) {
        console.log('الموقع الحالي غير متاح، استخدام الموقع الافتراضي');
    }
}

async function updateAddressAsync(location) {
    try {
        const results = await new Promise((resolve, reject) => {
            geocoder.geocode({ location }, (results, status) => {
                status === 'OK' ? resolve(results) : reject(status);
            });
        });
        document.getElementById('origin').value = results[0]?.formatted_address || "الموقع الحالي";
    } catch (error) {
        console.log('فشل في الحصول على العنوان');
    }
}
// دالة مساعدة لتهيئة الخريطة - جديدة
function initializeMap(center) {
    const savedTheme = localStorage.getItem('mapTheme') || 'night';
    map = new google.maps.Map(document.getElementById('map'), {
        center: center,
        zoom: 15,
        styles: mapStyles[savedTheme],
        disableDefaultUI: true,
        gestureHandling: "greedy",
        mapTypeControlOptions: {
            mapTypeIds: []
        }
    });

    // تهيئة باقي العناصر
    initializeMapComponents();
    setupThemeToggle(savedTheme);
    setupAutocomplete();
    setupEventListeners();
    
    // إضافة علامة الموقع الحالي إذا كان مختلفًا عن الافتراضي
    if (center.lat !== 30.0444) {
        startMarker.setPosition(center);
        startMarker.setMap(map);
    }
}

        function initializeMapComponents() {
            geocoder = new google.maps.Geocoder();
            directionsService = new google.maps.DirectionsService();
            
            directionsRenderer = new google.maps.DirectionsRenderer({
                     suppressMarkers: true,
                polylineOptions: {
                    strokeColor: "#4285F4",
                    strokeOpacity: 0.9,
                    strokeWeight: 8,
                    icons: [{
                        icon: {
                            path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                            scale: 3,
                            fillColor: "#00FF00",
                            strokeColor: "#FFFFFF"
                        },
                        offset: '100%',
                        repeat: '100px'
                    }]
                }
            });

            driverDirectionsRenderer = new google.maps.DirectionsRenderer({
                suppressMarkers: true,
                polylineOptions: {
                    strokeColor: "#FFA500",
                    strokeOpacity: 0.8,
                    strokeWeight: 7
                }
            });

            startMarker = createMarker('#4CAF50', 2.5);
            endMarker = createMarker('#FF5252', 2.2);

            trafficLayer = new google.maps.TrafficLayer();
            trafficLayer.setMap(map);
            setInterval(() => {
                trafficLayer.setMap(null);
                trafficLayer.setMap(map);
            }, 60000);
        }
		// دالة التحقق من صحة المدخلات
async function validateInputs() {
    const origin = document.getElementById('origin').value;
    const destination = document.getElementById('destination').value;
    
    // التحقق من عدم الفراغ
    if (!origin && !currentLocationCoords) {
        showNotification('الرجاء تحديد نقطة البداية', true);
        document.getElementById('origin').parentNode.style.border = "2px solid #ff4444";
        return false;
    }
    
    if (!destination) {
        showNotification('الرجاء تحديد نقطة النهاية', true);
        document.getElementById('destination').parentNode.style.border = "2px solid #ff4444";
        return false;
    }

    // التحقق من صحة العناوين
    try {
        if (!currentLocationCoords) {
            const originGeo = await geocodeAddress(origin);
            if (!originGeo) {
                showNotification('عنوان البداية غير صحيح', true);
                document.getElementById('origin').parentNode.style.border = "2px solid #ff4444";
                return false;
            }
        }
        
        const destGeo = await geocodeAddress(destination);
        if (!destGeo) {
            showNotification('عنوان النهاية غير صحيح', true);
            document.getElementById('destination').parentNode.style.border = "2px solid #ff4444";
            return false;
        }
        
        return true;
    } catch (error) {
        console.error('Validation error:', error);
        showNotification('حدث خطأ أثناء التحقق من العناوين', true);
        return false;
    }
}

// دالة مساعدة للجيوكود
function geocodeAddress(address) {
    return new Promise((resolve, reject) => {
        geocoder.geocode({ address }, (results, status) => {
            if (status === 'OK' && results[0]) {
                resolve(results[0].geometry.location);
            } else {
                resolve(null);
            }
        });
    });
}
function showNotification(message, isError = false) {
    const notification = document.createElement('div');
    notification.className = `notification ${isError ? 'error' : 'success'}`;
    notification.innerHTML = `
        <div class="notification-icon">${isError ? '⚠️' : '✅'}</div>
        <div class="notification-text">${message}</div>
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 300);
    }, 4000);
}

        function createMarker(color, scale) {
            return new google.maps.Marker({
                icon: {
                    path: "M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z",
                    fillColor: color,
                    fillOpacity: 0.9,
                    strokeColor: "#ffffff",
                    strokeWeight: 2,
                    scale: scale,
                    anchor: new google.maps.Point(12, 24)
                },
                zIndex: 999,
                optimized: false
            });
        }

        function setupThemeToggle(savedTheme) {
            const isDayMode = savedTheme === 'day';
            document.getElementById('themeSwitch').checked = isDayMode;
            document.querySelector('.theme-label').textContent = isDayMode ? '🌞' : '🌙';
            document.body.className = isDayMode ? 'day-mode' : 'night-mode';

            document.getElementById('themeSwitch').addEventListener('change', (e) => {
                const isDayMode = e.target.checked;
                toggleTheme(isDayMode);
            });
        }

        function toggleTheme(isDayMode) {
            const theme = isDayMode ? 'day' : 'night';
            map.setOptions({ styles: mapStyles[theme] });
            
            startMarker.setIcon({
                ...startMarker.getIcon(),
                fillColor: isDayMode ? "#4CAF50" : "#4CAF50"
            });

            endMarker.setIcon({
                ...endMarker.getIcon(),
                fillColor: isDayMode ? "#FF5252" : "#FF5252"
            });

            directionsRenderer.setOptions({
                polylineOptions: {
                    strokeColor: isDayMode ? "#2d3436" : "#FF00FF"
                }
            });

            document.body.className = isDayMode ? 'day-mode' : 'night-mode';
            document.querySelector('.theme-label').textContent = isDayMode ? '🌞' : '🌙';
            localStorage.setItem('mapTheme', theme);
        }

        function setupAutocomplete() {
            const originInput = document.getElementById('origin');
            const destinationInput = document.getElementById('destination');
            
            const autocompleteOptions = {
                componentRestrictions: { country: "eg" },
                fields: ["formatted_address", "geometry"],
                types: ["geocode"]
            };

            const originAutocomplete = new google.maps.places.Autocomplete(originInput, autocompleteOptions);
            const destinationAutocomplete = new google.maps.places.Autocomplete(destinationInput, autocompleteOptions);

            originAutocomplete.addListener('place_changed', () => handlePlaceSelect(originAutocomplete, startMarker));
            destinationAutocomplete.addListener('place_changed', () => handlePlaceSelect(destinationAutocomplete, endMarker));
        }

        function handlePlaceSelect(autocomplete, marker) {
            const place = autocomplete.getPlace();
            if (place.geometry) {
                marker.setPosition(place.geometry.location);
                marker.setMap(map);
                map.panTo(place.geometry.location);
            }
        }

        function setupEventListeners() {
            map.addListener('click', (e) => {
                if (selectionMode) handleMapClick(e.latLng);
            });

            window.addEventListener('load', restorePreviousTrip);
            
            if (currentTripId) {
                setupTripListener();
                restoreTripState();
            }

            database.ref('rides').on('value', drawTripHotspots);
        }
			
			// في بداية ملف الخريطة

      function handleMapClick(latLng) {
        if (!selectionMode) return;

    // إزالة العلامة المؤقتة السابقة
    if (tempMarker) tempMarker.setMap(null);

    // إنشاء علامة مؤقتة مع تأثير
    tempMarker = new google.maps.Marker({
        position: latLng,
        map: map,
        icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 12,
            fillColor: selectionMode === 'start' ? '#4CAF50' : '#FF5252',
            fillOpacity: 0.8,
            strokeColor: '#fff',
            strokeWeight: 2
        },
        animation: google.maps.Animation.DROP,
        zIndex: 999
    });

    // عرض تفاصيل الموقع
    const geocoder = new google.maps.Geocoder();
    geocoder.geocode({location: latLng}, (results, status) => {
        const address = status === 'OK' && results[0] ? 
            results[0].formatted_address : 
            'موقع غير معروف';

        const infoWindow = new google.maps.InfoWindow({
            content: `
                <div class="location-info">
                    <h3>${selectionMode === 'start' ? 'بداية الرحلة' : 'نهاية الرحلة'}</h3>
                    <p>${address}</p>
                    <button onclick="confirmLocation('${selectionMode}')">
                        تأكيد هذا الموقع
                    </button>
                </div>
            `
        });
        
        infoWindow.open(map, tempMarker);
    });
}
function confirmLocation(mode) {
    if (!tempMarker) return;

    const position = tempMarker.getPosition();
    const fieldId = mode === 'start' ? 'origin' : 'destination';
    
    // تحديث الحقل المعني
    document.getElementById(fieldId).value = 'جاري تحديد العنوان...';
    
    // البحث العكسي للحصول على العنوان
    new google.maps.Geocoder().geocode({location: position}, (results) => {
        if (results[0]) {
            document.getElementById(fieldId).value = results[0].formatted_address;
            
            // تحديث العلامة الدائمة
            if (mode === 'start') {
                startMarker.setPosition(position);
                startMarker.setMap(map);
            } else {
                endMarker.setPosition(position);
                endMarker.setMap(map);
            }
        }
        
        // تنظيف المؤقتات
        tempMarker.setMap(null);
        map.setOptions({draggableCursor: 'grab'});
        selectionMode = null;
    });
}
// دالة معالجة أخطاء الموقع - جديدة
function handleGeolocationError(error) {
    let message = '';
    switch(error.code) {
        case error.PERMISSION_DENIED:
            message = 'تم رفض طلب الحصول على الموقع';
            break;
        case error.POSITION_UNAVAILABLE:
            message = 'معلومات الموقع غير متوفرة';
            break;
        case error.TIMEOUT:
            message = 'انتهت المهلة المحددة للحصول على الموقع';
            break;
        default:
            message = 'حدث خطأ غير معروف أثناء الحصول على الموقع';
    }
    showNotification(message, true);
}
		 function confirmRide() {
              document.getElementById('persistentNotification').style.display = 'none';
              clearAll();
              showNotification('تم تأكيد الرحلة بنجاح!');
         }
        function getCurrentLocation() {
    return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
            reject('المتصفح لا يدعم خدمة الموقع');
            return;
        }

        showLoading(true);
        
        navigator.geolocation.getCurrentPosition(
            async (position) => {
                try {
                    currentLocationCoords = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    // تحديث واجهة المستخدم أولاً
                    startMarker.setPosition(currentLocationCoords);
                    startMarker.setMap(map);
                    map.panTo(currentLocationCoords);

                    // الحصول على العنوان
                    const results = await new Promise((resolve, reject) => {
                        geocoder.geocode({ location: currentLocationCoords }, (results, status) => {
                            if (status === 'OK') resolve(results);
                            else reject(status);
                        });
                    });

                    document.getElementById('origin').value = results[0]?.formatted_address || "الموقع الحالي";
                    resolve(currentLocationCoords);

                } catch (error) {
                    console.error('Geocoding error:', error);
                    document.getElementById('origin').value = "الموقع الحالي";
                    showNotification('تم تحديد الموقع بالإحداثيات الجغرافية', false);
                    resolve(currentLocationCoords);
                } finally {
                    showLoading(false);
                }
            },
            (error) => {
                showLoading(false);
                handleGeolocationError(error);
                reject(error);
            },
            {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            }
        );
    });
}

        function setSelectionMode(mode) {
             selectionMode = mode;
    document.querySelectorAll('.map-select-btn').forEach(btn => 
        btn.classList.remove('active'));
    document.querySelector(`[onclick="setSelectionMode('${mode}')"]`)
        .classList.add('active');
    
    // تغيير شكل المؤشر
    map.setOptions({draggableCursor: 'crosshair'});
    showNotification(`انقر على الخريطة لتحديد ${mode === 'start' ? 'نقطة البداية' : 'نقطة النهاية'}`);
}

        async function calculateRoute() {
		    document.querySelectorAll('.input-field').forEach(field => {
        field.style.border = "none";
    });

    // التحقق من الصحة
    const isValid = await validateInputs();
    if (!isValid) return;
		    const mapElement = document.getElementById('map');
    originalMapState = {
        height: mapElement.style.height,
        width: mapElement.style.width,
        margin: mapElement.style.margin,
        borderRadius: mapElement.style.borderRadius,
        position: mapElement.style.position,
        top: mapElement.style.top,
        left: mapElement.style.left
    };
		 document.querySelector('.profile-btn').style.display = 'none';
    document.getElementById('map').classList.add('full-screen-map');
    document.getElementById('priceButton').style.display = 'none';

    let origin = document.getElementById('origin').value;
    const destination = document.getElementById('destination').value;
    document.querySelector('.control-panel').style.opacity = '1';

    if ((!origin && !currentLocationCoords) || !destination) {
        showNotification('الرجاء تحديد نقطتي البداية والنهاية', true);
        return;
    }

    showLoading(true);

    try {
        let originLocation;
        
        // تحديد مصدر الإحداثيات
        if (currentLocationCoords) {
            originLocation = new google.maps.LatLng(
                currentLocationCoords.lat,
                currentLocationCoords.lng
            );
        } else {
            // جيوكود للعنوان اليدوي
            const geocodeResult = await new Promise((resolve, reject) => {
                geocoder.geocode({ address: origin }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        resolve(results[0].geometry.location);
                    } else {
                        reject('فشل في تحديد موقع البداية');
                    }
                });
            });
            originLocation = geocodeResult;
        }

        // جيوكود للنهاية
        const destinationResult = await new Promise((resolve, reject) => {
            geocoder.geocode({ address: destination }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    resolve(results[0].geometry.location);
                } else {
                    reject('فشل في تحديد موقع النهاية');
                }
            });
        });

        const request = {
            origin: originLocation,
            destination: destinationResult,
            travelMode: 'DRIVING'
        };

        const response = await directionsService.route(request);
        
        // عرض النتائج
        directionsRenderer.setMap(map);
        directionsRenderer.setDirections(response);
        
        // حساب المسافة والسعر
        const route = response.routes[0].legs[0];
        totalDistance = route.distance.value / 1000;
            updatePriceOptions(totalDistance);

        // عرض خيارات السعر
        document.getElementById('priceOptions').style.display = 'block';
        document.querySelectorAll('.input-field').forEach(field => {
            field.style.display = 'none';
        });
        // تحديث واجهة المستخدم
        map.fitBounds(response.routes[0].bounds);
        startMarker.setPosition(originLocation);
        endMarker.setPosition(destinationResult);
        totalDistance = route.distance.value / 1000; // المسافة بالكيلومترات
        
        // تحديث الأسعار بناء على المسافة
        updatePriceOptions(totalDistance);
        
        // عرض خيارات السعر
        document.getElementById('priceOptions').style.display = 'flex';
    } catch (error) {
        console.error('Error:', error);
        showNotification('فشل في حساب المسار: ' + error.message, true);
    } finally {
        showLoading(false);
    }
}
function updatePriceOptions(distance) {
     const vehicles = {
        normal: 5,
        luxury: 10,
        helicopter: 3
    };

    Object.entries(vehicles).forEach(([type, price]) => {
        const total = (distance * price).toFixed(1);
        document.querySelector(`[onclick="selectVehicle('${type}', ${price})"] .total-price`).textContent = `${total} جنيه`;
    });
}

        function selectVehicle(type, price) {
            selectedVehicle = type;
            currentPricePerKm = price;
                const totalPrice = (totalDistance * currentPricePerKm).toFixed(1);

            document.querySelectorAll('.price-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
             

		      // إظهار قسم تفاصيل الحجز وخيارات الدفع
    document.getElementById('bookingDetails').style.display = 'block';
    document.getElementById('priceOptions').style.display = 'none';
    
    // إعادة تعيين خيارات الدفع
    document.querySelectorAll('.payment-option').forEach(option => {
        option.classList.remove('selected');
    });
    document.getElementById('confirmBookingButton').style.display = 'none';
    selectedPayment = null;
}

        function showBookingDetails() {
            const totalPrice = (totalDistance * currentPricePerKm).toFixed(2);
            
              document.getElementById('bookingDetails').style.display = 'block';
              document.getElementById('priceOptions').style.display = 'none';
            // إعادة تعيين خيارات الدفع
             document.querySelectorAll('.payment-option').forEach(option => {
             option.classList.remove('selected');
          });
          document.getElementById('confirmBookingButton').style.display = 'none';
          selectedPayment = null;
		       document.querySelector('.profile-btn').style.display = 'none';
		}

        async function confirmTrip() {
		
            if (!selectedVehicle) {
                showNotification('الرجاء اختيار نوع الخدمة أولاً', true);
                return;
            }
		    if (!selectedPayment) {
               showNotification('الرجاء اختيار طريقة الدفع', true);
              return;
            }
            const userId = localStorage.getItem('userId');
               if (!userId) {
                  alert('يجب تسجيل الدخول أولاً');
                 window.location.href = 'login.html';
            }

            showLoading(true);
        // إخفاء العناصر هنا
		     document.querySelector('.profile-btn').style.display = 'none';
                                                document.querySelector('.action-buttons').style.display = 'none';
      			  document.getElementById('map').style.display = 'block'; // إضافة هذا السطر
       			  document.querySelector('.input-field').style.display = 'none';
                  document.getElementById('origin').parentNode.style.display = 'none';
                   document.getElementById('destination').parentNode.style.display = 'none';
          document.getElementById('persistentNotification').style.display = 'block';
          document.getElementById('tripStatusContent').innerHTML = `
           <h3>جاري البحث عن سائق...</h3>
            <div class="loading-spinner"></div>
          `;  
		  
		            document.getElementById('bookingDetails').style.display = 'none';

            const tripData = {
                start: document.getElementById('origin').value,
			    userId: userId, // تم إضافة معرف المستخدم هنا
                end: document.getElementById('destination').value,
                vehicleType: selectedVehicle,
                price: (totalDistance * currentPricePerKm).toFixed(2),
                distance: totalDistance,
                status: "new",
    	        paymentMethod: selectedPayment, // إضافة طريقة الدفع
                startLocation: startMarker.getPosition().toJSON(),
				endLocation: endMarker.getPosition().toJSON(), // إضافة هذا السطر
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            try {
                let newTripRef = database.ref(`rides/${userId}`).push();
                await newTripRef.set(tripData);
                currentTripId = newTripRef.key;
                localStorage.setItem('currentTripId', currentTripId); // التحديث هنا

                setupTripListener();
                showNotification('جاري البحث عن سائق...');
                 document.querySelector('.profile-btn').style.display = 'none';
 document.querySelector('.action-buttons').style.display = 'none';
      			  document.getElementById('map').style.display = 'block'; // إضافة هذا السطر
       			  document.querySelector('.input-field').style.display = 'none';
                  document.getElementById('origin').parentNode.style.display = 'none';
                   document.getElementById('destination').parentNode.style.display = 'none';
          document.getElementById('persistentNotification').style.display = 'block';
          document.getElementById('tripStatusContent').innerHTML = `
           <h3>جاري البحث عن سائق...</h3>
            <div class="loading-spinner"></div>
          `;

          document.getElementById('bookingDetails').style.display = 'nono';

            } catch (error) {
                showNotification('حدث خطأ في تأكيد الرحلة', true);
                console.error('Error confirming trip:', error);
            } finally {
                showLoading(false);
            }
        }

// دالة مسح العناصر
function clearMapElements() {
    if (directionsRenderer) directionsRenderer.setMap(null);
    if (driverDirectionsRenderer) driverDirectionsRenderer.setMap(null);
    if (startMarker) startMarker.setMap(null);
    if (endMarker) endMarker.setMap(null);
    if (driverMarker) driverMarker.setMap(null);
    if (driverRoutePolyline) driverRoutePolyline.setMap(null);
}
// أضف هذا الكود في بداية ملف script الخاص بك
let wakeLock = null;

// دالة لتفعيل منع قفل الشاشة
async function enableWakeLock() {
    try {
        if ('wakeLock' in navigator) {
            wakeLock = await navigator.wakeLock.request('screen');
            
            // إعادة تفعيل عند استعادة الاتصال
            document.addEventListener('visibilitychange', async () => {
                if (wakeLock !== null && document.visibilityState === 'visible') {
                    await enableWakeLock();
                }
            });
            
            console.log('Screen Wake Lock activated!');
        }
    } catch (err) {
        console.error('Error enabling wake lock:', err);
    }
}

// تشغيل المنع عند تحميل الصفحة
window.addEventListener('load', () => {
    enableWakeLock();
    
    // تفعيل إضافي عند أي تفاعل مستخدم
    document.addEventListener('click', enableWakeLock);
    document.addEventListener('touchstart', enableWakeLock);
});

// Optional: إيقاف المنع عند إغلاق الصفحة
window.addEventListener('beforeunload', () => {
    if (wakeLock) {
        wakeLock.release();
        wakeLock = null;

    }
});
        function setupTripListener() {
          const userId = localStorage.getItem('userId');
          const tripRef = database.ref(`rides/${userId}/${currentTripId}`);       
             tripListener = tripRef.on('value', async (snapshot) => {
             const tripData = snapshot.val();
			  // إذا تم حذف الرحلة من قاعدة البيانات
               if (!tripData) {
                 localStorage.removeItem('currentTripId');
                 currentTripId = null;
                 clearAll();
                 return;
                }
				
				
             if (!tripData) return;
			 if (tripData.status === "com") {
			     document.getElementById('map').classList.add('full-screen-map');

			    document.getElementById('persistentNotification').style.display = 'nono';
				     document.querySelector('.profile-btn').style.display = 'none';
			       clearDriverTracking();
				       if (startMarker) startMarker.setMap(null);
                     if (endMarker) endMarker.setMap(null);
                    if (directionsRenderer) directionsRenderer.setMap(null);
    
    //   تكبي ر الخريطة على نقطة البداية
                      const startLatLng = new google.maps.LatLng(
                      tripData.startLocation.lat,
                      tripData.startLocation.lng
                   );
     
                       map.setCenter(startLatLng);
                       map.setZoom(17); // مستوى التكبير المطلوب
    
  const driverId = tripData.driverId;
  const driverLocationRef = database.ref(`drives/${driverId}/location`);

  // متغير لتخزين ماركَر السائق

  // استمع لكل تغيير في موقع السائق
  driverLocationRef.on('value', (snapshot) => {
    const loc = snapshot.val();
    if (!loc) return;

    const pos = new google.maps.LatLng(loc.lat, loc.lng);

    if (!driverMarker) {
      // إنشاء ماركَر أول مرة
      driverMarker = new google.maps.Marker({
        position: pos,
        map: map,
        icon: {
          url: "https://maps.gstatic.com/mapfiles/kml/shapes/cabs.png",
          scaledSize: new google.maps.Size(40, 40),
          anchor: new google.maps.Point(20, 20),
        },
        title: 'موقع السائق الحالي'
      });
    } else {
      // فقط حدّث الموقع
      driverMarker.setPosition(pos);
    }

    // اختياري: تحريك مركز الخريطة ليناسب الماركَر
    // map.panTo(pos);
  });

                   showArrivalNotification(tripData.driverId); // <-- هنا تم إصلاح الخطأ
				   document.querySelector('.action-buttons').style.display = 'none';
      			  document.getElementById('map').style.display = 'block'; // إضافة هذا السطر
       			  document.querySelector('.input-field').style.display = 'none';
                  document.getElementById('origin').parentNode.style.display = 'none';
                   document.getElementById('destination').parentNode.style.display = 'none';
                     document.querySelector('.profile-btn').style.display = 'none';
                    return;
                }
                if (tripData.status === "end") {
				          if (driverLocationListener) {
                database.ref(`drives/${tripData.driverId}/location`).off('value', driverLocationListener);
                driverLocationListener = null;
            }

				    cleanGhostMapElements();
				    // مسح علامة السائق والمسارات
    if (driverMarker) {
        driverMarker.setMap(null);
        driverMarker = null;
    }
    if (driverDirectionsRenderer) {
        driverDirectionsRenderer.setMap(null);
        driverDirectionsRenderer = null;
    }
    if (driverRoutePolyline) {
        driverRoutePolyline.setMap(null);
        driverRoutePolyline = null;
    }
	   if(driverDirectionsRenderer) {
        driverDirectionsRenderer.setMap(null);
        driverDirectionsRenderer = null;
    }
    
    if(directionsRenderer) {
        directionsRenderer.setMap(null);
        directionsRenderer = null;
    }
    
				     document.querySelector('.profile-btn').style.display = 'none';
		            document.getElementById('map').style.display = 'none';
                    document.querySelector('.control-panel').style.display = 'none';
                    document.querySelector('.action-buttons').style.display = 'none';
                    document.getElementById('routeInfo').style.display = 'none';
                    document.getElementById('persistentNotification').style.display = 'none';
                   showEndNotification(tripData.price);
            // إيقاف جميع المستمعين
                   tripRef.off('value', tripListener);
                if (driverLocationListener) {
                   database.ref(`drives/${tripData.driverId}/location`).off('value', driverLocationListener);
                }
                     return;
                }
				        // إضافة حالة ready هنا
                if (tripData.status === "ready") {
				 
 // إزالة العلامة من الخريطة وإعادة تعيين المرجع
  if (driverMarker) {
    driverMarker.setMap(null);
    driverMarker = null;
  }

				    document.getElementById('map').classList.add('full-screen-map');
                    
				     document.querySelector('.profile-btn').style.display = 'none';
                    clearMapElements();				
			       clearDriverTracking();
				  if (startMarker) startMarker.setMap(null);
                     if (endMarker) endMarker.setMap(null);
                    if (directionsRenderer) directionsRenderer.setMap(null);
                         if (driverMarker) driverMarker.setMap(null);

				  document.querySelector('.action-buttons').style.display = 'none';
      			  document.getElementById('map').style.display = 'block'; // إضافة هذا السطر
       			  document.querySelector('.input-field').style.display = 'none';
                  document.getElementById('origin').parentNode.style.display = 'none';
                   document.getElementById('destination').parentNode.style.display = 'none';
                   document.getElementById('persistentNotification').style.display = 'nono';

					    trackDriverToDestination(
                        tripData.driverId,
                         tripData.endLocation
                        );
   // تحديث الإشعار الدائم
    document.getElementById('persistentNotification').style.display = 'nono';
    document.getElementById('tripStatusContent').innerHTML = `
        <h3>جاهز للانطلاق!</h3>
        <p>تم تحديث المسار حسب الموقع الحالي للسائق</p>
        <p>جاري التوجه إلى الوجهة النهائية</p>
    `;
    
						    // تحديث مركز الخريطة
                  const bounds = new google.maps.LatLngBounds();
                   bounds.extend(tripData.startLocation);
                   bounds.extend(tripData.endLocation);
                   map.fitBounds(bounds, {padding: 100});
                }

             if (tripData.status === "accepted" && tripData.driverId) {
                try {
                // إخفاء العناصر القديمة
                   directionsRenderer.setMap(null);
                   startMarker.setMap(map);
                   endMarker.setMap(null);
                  
				  
				  startMarker.setPosition(tripData.startLocation); // تحديث الإحداثيات
				       document.querySelector('.profile-btn').style.display = 'none';
                // إخفاء عناصر الواجهة
                   document.querySelector('.action-buttons').style.display = 'none';
			       document.getElementById('map').style.display = 'block'; // إضافة هذا السطر
		   	       document.querySelector('.input-field').style.display = 'none';
                   document.getElementById('origin').parentNode.style.display = 'none';
                  document.getElementById('destination').parentNode.style.display = 'none';
                 // جلب بيانات السائق 
                   const driverSnapshot = await database.ref(`drives/${tripData.driverId}`).once('value');
                   const driverData = driverSnapshot.val();
                // عرض البيانات في منطقة الإشعارات الدائمة
                   document.getElementById('persistentNotification').style.display = 'block';
                   document.getElementById('tripStatusContent').innerHTML = `
                      <p>الاسم: ${driverData.fullName}</p>
                      <p>السيارة: ${driverData.carModel}</p>
                      <p>الهاتف: ${driverData.phoneNumber}</p>
				      <p>طريقة الدفع: ${tripData.paymentMethod === 'electronic' ? 'إلكتروني' : 'نقدي'}</p>
                      <div id="distanceInfo">جاري حساب المسافة...</div>
                   `;

                // بدء تتبع الموقع
                trackDriverLocation(tripData.driverId, tripData.startLocation);
                   document.getElementById('persistentNotification').style.display = 'block';

                } catch (error) {
                   console.error('Error:', error);
              }
            }
          });   
        }

		async function trackDriverToDestination(driverId, endLocation) {
    // إزالة أي مسارات سابقة
	
    if (directionsRenderer) {
        directionsRenderer.setMap(null);
    }
        if (driverMarker) {
        driverMarker.setMap(null);
        driverMarker = null;
    }

    // إنشاء renderer جديد
    directionsRenderer = new google.maps.DirectionsRenderer({
        suppressMarkers: true,
        polylineOptions: {
            strokeColor: "#4285F4",
            strokeOpacity: 0.9,
            strokeWeight: 7
        }
    });
    
    // متابعة تحديثات موقع السائق
    const driverRef = database.ref(`drives/${driverId}/location`);
    driverRef.on('value', async (snapshot) => {
        const driverLoc = snapshot.val();
        if (!driverLoc) return;
        
        try {
            // تحديث المسار من الموقع الحالي إلى النهاية
            const request = {
                origin: new google.maps.LatLng(driverLoc.lat, driverLoc.lng),
                destination: endLocation,
                travelMode: 'DRIVING'
            };
            
            const response = await directionsService.route(request);
            
            // تحديث العلامات
            if (driverMarker) driverMarker.setMap(null);
              if (directionsRenderer) {
    directionsRenderer.setMap(null);
  }
  if (endMarker) {
    endMarker.setMap(null);
  }

  // إنشاء renderer جديد
  directionsRenderer = new google.maps.DirectionsRenderer({
    suppressMarkers: true,
    polylineOptions: {
        strokeColor: "#9C27B0",
        strokeOpacity: 0.8,
        strokeWeight: 6,
        strokeDashArray: [10, 5],
        icons: [{
            icon: {
                path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                scale: 3,
                strokeColor: "#4A148C",
                fillColor: "#E1BEE7",
                fillOpacity: 1
            },
            offset: "100%",
            repeat: "50px"
        }]
    }
});    
	driverMarker = new google.maps.Marker({
                position: request.origin,
                map: map,
                icon: {
                    url: 'https://maps.gstatic.com/mapfiles/kml/shapes/cabs.png',
                    scaledSize: new google.maps.Size(40, 40)
                }
            });
            
            // عرض المسار المحدث
            directionsRenderer.setOptions({
                map: map,
                directions: response
            });
endMarker = new google.maps.Marker({
        position: endLocation,
        map: map,
        title: 'نقطة الوصول',
            icon: {
        path: "M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z",
        fillColor: "#FF5252",
        fillOpacity: 0.9,
        strokeColor: "#ffffff",
        strokeWeight: 3,
        scale: 2.8,
        anchor: new google.maps.Point(12, 24)
    },
    label: {
        text: '●',
        color: "#FF5252",
        fontSize: "32px",
        className: "pulsating-marker"
    },
    zIndex: 999,
    optimized: false
});

            
                 // ضبط حدود الخريطة لتشمل الأصل والنهاية
      const bounds = new google.maps.LatLngBounds();
      bounds.extend(originLatLng);
      bounds.extend(endLocation);
// 1. استخدام maxZoom مباشرة:
map.fitBounds(bounds, {
  padding: 100,
  maxZoom: 100   // حدد أقصى مستوى زوم تريده
});

// 2. أو استخدام setTimeout لضمان أن fitBounds انتهت:
map.fitBounds(bounds, { padding: 100 });
setTimeout(() => {
  // اجعل الزوم يصل إلى القيمة التي تريدها
  map.setZoom(100);
}, 500);
      
        } catch (error) {
            console.error('خطأ في تحديث المسار:', error);
        }
    });
}

        function showDriverRealTimeLocation(driverId) {
    // إزالة أي مستمع سابق
            if (driverLocationListener) {
                 database.ref(`drives/${driverId}/location`).off('value', driverLocationListener);
            }

            const carIcon = {
                  url: "https://cdn-icons-png.flaticon.com/512/744/744515.png",
                  scaledSize: new google.maps.Size(40, 40),
                  anchor: new google.maps.Point(20, 20)
            };

            driverLocationListener = database.ref(`drives/${driverId}/location`).on('value', (snapshot) => {
               const driverLocation = snapshot.val();
            if (!driverLocation) return;

            const driverPos = new google.maps.LatLng(
                driverLocation.latitude,
                driverLocation.longitude
            );

            if (!driverMarker) {
               driverMarker = new google.maps.Marker({
                  position: driverPos,
                  map: map,
                  icon: carIcon,
                  title: 'الموقع الحالي للسائق',
                  animation: google.maps.Animation.BOUNCE
                });
            } else {
               driverMarker.setPosition(driverPos);
            }

             map.panTo(driverPos);
             map.setZoom(17);
            });
        }

    async function trackDriverLocation(driverId, startLocation) {
	    if (!isTripActive) return; // التوقف إذا الرحلة غير نشطة
  console.log("[Checkpoint 6] تتبع موقع السائق - معرف السائق:", driverId);
const carIcon = {
  url: "https://maps.gstatic.com/mapfiles/kml/shapes/cabs.png",  // أيقونة السيارة من Google
  scaledSize: new google.maps.Size(40, 40),                       // اضبط الحجم بما يناسبك
  anchor:    new google.maps.Point(24, 24)                        // تثبيت منتصف الأيقونة
};

  // تحقق من صحة الإحداثيات
  if (!startLocation || isNaN(startLocation.lat) || isNaN(startLocation.lng)) {
    console.error("[Error] إحداثيات البداية غير صالحة:", startLocation);
    return;
  }
  
  const startPos = new google.maps.LatLng(startLocation.lat, startLocation.lng);
  console.log("[Checkpoint 7] موقع البداية (العميل):", startPos.toString());
  
  const driverRef = database.ref(`drives/${driverId}/location`);
  console.log("[Checkpoint 8] الاشتراك في تحديثات موقع السائق");
  
  driverRef.on('value', async (snapshot) => {
    const driverLocation = snapshot.val();
    if (!driverLocation) {
      console.warn("[Warning] موقع السائق غير متوفر حاليًا");
      return;
    }
    
    console.log("[Checkpoint 9] بيانات الموقع الواردة من السائق:", driverLocation);
    
    // تحقق من صحة بيانات الموقع
    if (!driverLocation.lat || !driverLocation.lng) {
      console.error("[Error] إحداثيات السائق غير صالحة");
      return;
    }
    
    const driverPos = new google.maps.LatLng(
      Number(driverLocation.lat),
      Number(driverLocation.lng)
    );
            // إنشاء/تحديث علامة السائق
        if (!driverMarker) {
            driverMarker = new google.maps.Marker({
                position: driverPos,
                map: map, // التأكيد على إرفاق العلامة بالخريطة
                icon: carIcon,
                title: 'الموقع الحالي للسائق',
                animation: google.maps.Animation.BOUNCE,
                zIndex: 9999
            });
            console.log('[تتبع السائق] تم إنشاء علامة السائق الجديدة');
        } else {
            driverMarker.setPosition(driverPos);
        }
    console.log("[Checkpoint 10] الموقع الحالي للسائق:", driverPos.toString());
          // تحديث مركز الخريطة ليشمل موقع السائق ونقطة البداية
        const bounds = new google.maps.LatLngBounds();
        bounds.extend(driverPos);
        bounds.extend(new google.maps.LatLng(startLocation.lat, startLocation.lng));
        map.fitBounds(bounds, {padding: 100});

        // حساب المسافة بين السائق ونقطة البداية
        const distance = google.maps.geometry.spherical.computeDistanceBetween(
            driverPos,
            new google.maps.LatLng(startLocation.lat, startLocation.lng)
        );
		       // تحديث واجهة المستخدم بالمسافة
        document.getElementById('distanceInfo').innerHTML = `
            المسافة المتبقية: ${(distance / 1000).toFixed(1)} كم
        `;
    // حساب المسار
    try {
      const request = {
        origin: driverPos,
        destination: startPos,
        travelMode: 'DRIVING'
      };
      
      console.log("[Checkpoint 11] إرسال طلب حساب المسار:", request);
      
      const response = await directionsService.route(request);
      console.log("[Checkpoint 12] استجابة Directions API:", response);
      
      // عرض المسار على الخريطة
      if (driverDirectionsRenderer) {
        driverDirectionsRenderer.setMap(null);
      }
      
      driverDirectionsRenderer = new google.maps.DirectionsRenderer({
    suppressMarkers: true,
    polylineOptions: {
        strokeColor: "#FFA500",
        strokeOpacity: 0.8,
        strokeWeight: 6,
        strokeDashArray: [10, 5],
        icons: [{
            icon: {
                path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                scale: 3,
                strokeColor: "#FF4500",
                fillColor: "#FF8C00",
                fillOpacity: 1
            },
            offset: "100%",
            repeat: "50px"
        }]
    }
});
      
      driverDirectionsRenderer.setMap(map);
      driverDirectionsRenderer.setDirections(response);
      
    } catch (error) {
      console.error("[Error] فشل في حساب المسار:", error);
      console.error("التفاصيل:", {
        origin: driverPos.toJSON(),
        destination: startPos.toJSON(),
        error: error.message
      });
    }
  });

}
        function updateDriverRoute(currentPos, startPos) {
              if (!isTripActive) return; // إيقاف أي تحديث إذا الرحلة غير نشطة

			if (driverRoutePolyline) {
                driverRoutePolyline.setMap(null);
            }

            driverRoutePolyline = new google.maps.Polyline({
                path: [currentPos, startPos],
                geodesic: true,
                strokeColor: "#FF00FF",
                strokeOpacity: 0.8,
                strokeWeight: 7,
                map: map
            });
        }
		function showArrivalNotification(driverId) {
            const notification = document.getElementById('arrivalNotification');
            const sound = document.getElementById('notificationSound');
    
    // تحديث بيانات السائق
            database.ref(`drives/${driverId}`).once('value').then((snapshot) => {
                const driverData = snapshot.val();
                document.getElementById('driverArrivalInfo').innerHTML = `
                     <p>الاسم: ${driverData.fullName}</p>
                     <p>الهاتف: <a href="tel:${driverData.phoneNumber}">${driverData.phoneNumber}</a></p>
                     <p>السيارة: ${driverData.carNumber}</p>
                     `;
                });

    // إدارة الصوت
            sound.loop = true;
            sound.play().catch(() => {
            notification.innerHTML += '<p style="color:red;">يُرجى السماح بتشغيل الصوت</p>';
            });

            notification.style.display = 'block';
        }    
        function handleArrivalConfirmation() {
            const notification = document.getElementById('arrivalNotification');
            const sound = document.getElementById('notificationSound');
    
    // إيقاف الصوت
            sound.pause();
            sound.currentTime = 0;
    
    // إخفاء الإشعار فقط دون مسح البيانات
            notification.style.display = 'none';
    
    // إبقاء علامة السائق ظاهرة
            if (driverMarker) {
             driverMarker.setAnimation(null); // إيقاف تأثير الارتداد
            }
        }
    	function clearDriverTracking() {
    // إزالة تتبع السائق
            if (driverLocationListener) {
                 database.ref(`drives/${tripData.driverId}/location`).off('value', driverLocationListener);
                driverLocationListener = null;
           
			}

    // إزالة العلامات والمسارات
            if (driverMarker) driverMarker.setMap(null);
            if (driverDirectionsRenderer) driverDirectionsRenderer.setMap(null);
            driverDirectionsRenderer = null;

    // إعادة تعيين العناصر
            document.getElementById('persistentNotification').style.display = 'none';
        }
		function showActualRoute(startLoc, endLoc) {
    // تنظيف العناصر السابقة
            if(directionsRenderer) directionsRenderer.setMap(null);
            if(startMarker) startMarker.setMap(null);
            if(endMarker) endMarker.setMap(null);

    // إعداد خصائص المسار
              directionsRenderer = new google.maps.DirectionsRenderer({
             suppressMarkers: false,
               polylineOptions: {
               strokeColor: "#0000FF",
              strokeOpacity: 0.8,
              strokeWeight: 6,
               zIndex: 1000
            },
              markerOptions: {
              opacity: 0.8 // شفافية العلامات
    }
            });

    // إنشاء علامات مخصصة
            startMarker = new google.maps.Marker({
               position: startLoc,
               map: map,
               icon: {
                  path: google.maps.SymbolPath.CIRCLE,
                  scale: 8,
                 fillColor: "#00CED1",
                fillOpacity: 1,
                 strokeColor: "#FFF",
                strokeWeight: 2
                },
              zIndex: 1001
            });

            endMarker = new google.maps.Marker({
                position: endLoc,
               map: map,
             icon: {
              path: google.maps.SymbolPath.CIRCLE,
               scale: 8,
               fillColor: "#FF6B6B",
               fillOpacity: 1,
               strokeColor: "#FFF",
               strokeWeight: 2
              },
              zIndex: 1001
            });

    // طلب تفاصيل المسار
             const request = {
                  origin: startLoc,
               destination: endLoc,
                travelMode: 'DRIVING',
                 provideRouteAlternatives: false,
                optimizeWaypoints: true
            };

           directionsService.route(request, (response, status) => {
                 if (status === 'OK') {
            // عرض المسار
                 directionsRenderer.setMap(map);
                 directionsRenderer.setDirections(response);

            // إعداد حدود الخريطة
               const bounds = new google.maps.LatLngBounds();
                 bounds.extend(startLoc);
                 bounds.extend(endLoc);
                 map.fitBounds(bounds);

            // عرض معلومات المسار
                const route = response.routes[0].legs[0];
                document.getElementById('routeInfo').style.display = 'block';
                document.getElementById('routeInfo').innerHTML = `
                <h3>تفاصيل الرحلة:</h3>
                <p>المسافة: ${route.distance.text}</p>
                <p>الوقت المتوقع: ${route.duration.text}</p>
                <div class="progress-bar" style="margin-top:15px;">
                    <div class="progress" style="height: 8px; background: #333; border-radius:4px;">
                        <div class="progress-fill" style="width: 100%; height:100%; background: var(--primary-color); border-radius:4px;"></div>
                    </div>
                </div>
               `;

            // إضافة خط متحرك للمسار
               const path = response.routes[0].overview_path;
               animateRoute(path);
            } else {
                   console.error('فشل في عرض المسار:', status);
            }
            });
        }
		function animateRoute(path) {
            let count = 0;
           const line = new google.maps.Polyline({
           path: [],
           geodesic: true,
           strokeColor: "#00CED1",
           strokeOpacity: 0.8,
           strokeWeight: 6
           });

         const animate = () => {
            if (count >= path.length) {
            line.setMap(null);
            return;
          }

          line.getPath().push(path[count]);
          line.setMap(map);
          count++;
          setTimeout(animate, 50);
          };

            animate(); 
        }
        function showEndNotification(price) {
    // إنشاء العنصر إذا لم يكن موجود
	    cleanRouteMemory();
		    if (driverMarker) driverMarker.setMap(null);
    if (directionsRenderer) directionsRenderer.setMap(null);
		showEndNotification
    if(directionsRenderer) directionsRenderer.setMap(null);

           let endNotification = document.getElementById('endNotification');
    
            if (!endNotification) {
            endNotification = document.createElement('div');
            endNotification.id = 'endNotification';
            endNotification.className = 'end-notification';
            document.body.appendChild(endNotification);
            }

    // تعبئة المحتوى
           endNotification.innerHTML = `
               <h2>تم الوصول إلى نقطة النهاية</h2>
               <div class="price">إجمالي سعر الرحلة: ${price} جنيه</div>
               <button class="btn" onclick="handlePaymentDone()" 
                    style="margin-top:20px; padding:12px 30px;">
                    تم الدفع وإعادة التشغيل
                </button>
            `;
    // التأكد من إزالة العلامات
    if (driverMarker) driverMarker.setMap(null);
    if (endMarker) endMarker.setMap(null);
    if (startMarker) startMarker.setMap(null);
    // تشغيل الصوت
             const sound = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
             sound.play().catch(() => {
             console.log('يُرجى السماح بتشغيل الصوت');
            });

 
        }
		function handlePaymentDone() {
    // 1. إخفاء رسالة النهاية
            const endNotification = document.getElementById('endNotification');
           if (endNotification) endNotification.remove();
    
    // 2. إعادة عرض كل العناصر
           document.getElementById('map').style.display = 'block';
           document.querySelector('.control-panel').style.display = 'flex';
           document.querySelector('.action-buttons').style.display = 'flex';
           document.getElementById('routeInfo').style.display = 'block';
    
    // 3. تنظيف الخريطة وإعادة التعيين
            clearAll();
    
    // 4. إعادة تحميل الخريطة إذا لزم الأمر (اختياري)
           // initMap();
        }

// إضافة دالة جديدة لاستعادة المسار
async function restoreRoute(startLoc, endLoc) {
    const request = {
        origin: startLoc,
        destination: endLoc,
        travelMode: 'DRIVING'
    };
    
    try {
	
        const response = await directionsService.route(request);
                // إعادة تعيين العلامات
        startMarker.setPosition(startLoc);
        startMarker.setMap(map);
        endMarker.setPosition(endLoc);
        endMarker.setMap(map)
		directionsRenderer.setMap(map);
        directionsRenderer.setDirections(response);
        
        // تحديث العلامات
        startMarker.setPosition(startLoc);
        endMarker.setPosition(endLoc);
        
        // تحديث حدود الخريطة
        const bounds = new google.maps.LatLngBounds();
        bounds.extend(startLoc);
        bounds.extend(endLoc);
        map.fitBounds(bounds, {padding: 50});
        
    } catch (error) {
        console.error('فشل في استعادة المسار:', error);
    }
}
        async function restorePreviousTrip() {
           if (!currentTripId) return;
             
            showLoading(true);
            try {
    	     const userId = localStorage.getItem('userId');
             const tripRef = database.ref(`rides/${userId}/${currentTripId}`);
             const snapshot = await tripRef.once('value');
    
           if (!snapshot.exists()) {
                localStorage.removeItem('currentTripId');
             return;
            }
    
            const tripData = snapshot.val();
			    // استعادة المسار إذا كانت الحالة new
        if (tripData.status === "new") {
		
            await restoreRoute(tripData.startLocation, tripData.endLocation);
            document.getElementById('priceOptions').style.display = 'flex';
            totalDistance = tripData.distance;
			            document.getElementById('priceOptions').style.display = 'none';
            document.querySelectorAll('.input-field').forEach(field => {
                field.style.display = 'none';
            });
        }
              await restoreTripState();

            } catch (error) {
                console.error('Error restoring trip:', error);
            } finally {
                showLoading(false);
            }
        }

       function handleStatusChange(status, tripData) {
           switch(status) {
          case 'new':
            showSearchingUI();
            break;
        case 'accepted':
            showAcceptedUI(tripData.driverId);
            break;
        case 'in_progress':
            showInProgressUI(tripData);
            break;
        case 'completed':
            showCompletedUI(tripData);
            break;
        case 'canceled':
            showCanceledUI();
            break;
        default:
            console.log('Unknown status:', status);
           }
        }

        function setupNewTripUI(tripData) {
             const userId = localStorage.getItem('userId');
             const tripRef = database.ref(`rides/${userId}/${currentTripId}`);
    
           tripListener = tripRef.on('value', (snapshot) => {
                const tripData = snapshot.val();
               if (!tripData) {
                clearAll();
                return;
            }
        
                 handleStatusChange(tripData.status, tripData);
            });
        }

        function showSearchingUI() {
		    document.getElementById('map').classList.add('full-screen-map');

		     document.querySelector('.action-buttons').style.display = 'none';
      			  document.getElementById('map').style.display = 'block'; // إضافة هذا السطر
       			  document.querySelector('.input-field').style.display = 'none';
                  document.getElementById('origin').parentNode.style.display = 'none';
                   document.getElementById('destination').parentNode.style.display = 'none';
          document.getElementById('persistentNotification').style.display = 'block';
          document.getElementById('tripStatusContent').innerHTML = `
           <h3>جاري البحث عن سائق...</h3>
            <div class="loading-spinner"></div>
          `;
        }

        async function showAcceptedUI(driverId) {
        document.getElementById('map').classList.add('full-screen-map');

            const driverSnapshot = await database.ref(`drives/${driverId}`).once('value');
           const driverData = driverSnapshot.val();
        document.getElementById('map').classList.add('full-screen-map');

         document.getElementById('persistentNotification').style.display = 'block';
         document.getElementById('tripStatusContent').innerHTML = `
           <h3>تم قبول طلبك</h3>
            <p>اسم السائق: ${driverData.fullName}</p>
              <p>موديل السيارة: ${driverData.carModel}</p>
           <p>رقم الهاتف: ${driverData.phoneNumber}</p>
           <div id="driverLiveLocation"></div>
          `;
    
           startTrackingDriver(driverId);
        }

        function showInProgressUI(tripData) {
		    document.getElementById('map').classList.add('full-screen-map');

            document.getElementById('persistentNotification').style.display = 'block';
           document.getElementById('tripStatusContent').innerHTML = `
            <h3>الرحلة قيد التقدم</h3>
            <p>المسافة المقطوعة: <span id="distanceTraveled">0</span> كم</p>
            <p>الوقت المتبقي: <span id="eta">--</span></p>
           `;
    
            updateTripProgress(tripData);
        }
		function showCanceledUI() {
            document.getElementById('persistentNotification').style.display = 'block';
           document.getElementById('tripStatusContent').innerHTML = `
            <h3 style="color: #ff4444;">تم إلغاء الرحلة</h3>
            <button class="btn" onclick="clearAll()">العودة للشاشة الرئيسية</button>
          `;
		  
        }

// إضافة مستمع لإغلاق الصفحة
        window.addEventListener('beforeunload', async (e) => {
            if (currentTripId) {
            const tripRef = database.ref(`rides/${userId}/${currentTripId}`);
            await tripRef.update({ lastActive: firebase.database.ServerValue.TIMESTAMP });
            }
        });
		function cancelRestore() {
           localStorage.removeItem('currentTripId');
            location.reload();
        }

        async function setupAcceptedTripUI(tripData) {
  // إخفاء عناصر التحكم
          document.querySelector('.control-panel').style.display = 'none';
          document.querySelector('.action-buttons').style.display = 'none';
  
  // عرض معلومات السائق
          const driverInfo = await getDriverInfo(tripData.driverId);
          document.getElementById('persistentNotification').style.display = 'block';
          document.getElementById('tripStatusContent').innerHTML = `
          <p>الحالة: في الطريق إليك</p>
          <p>السائق: ${driverInfo.name}</p>
          <p>المسافة المتبقية: <span id="liveDistance">جاري التحديث...</span></p>
           `;
  
  // بدء تتبع الموقع الحي
           startRealTimeTracking(tripData.driverId);
        }
		async function calculateRouteWithRetry(retries = 3) {
           try {
              let origin = document.getElementById('origin').value;
              const destination = document.getElementById('destination').value;

               const request = {
                 origin: currentLocationCoords || origin,
                 destination: destination,
                 travelMode: 'DRIVING'
                };
 
                const response = await directionsService.route(request);
            if (response.routes.length === 0) throw new Error('No routes found');
        
        // ... معالجة النتيجة بنجاح ...
        
            } catch (error) {
                if (retries > 0) {
                console.log(`إعادة المحاولة... ${retries} محاولات متبقية`);
                await new Promise(resolve => setTimeout(resolve, 1000));
                return calculateRouteWithRetry(retries - 1);
                 }
                 showNotification('فشل في حساب المسار: ' + error.message, true);
            }
        }
        function selectPayment(method, event) {
		    if (!event) return; // تأكد من وجود الحدث

            selectedPayment = method;
    
            document.querySelectorAll('.payment-option').forEach(option => {
            option.classList.remove('selected');
           });
    
          event.currentTarget.classList.add('selected');
          document.getElementById('confirmBookingButton').style.display = 'block';
        event.currentTarget.classList.add('selected');

    // إضافة تأثير مرئي
          event.currentTarget.style.transform = 'scale(1.02)';
           
            event.currentTarget.style.transform = 'scale(1)';
           
        }
		async function moveTripToEnd(userId, tripId) {
              try {
            const rideRef = database.ref(`rides/${userId}/${tripId}`);
            const endRef = database.ref(`end/${userId}/${tripId}`);

        // نقل البيانات مع الاحتفاظ بالتاريخ
            const snapshot = await rideRef.once('value'); 
            const tripData = snapshot.val();
             tripData.endTimestamp = firebase.database.ServerValue.TIMESTAMP;

             await endRef.set(tripData);
             await rideRef.remove();
            } catch (error) {
            console.error('Error moving trip:', error);
           showNotification('حدث خطأ في حفظ الرحلة', true);
            }
        }

        function handlePaymentDone() {
		    clearAll();
          const userId = localStorage.getItem('userId');
          const tripId = localStorage.getItem('currentTripId');

          if (!userId || !tripId) {
             showNotification('لا توجد رحلة نشطة', true);
              return;
           }

    // نقل الرحلة إلى قسم الرحلات المنتهية
           moveTripToEnd(userId, tripId);

    // إعادة التعيين
           const endNotification = document.getElementById('endNotification');
           if (endNotification) endNotification.remove();

           document.getElementById('map').style.display = 'block';
           document.querySelector('.control-panel').style.display = 'flex';
           document.querySelector('.action-buttons').style.display = 'flex';
           document.getElementById('routeInfo').style.display = 'block';

            clearAll();
           showNotification('تم حفظ الرحلة بنجاح');
        }
		async function restoreTripState() {
            const userId = localStorage.getItem('userId');
             const tripRef = database.ref(`rides/${userId}/${currentTripId}`);
            const snapshot = await tripRef.once('value');
            if (snapshot.exists()) {
            const tripData = snapshot.val();
            handleStatusChange(tripData.status, tripData);
            }
        }
		let liveLocationWatcher = null;
        function startLiveLocationTracking(endLocation) {
            if (liveLocationWatcher) {
            navigator.geolocation.clearWatch(liveLocationWatcher);
            }

             liveLocationWatcher = navigator.geolocation.watchPosition(
            position => {
               const currentPos = {
                  lat: position.coords.latitude,
                  lng: position.coords.longitude
                };
            
                 updateLiveRoute(currentPos, endLocation);
            },
            error => {
               console.error('Error getting live location:', error);
            },
            {
              enableHighAccuracy: true,
              maximumAge: 30000,
              timeout: 2700
            }

            );
        }

// دالة لتحديث المسار الحي
        function updateLiveRoute(startPos, endPos) {
           directionsRenderer.setMap(null);
    
          const request = {
           origin: startPos,
          destination: endPos,
          travelMode: 'DRIVING',
          provideRouteAlternatives: false
          };

           directionsService.route(request, (response, status) => {
            if (status === 'OK') {
              directionsRenderer.setOptions({
                polylineOptions: {
                    strokeColor: "#00FF00",
                    strokeOpacity: 0.8,
                    strokeWeight: 6
                 }
                });
              directionsRenderer.setMap(map);
              directionsRenderer.setDirections(response);
            
            // تحديث العلامات
              startMarker.setPosition(startPos);
              startMarker.setMap(map);
              endMarker.setPosition(endPos);
              endMarker.setMap(map);
            
              map.fitBounds(response.routes[0].bounds);
              }
            });
        }
		// دالة لتنظيف العناصر الشبحية من الخريطة
function cleanGhostMapElements() {
    // البحث عن جميع الصور غير المرغوب فيها
    const ghostImages = document.querySelectorAll('img[src="https://maps.gstatic.com/mapfiles/transparent.png"]');
    
    // حذف كل الصور المطابقة
    ghostImages.forEach(img => {
        img.parentNode.removeChild(img);
    });

    // تنظيف العناصر الإضافية
    
}
		function openGoogleMapsNavigation(start, end) {
           const baseUrl = "https://www.google.com/maps/dir/?api=1";
            const params = new URLSearchParams({
            origin: `${start.lat},${start.lng}`,
            destination: `${end.lat},${end.lng}`,
            travelmode: "driving"
           });
            window.open(`${baseUrl}&${params.toString()}`, '_blank');
        }
		function cleanRouteMemory() {
    if(window.directionsService) {
        directionsService = null;
    }
    
    if(window.driverDirectionsRenderer) {
        driverDirectionsRenderer.setMap(null);
        driverDirectionsRenderer = null;
    }
    
    google.maps.event.clearInstanceListeners(map);
}

        function clearAll() {
		  // الحصول على القيم من localStorage أولاً
  const userId = localStorage.getItem('userId');
  const currentTripId = localStorage.getItem('currentTripId');
		    cleanRouteMemory();
    // إيقاف جميع المستمعين
    if (tripListener) {
        database.ref(`rides/${userId}/${currentTripId}`).off('value', tripListener);
    }
    if (driverLocationListener) {
        database.ref(`drives/${driverId}/location`).off('value', driverLocationListener);
    }

    // مسح العناصر من الخريطة
    [directionsRenderer, driverDirectionsRenderer, driverRoutePolyline].forEach(item => {
        if (item) item.setMap(null);
    });

    [startMarker, endMarker, driverMarker].forEach(marker => {
        if (marker) marker.setMap(null);
    });

		  // إزالة مسار السائق
	
    if(driverDirectionsRenderer) {
        driverDirectionsRenderer.setMap(null);
        driverDirectionsRenderer = null;
    }
    
    // إزالة الخطوط المرسومة
    if(driverRoutePolyline) {
        driverRoutePolyline.setMap(null);
        driverRoutePolyline = null;
    }
    
    // إعادة تعيين عارض الاتجاهات
    if(directionsRenderer) {
        directionsRenderer.setMap(null);
        directionsRenderer = null;
    }
        const mapElement = document.getElementById('map');
		 document.querySelector('.profile-btn').style.display = 'block';
    const tripId = localStorage.getItem('currentTripId');
    
    // حذف الرحلة من قاعدة البيانات إذا كانت موجودة
    if (userId && tripId) {
        const tripRef = database.ref(`rides/${userId}/${tripId}`);
        tripRef.remove()
            .then(() => {
                console.log('Trip deleted successfully');
                showNotification('تم إلغاء الرحلة بنجاح');
            })
            .catch((error) => {
                console.error('Error deleting trip:', error);
                showNotification('فشل في إلغاء الرحلة', true);
            });
    }
    // إعادة إعدادات الخريطة الأصلية
    mapElement.classList.remove('full-screen-map');
    mapElement.style.height = originalMapState.height;
    mapElement.style.width = originalMapState.width;
    mapElement.style.margin = originalMapState.margin;
    mapElement.style.borderRadius = originalMapState.borderRadius;
    mapElement.style.position = originalMapState.position;
    mapElement.style.top = originalMapState.top;
    mapElement.style.left = originalMapState.left;
    
    // إعادة العناصر المرئية
    document.getElementById('priceButton').style.display = 'block';
    document.querySelectorAll('.input-field').forEach(field => {
        field.style.display = 'block';
    });
    
    // إعادة تعيين الخريطة
    if (map) {
        map.setCenter(new google.maps.LatLng(30.0444, 31.2357));
        map.setZoom(15);
    }
    // إزالة علامة السائق إذا كانت موجودة
    if (driverMarker) {
        driverMarker.setMap(null);
        driverMarker = null;
    }
	    cleanGhostMapElements();
        driverMarker = null;
    driverDirectionsRenderer = null;
    // مسح أي مسارات متبقية
    if (driverRoutePolyline) {
        driverRoutePolyline.setMap(null);
        driverRoutePolyline = null;
    }
    // إزالة جميع العناصر من الخريطة
	    // إعادة تعيين عناصر الواجهة
             document.querySelector('.control-panel').style.display = 'flex';
             document.querySelector('.action-buttons').style.display = 'flex';
             document.getElementById('routeInfo').style.display = 'block';
             if (driverDirectionsRenderer) driverDirectionsRenderer.setMap(null);
             if (directionsRenderer) directionsRenderer.setMap(null);
             if (startMarker) startMarker.setMap(null);
             if (endMarker) endMarker.setMap(null);
             if (currentLocationMarker) currentLocationMarker.setMap(null);
             if (driverRoutePolyline) driverRoutePolyline.setMap(null);
             if (driverMarker) driverMarker.setMap(null);
             if (destinationMarker) destinationMarker.setMap(null);
               if(directionsRenderer) directionsRenderer.setMap(null);
			 driverMarker = null;
             destinationMarker = null;
    // إخفاء العناصر الواجهة
             document.getElementById('persistentNotification').style.display = 'none';
             document.getElementById('routeInfo').innerHTML = '';
             document.getElementById('priceOptions').style.display = 'none';
             document.getElementById('bookingDetails').style.display = 'none';
             localStorage.removeItem('currentTripId');
    // إعادة عرض عناصر الإدخال
               document.querySelectorAll('.input-field').forEach(field => {
                  field.style.display = 'block'; // إعادة العرض
                })
				    document.getElementById('origin').parentNode.style.display = 'block';
                    document.getElementById('destination').parentNode.style.display = 'block';
    // إعادة تعيين القيم
	    // إعادة تعيين مواقع العلامات الأصلية
    startMarker.setPosition(null);
    endMarker.setPosition(null);
             selectedVehicle = null;
             currentLocationCoords = null;
        if (driverDirectionsRenderer) {
        driverDirectionsRenderer.setMap(null);
        driverDirectionsRenderer = null;
    }
    // إزالة بيانات الحقول
             document.getElementById('origin').value = '';
             document.getElementById('destination').value = '';
    
     // إلغاء الاشتراكات
            if (tripListener) database.ref(`rides/${currentTripId}`).off('value', tripListener);
            if (driverLocationListener) database.ref(`drives/${driverId}/location`).off('value', driverLocationListener);
            const notification = document.getElementById('arrivalNotification');
            if (notification) {
               notification.style.display = 'none';
               notification.classList.remove('success');
            }
		       localStorage.removeItem('currentTripId');

        // إزالة الرسالة النهائية إذا كانت ظاهرة
            const endNotification = document.getElementById('endNotification');
            if (endNotification) {
                endNotification.remove();
            }
		    if(map) {
             map.setZoom(15);
            map.setCenter({ lat: 30.0444, lng: 31.2357 });
            }
    // إيقاف أي أصوات
            const sound = document.getElementById('notificationSound');
            if (sound) {
                sound.pause();
                sound.currentTime = 0;
            }
    	    if (liveLocationWatcher) {
           navigator.geolocation.clearWatch(liveLocationWatcher);
          liveLocationWatcher = null;
           }
          location.reload();
	
	}

        function getVehicleName(type) {
            const vehicles = {
                normal: 'سيارة عادية',
                luxury: 'سيارة فاخرة',
                helicopter: 'طائرة'
            };
            return vehicles[type] || '';
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
        }

        function showNotification(message, isError = false) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.background = isError ? '#ff4444' : '#00CED1';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.remove(), 5000);
        }
		function adjustMarkersPosition(startPos, endPos) {
    const bounds = new google.maps.LatLngBounds();
    bounds.extend(startPos);
    bounds.extend(endPos);
    
    const ne = bounds.getNorthEast();
    const sw = bounds.getSouthWest();
    
    const padding = 0.0002; // تعديل الموقع بمقدار 20 متر تقريبًا
    
    startMarker.setPosition(new google.maps.LatLng(
        startPos.lat() + padding,
        startPos.lng() - padding
    ));
    
    endMarker.setPosition(new google.maps.LatLng(
        endPos.lat() - padding,
        endPos.lng() + padding
    ));
}
// متغير لحفظ المربعات علشان نقدر نمسحهم بعدين
let tripAreas = [];
const hexGridSize = 0.006; // تباعد المراكز (حسب نصف القطر المطلوب)
const hexRadius = 0.0029; // نصف القطر المناسب للتباعد

let tripHexagons = [];
const densityColors = {
    low: '#FFD580',    // 1-3 رحلات
    medium: '#FFA500',  // 4-6 رحلات
    high: '#FF4500'     // 7+ رحلات
};

async function drawTripHotspots() {
    tripHexagons.forEach(hex => hex.setMap(null));
    tripHexagons = [];
    
    const ridesRef = database.ref('rides');
    const snapshot = await ridesRef.once('value');
    const areas = new Map();

    // حساب الإحداثيات على الشبكة السداسية
    const getGridKey = (lat, lng) => {
        const gridLat = Math.round(lat / hexGridSize) * hexGridSize;
        const gridLng = Math.round(lng / hexGridSize) * hexGridSize;
        return `${gridLat},${gridLng}`;
    };

    snapshot.forEach(userSnapshot => {
        userSnapshot.forEach(tripSnapshot => {
            const trip = tripSnapshot.val();
            if (trip.startLocation) {
                const key = getGridKey(
                    trip.startLocation.lat,
                    trip.startLocation.lng
                );
                areas.set(key, (areas.get(key) || 0) + 1);
            }
        });
    });

    // رسم الأشكال مع ضمان عدم التداخل
    areas.forEach((count, key) => {
        const [lat, lng] = key.split(',');
        const hexagon = createHexagon(
            parseFloat(lat),
            parseFloat(lng),
            hexRadius, // استخدام نصف القطر المعدل
            getDensityColor(count),
            count
        );
        tripHexagons.push(hexagon);
    });
}

function getDensityColor(count) {
    if (count <= 3) return densityColors.low;
    if (count <= 6) return densityColors.medium;
    return densityColors.high;
}
function createHexagon(lat, lng, radius, color, tripCount) {
    const center = { lat, lng };
    const coordinates = [];
    
    for (let i = 0; i < 6; i++) {
        const angle = (i * 60) * (Math.PI / 180);
        const dx = radius * Math.cos(angle);
        const dy = radius * Math.sin(angle);
        coordinates.push({ lat: lat + dy, lng: lng + dx });
    }
    coordinates.push(coordinates[0]);

    const hexagon = new google.maps.Polygon({
        paths: coordinates,
        strokeColor: color,
        strokeOpacity: 0.8,
        strokeWeight: 1,
        fillColor: color,
        fillOpacity: 0.3 + (tripCount * 0.05), // زيادة الشفافية مع الكثافة
        map: map,
        zIndex: 1,
        clickable: false

    });

    // إضافة تفاعلية عند الhover
    hexagon.addListener('mouseover', () => {
        hexagon.setOptions({ 
            strokeWeight: 3,
            fillOpacity: 0.5 
        });
        new google.maps.InfoWindow({
            content: `عدد الرحلات: ${tripCount}`
        }).open(map, hexagon);
    });

    hexagon.addListener('mouseout', () => {
        hexagon.setOptions({ 
            strokeWeight: 1,
            fillOpacity: 0.3 + (tripCount * 0.05)
        });
    });

    return hexagon;
}
// إضافة مستمع للتحديثات الفورية
database.ref('rides').on('value', () => {
    drawTripHotspots();
});
    </script>
</body>
</html>
